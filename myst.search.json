{"version":"1","records":[{"hierarchy":{"lvl1":"World of energy"},"type":"lvl1","url":"/","position":0},{"hierarchy":{"lvl1":"World of energy"},"content":"List of planned topics:\n\nelectricity markets / prices\n\nweather as driver of residual load\n\nweather forecasting\n\ngrid congestion\n\nbattery storage\n\nbattery optimization","type":"content","url":"/","position":1},{"hierarchy":{"lvl1":"Resources"},"type":"lvl1","url":"/markdown/resources","position":0},{"hierarchy":{"lvl1":"Resources"},"content":"Capture prices as published by \n\nNetztransparenz:","type":"content","url":"/markdown/resources","position":1},{"hierarchy":{"lvl1":"Resources","lvl2":"Prices"},"type":"lvl2","url":"/markdown/resources#prices","position":2},{"hierarchy":{"lvl1":"Resources","lvl2":"Prices"},"content":"From \n\ndestatis\n\nFrom \n\nsmard:\n\nFrom \n\ntrading economics:\n\nFrom \n\nEMBER:\n\nRegarding SRMC:\n\nhttps://​support​.montel​.energy​/how​-are​-short​-run​-marginal​-costs​-srmc​-calculated​-in​-montel​-online\n\nhttps://​ember​-energy​.org​/data​/european​-electricity​-prices​-and​-costs​/​#methodology\n\nSMARD API:\n\nhttps://​smard​.api​.bund​.dev/","type":"content","url":"/markdown/resources#prices","position":3},{"hierarchy":{"lvl1":"Resources","lvl2":"Weather"},"type":"lvl2","url":"/markdown/resources#weather","position":4},{"hierarchy":{"lvl1":"Resources","lvl2":"Weather"},"content":"","type":"content","url":"/markdown/resources#weather","position":5},{"hierarchy":{"lvl1":"Resources","lvl2":"Data"},"type":"lvl2","url":"/markdown/resources#data","position":6},{"hierarchy":{"lvl1":"Resources","lvl2":"Data"},"content":"Investing.com:\n\nCarbon Emissions Futures Prices: \n\nhttps://​www​.investing​.com​/commodities​/carbon​-emissions​-historical​-data\n\nRotterdam Coal Futures Prices: \n\nhttps://​www​.investing​.com​/commodities​/rotterdam​-coal​-futures​-historical​-data","type":"content","url":"/markdown/resources#data","position":7},{"hierarchy":{"lvl1":"Electricity prices in Germany"},"type":"lvl1","url":"/notebooks/smard-de-prices","position":0},{"hierarchy":{"lvl1":"Electricity prices in Germany"},"content":"This notebook loads and visualizes day-ahead electricity prices for the\nGerman-Luxembourg market area from SMARD data.","type":"content","url":"/notebooks/smard-de-prices","position":1},{"hierarchy":{"lvl1":"Electricity prices in Germany","lvl2":"Background"},"type":"lvl2","url":"/notebooks/smard-de-prices#background","position":2},{"hierarchy":{"lvl1":"Electricity prices in Germany","lvl2":"Background"},"content":"The SMARD platform (operated by the German Federal Network Agency,\nBundesnetzagentur) is the primary hub for high-resolution electricity market\ndata in Germany. It serves as a transparent “scoreboard” for the energy\ntransition.","type":"content","url":"/notebooks/smard-de-prices#background","position":3},{"hierarchy":{"lvl1":"Electricity prices in Germany","lvl3":"What are SMARD Electricity Prices (DE/LU)?","lvl2":"Background"},"type":"lvl3","url":"/notebooks/smard-de-prices#what-are-smard-electricity-prices-de-lu","position":4},{"hierarchy":{"lvl1":"Electricity prices in Germany","lvl3":"What are SMARD Electricity Prices (DE/LU)?","lvl2":"Background"},"content":"The DE/LU price refers to the wholesale cost of electricity for the joint\nbidding zone comprising Germany and Luxembourg.\n\nUniform Price: Within this zone, electricity is treated as if it were on\na “copper plate”—the wholesale price is the same regardless of location.\n\nWholesale vs. Retail: These are wholesale prices (what energy suppliers\npay on the exchange). Retail bills include additional taxes, grid fees, and\nlevies.\n\nVolatility: Prices fluctuate hourly based on weather (wind/solar), demand\n(industrial activity), and fuel prices (natural gas).","type":"content","url":"/notebooks/smard-de-prices#what-are-smard-electricity-prices-de-lu","position":5},{"hierarchy":{"lvl1":"Electricity prices in Germany","lvl3":"What is Day-Ahead?","lvl2":"Background"},"type":"lvl3","url":"/notebooks/smard-de-prices#what-is-day-ahead","position":6},{"hierarchy":{"lvl1":"Electricity prices in Germany","lvl3":"What is Day-Ahead?","lvl2":"Background"},"content":"The Day-Ahead Market is the primary exchange for electricity. Because\nelectricity is difficult to store, it must be traded before production.\n\nThe Auction: Every day at 12:00 CET, an auction takes place for each\nhour of the following day.\n\nClearing Price: The exchange algorithm finds where supply meets demand.\nThis “Market Clearing Price” is what SMARD publishes.","type":"content","url":"/notebooks/smard-de-prices#what-is-day-ahead","position":7},{"hierarchy":{"lvl1":"Electricity prices in Germany","lvl3":"Connection to Other Bidding Zones","lvl2":"Background"},"type":"lvl3","url":"/notebooks/smard-de-prices#connection-to-other-bidding-zones","position":8},{"hierarchy":{"lvl1":"Electricity prices in Germany","lvl3":"Connection to Other Bidding Zones","lvl2":"Background"},"content":"Germany/Luxembourg is part of the Single Day-Ahead Coupling (SDAC), linking\nmost of Europe. Through interconnectors, electricity flows from low-price areas\n(high supply) to high-price areas (high demand). When cables are congested,\nprices “split” between zones.","type":"content","url":"/notebooks/smard-de-prices#connection-to-other-bidding-zones","position":9},{"hierarchy":{"lvl1":"Electricity prices in Germany","lvl3":"Daylight Savings Time Transitions","lvl2":"Background"},"type":"lvl3","url":"/notebooks/smard-de-prices#daylight-savings-time-transitions","position":10},{"hierarchy":{"lvl1":"Electricity prices in Germany","lvl3":"Daylight Savings Time Transitions","lvl2":"Background"},"content":"Spring (23-hour day): When clocks jump from 02:00 to 03:00, the 2 AM hour\nis missing from the data.\n\nAutumn (25-hour day): When clocks fall back, the extra hour is labeled\nas 3A and 3B (or similar). This often shows very low prices due to\nreduced demand and extra generation capacity.","type":"content","url":"/notebooks/smard-de-prices#daylight-savings-time-transitions","position":11},{"hierarchy":{"lvl1":"Electricity prices in Germany","lvl2":"Observations from the Data"},"type":"lvl2","url":"/notebooks/smard-de-prices#observations-from-the-data","position":12},{"hierarchy":{"lvl1":"Electricity prices in Germany","lvl2":"Observations from the Data"},"content":"","type":"content","url":"/notebooks/smard-de-prices#observations-from-the-data","position":13},{"hierarchy":{"lvl1":"Electricity prices in Germany","lvl3":"The 2021-2023 Energy Crisis","lvl2":"Observations from the Data"},"type":"lvl3","url":"/notebooks/smard-de-prices#the-2021-2023-energy-crisis","position":14},{"hierarchy":{"lvl1":"Electricity prices in Germany","lvl3":"The 2021-2023 Energy Crisis","lvl2":"Observations from the Data"},"content":"The most striking feature in the data is the dramatic price surge from mid-2021\nthrough early 2023, with monthly averages peaking above 460 EUR/MWh in\nAugust 2022—roughly 10x the pre-crisis baseline of ~40 EUR/MWh.\n\nPrimary causes:\n\nPost-COVID recovery (2021): Economic rebound increased global energy\ndemand, particularly for LNG in Asia, tightening European gas supplies.\n\nRussia’s invasion of Ukraine (Feb 2022): Russia had supplied ~44% of\nEU natural gas imports. The subsequent supply cuts caused gas prices to surge\n5-fold, directly impacting electricity prices since gas plants often set the\nmarginal price.\n\nMerit order effect: In electricity markets, the most expensive plant\nneeded to meet demand sets the price for all generators. With gas prices\nsoaring, this “marginal” plant became extremely costly.\n\nThe crisis peaked in August 2022 when wholesale prices exceeded 850 EUR/MWh.","type":"content","url":"/notebooks/smard-de-prices#the-2021-2023-energy-crisis","position":15},{"hierarchy":{"lvl1":"Electricity prices in Germany","lvl3":"Negative Prices","lvl2":"Observations from the Data"},"type":"lvl3","url":"/notebooks/smard-de-prices#negative-prices","position":16},{"hierarchy":{"lvl1":"Electricity prices in Germany","lvl3":"Negative Prices","lvl2":"Observations from the Data"},"content":"The hourly data shows prices occasionally dropping below zero (visible as\ndownward spikes reaching -200 to -500 EUR/MWh). Negative prices mean\nproducers must pay to have their electricity taken off the grid.\n\nWhy this happens:\n\nRenewable oversupply: On sunny, windy days (especially weekends), solar\nand wind generation can exceed demand. Germany added massive renewable\ncapacity—the EU installed a record 56 GW of solar in 2023 alone.\n\nInflexible generation: Nuclear and some coal plants cannot quickly ramp\ndown, so they pay to keep running rather than face costly shutdown/restart.\n\nGrid congestion: Limited transmission capacity can trap excess power in\ncertain regions.\n\nTiming mismatch: Peak solar production (midday) doesn’t align with peak\ndemand (mornings/evenings), especially on low-demand weekends.\n\nIn H1 2025, Germany experienced 389 hours of negative day-ahead prices.","type":"content","url":"/notebooks/smard-de-prices#negative-prices","position":17},{"hierarchy":{"lvl1":"Electricity prices in Germany","lvl3":"Positive Price Spikes","lvl2":"Observations from the Data"},"type":"lvl3","url":"/notebooks/smard-de-prices#positive-price-spikes","position":18},{"hierarchy":{"lvl1":"Electricity prices in Germany","lvl3":"Positive Price Spikes","lvl2":"Observations from the Data"},"content":"Extreme upward spikes (600-900+ EUR/MWh) occur during supply scarcity events:\n\nDunkelflaute: German for “dark doldrums”—periods of cold, cloudy, windless\nweather when renewable output collapses. In December 2024, intraday prices\nbriefly hit ~1,000 EUR/MWh during an extended Dunkelflaute.\n\nPlant outages: Unplanned maintenance or failures of conventional plants\nduring high-demand periods exacerbate scarcity.\n\nPeak demand: Cold winter evenings with high heating demand and low\nrenewable output force reliance on expensive gas “peaker” plants.\n\nThese dynamics illustrate why flexibility (storage, demand response, grid\nexpansion) is critical for integrating high shares of variable renewables.\n\n","type":"content","url":"/notebooks/smard-de-prices#positive-price-spikes","position":19},{"hierarchy":{"lvl1":"Electricity prices in Germany","lvl2":"Data Source"},"type":"lvl2","url":"/notebooks/smard-de-prices#data-source","position":20},{"hierarchy":{"lvl1":"Electricity prices in Germany","lvl2":"Data Source"},"content":"The price data is downloaded from the SMARD API using the following function:\n\ndef download_smard_data(\n    region: str, \n    resolution: str, \n    variable: int, \n    variable_name: str,\n    start_time: Optional[datetime] = None\n) -> pd.DataFrame:\n    \"\"\"Download data from SMARD API for given parameters.\n    \n    Note: The SMARD API uses a block-based data retrieval system where we first get\n    timestamps marking the start of data blocks (e.g. weekly chunks), then fetch\n    the actual observations for each block in separate requests.\n    \n    Args:\n        region: Region code (e.g. 'DE' for Germany)\n        resolution: Time resolution (e.g. 'day', 'hour')\n        variable: Variable ID for the type of power data\n        variable_name: Name of the variable to use as column label\n        start_time: Optional datetime to specify start of data collection.\n                   If None, returns all available data.\n    \n    Returns:\n        pd.DataFrame: DataFrame with timestamp index and value column\n        \n    Raises:\n        RuntimeError: If there's an error fetching data from the API\n    \"\"\"\n    base_url = \"https://www.smard.de/app\"\n    \n    # Step 1: Get available timestamps\n    index_url = f\"{base_url}/chart_data/{variable}/{region}/index_{resolution}.json\"\n    response = requests.get(index_url)\n    \n    if response.status_code != 200:\n        raise RuntimeError(f\"Error fetching timestamps: {response.status_code}\")\n        \n    timestamps = response.json()[\"timestamps\"]\n    \n    if not timestamps:\n        raise RuntimeError(\"No timestamps available for the specified parameters\")\n\n    # Filter timestamps if start_time is provided\n    if start_time:\n        start_timestamp = int(start_time.timestamp() * 1000)  # Convert to milliseconds\n        timestamps = [ts for ts in timestamps if ts >= start_timestamp]\n        \n        if not timestamps:\n            raise RuntimeError(f\"No data available after {start_time}\")\n\n    # Initialize empty lists to store all data\n    all_timestamps = []\n    all_values = []\n\n    # Step 2: Get data for each timestamp\n    for timestamp in timestamps:\n        data_url = f\"{base_url}/chart_data/{variable}/{region}/{variable}_{region}_{resolution}_{timestamp}.json\"\n        data_response = requests.get(data_url)\n        \n        if data_response.status_code != 200:\n            print(f\"Warning: Error fetching data for timestamp {timestamp}: {data_response.status_code}\")\n            continue\n            \n        data = data_response.json()\n        series_data: List[Tuple[int, float]] = data[\"series\"]\n        \n        # Extract timestamps and values\n        ts = [datetime.fromtimestamp(ts/1000) for ts, _ in series_data]\n        values = [val for _, val in series_data]\n        \n        all_timestamps.extend(ts)\n        all_values.extend(values)\n    \n    # Create and return dataframe\n    df = pd.DataFrame({\n        'timestamp': all_timestamps,\n        variable_name: all_values\n    })\n    \n    # Sort by timestamp and remove duplicates\n    df = df.sort_values('timestamp').drop_duplicates(subset='timestamp')\n    df.set_index('timestamp', inplace=True)\n    df = df.dropna()\n    \n    return df \n\nimport pandas as pd\nimport matplotlib.pyplot as plt\n\nfrom woe.paths import ProjPaths\n\n\n\n\n\n# Load the price data\npaths = ProjPaths()\npaths.images_path.mkdir(parents=True, exist_ok=True)\nprices_file = paths.smard_prices_file\n\nprint(f\"Loading data from: {prices_file}\")\ndf = pd.read_parquet(prices_file)\n\nprint(f\"Data shape: {df.shape}\")\nprint(f\"Date range: {df.index.min()} to {df.index.max()}\")\ndf.head()\n\n\n\n\n\n# Time series plot of electricity prices\nfig, ax = plt.subplots(figsize=(14, 6))\n\nax.plot(df.index, df[\"PRICE_DE_LU\"], linewidth=0.5, alpha=0.8)\nax.set_xlabel(\"Date\")\nax.set_ylabel(\"Price (EUR/MWh)\")\nax.set_title(\"DE/LU Day-Ahead Electricity Prices\")\nax.grid(True, alpha=0.3)\n\nfig.tight_layout()\nfig.savefig(paths.images_path / \"03_hourly_prices.png\", dpi=150, bbox_inches=\"tight\")\nplt.show()\n\n\n\n\n\nFigure 1:DE/LU Day-Ahead Electricity Prices\n\n# Monthly average prices\nmonthly_avg = df.resample(\"ME\").mean()\n\nfig, ax = plt.subplots(figsize=(14, 6))\n\nax.plot(monthly_avg.index, monthly_avg[\"PRICE_DE_LU\"], marker=\"o\", markersize=3)\nax.set_xlabel(\"Date\")\nax.set_ylabel(\"Price (EUR/MWh)\")\nax.set_title(\"DE/LU Monthly Average Electricity Prices\")\nax.grid(True, alpha=0.3)\n\nfig.tight_layout()\nfig.savefig(paths.images_path / \"03_monthly_avg_prices.png\", dpi=150, bbox_inches=\"tight\")\nplt.show()\n\n\n\n\n\nFigure 2:DE/LU Monthly Average Electricity Prices\n\n","type":"content","url":"/notebooks/smard-de-prices#data-source","position":21},{"hierarchy":{"lvl1":"Electricity prices in Germany","lvl2":"Intraday Seasonality"},"type":"lvl2","url":"/notebooks/smard-de-prices#intraday-seasonality","position":22},{"hierarchy":{"lvl1":"Electricity prices in Germany","lvl2":"Intraday Seasonality"},"content":"The charts above use hourly resolution which compresses daily patterns. Below\nwe zoom into a three-week window so that the recurring daily and weekly price\ncycles become clearly visible.\n\nTypical patterns:\n\nMorning ramp (06:00–09:00): Prices rise sharply as households and\nindustry come online.\n\nSolar dip (11:00–15:00): On sunny days, abundant solar generation\npushes prices down around midday—sometimes below zero.\n\nEvening peak (17:00–20:00): Demand stays high while solar fades,\nforcing expensive gas plants onto the grid.\n\nWeekend effect: Lower industrial demand on Saturdays and Sundays\ncompresses the entire price curve downward.\n\nfrom datetime import datetime, timedelta\n\n# Pick a recent 3-week window ending at the last full day in the hourly data\nend_date = df.index.max().normalize()\nstart_date = end_date - timedelta(weeks=3)\n\nsub_prices = df.loc[start_date:end_date].copy()\nprint(f\"Hourly prices: {start_date.date()} to {end_date.date()} ({len(sub_prices)} records)\")\n\n\n\n\n\nfig, ax = plt.subplots(figsize=(14, 5))\n\nimport matplotlib.dates as mdates\n\nax.plot(sub_prices.index, sub_prices[\"PRICE_DE_LU\"], linewidth=0.6)\nax.set_ylabel(\"Price (EUR/MWh)\")\nax.set_title(\n    f\"Hourly DE/LU Day-Ahead Prices \"\n    f\"({start_date.strftime('%d %b')} – {end_date.strftime('%d %b %Y')})\"\n)\nax.grid(True, alpha=0.3)\n\n# Show every day on the x-axis\nax.xaxis.set_major_locator(mdates.DayLocator())\nax.xaxis.set_major_formatter(mdates.DateFormatter(\"%d %b\"))\nfig.autofmt_xdate(rotation=45)\n\n# Shade weekends\nfor dt in pd.date_range(start_date, end_date, freq=\"D\"):\n    if dt.weekday() >= 5:  # Saturday=5, Sunday=6\n        ax.axvspan(dt, dt + timedelta(days=1), alpha=0.08, color=\"grey\")\n\nax.legend([\"Price\", \"Weekend\"], loc=\"upper right\")\nfig.tight_layout()\nfig.savefig(paths.images_path / \"03_intraday_3week.png\", dpi=150, bbox_inches=\"tight\")\nplt.show()\n\n\n\n\n\nFigure 3:Hourly DE/LU Day-Ahead Prices (3-week window)\n\n# Average daily profile across the 3-week window\nsub_prices[\"hour\"] = sub_prices.index.hour + sub_prices.index.minute / 60\nsub_prices[\"is_weekend\"] = sub_prices.index.weekday >= 5\n\nweekday_profile = sub_prices[~sub_prices[\"is_weekend\"]].groupby(\"hour\")[\"PRICE_DE_LU\"].mean()\nweekend_profile = sub_prices[sub_prices[\"is_weekend\"]].groupby(\"hour\")[\"PRICE_DE_LU\"].mean()\n\nfig, ax = plt.subplots(figsize=(10, 5))\n\nax.plot(weekday_profile.index, weekday_profile.values, label=\"Weekday avg\", linewidth=1.5)\nax.plot(weekend_profile.index, weekend_profile.values, label=\"Weekend avg\", linewidth=1.5)\nax.set_xlabel(\"Hour of day\")\nax.set_ylabel(\"Price (EUR/MWh)\")\nax.set_title(\n    f\"Average Daily Price Profile \"\n    f\"({start_date.strftime('%d %b')} – {end_date.strftime('%d %b %Y')})\"\n)\nax.set_xlim(0, 24)\nax.set_xticks(range(0, 25, 3))\nax.legend()\nax.grid(True, alpha=0.3)\n\n# Clean up helper columns\nsub_prices.drop(columns=[\"hour\", \"is_weekend\"], inplace=True)\n\nfig.tight_layout()\nfig.savefig(paths.images_path / \"03_daily_profile.png\", dpi=150, bbox_inches=\"tight\")\nplt.show()\n\n\n\n\n\nFigure 4:Average Daily Price Profile (weekday vs weekend)\n\n","type":"content","url":"/notebooks/smard-de-prices#intraday-seasonality","position":23},{"hierarchy":{"lvl1":"Electricity prices in Germany","lvl2":"Electricity Prices and Natural Gas"},"type":"lvl2","url":"/notebooks/smard-de-prices#electricity-prices-and-natural-gas","position":24},{"hierarchy":{"lvl1":"Electricity prices in Germany","lvl2":"Electricity Prices and Natural Gas"},"content":"In European electricity markets, natural gas plants frequently set the\nmarginal (price-setting) price because they sit at the expensive end of the\nmerit order. When gas prices rise, the cost of running these plants increases,\nwhich lifts the clearing price for all generators—even low-cost renewables.\n\nThe chart below overlays monthly average electricity prices with the TTF\n(Title Transfer Facility) natural gas front-month futures price. TTF is the\nbenchmark hub for north-west European gas trading and the most liquid gas\ncontract on the continent.\n\nThe tight co-movement during 2021-2023 illustrates how the gas supply crisis\ndirectly transmitted into record electricity prices.\n\n# Load TTF gas prices\ngas_df = pd.read_parquet(paths.ttf_gas_prices_file)\ngas_df.index = pd.to_datetime(gas_df.index)\n\nprint(f\"Gas prices: {len(gas_df)} records\")\nprint(f\"Date range: {gas_df.index.min().date()} to {gas_df.index.max().date()}\")\n\n\n\n\n\n# Monthly averages for both series\nmonthly_power = df.resample(\"ME\").mean()\nmonthly_gas = gas_df[\"Close\"].resample(\"ME\").mean()\n\nfig, ax1 = plt.subplots(figsize=(14, 6))\n\ncolor_power = \"tab:blue\"\nax1.plot(monthly_power.index, monthly_power[\"PRICE_DE_LU\"],\n         color=color_power, linewidth=1.2, label=\"Electricity (DE/LU)\")\nax1.set_xlabel(\"Date\")\nax1.set_ylabel(\"Electricity Price (EUR/MWh)\", color=color_power)\nax1.tick_params(axis=\"y\", labelcolor=color_power)\n\nax2 = ax1.twinx()\ncolor_gas = \"tab:orange\"\nax2.plot(monthly_gas.index, monthly_gas.values,\n         color=color_gas, linewidth=1.2, label=\"TTF Gas\")\nax2.set_ylabel(\"TTF Gas Price (EUR/MWh)\", color=color_gas)\nax2.tick_params(axis=\"y\", labelcolor=color_gas)\n\nax1.set_title(\"Monthly Average Electricity vs Natural Gas Prices\")\nax1.grid(True, alpha=0.3)\n\n# Combined legend\nlines1, labels1 = ax1.get_legend_handles_labels()\nlines2, labels2 = ax2.get_legend_handles_labels()\nax1.legend(lines1 + lines2, labels1 + labels2, loc=\"upper left\")\n\nfig.tight_layout()\nfig.savefig(paths.images_path / \"03_electricity_vs_gas.png\", dpi=150, bbox_inches=\"tight\")\nplt.show()\n\n\n\n\n\nFigure 5:Monthly Average Electricity vs Natural Gas Prices\n\n","type":"content","url":"/notebooks/smard-de-prices#electricity-prices-and-natural-gas","position":25},{"hierarchy":{"lvl1":"Electricity prices in Germany","lvl2":"Renewable Generation and Residual Load"},"type":"lvl2","url":"/notebooks/smard-de-prices#renewable-generation-and-residual-load","position":26},{"hierarchy":{"lvl1":"Electricity prices in Germany","lvl2":"Renewable Generation and Residual Load"},"content":"Residual load is the electricity demand that must be covered by\ndispatchable (controllable) power plants after subtracting variable\nrenewable generation:\\text{Residual Load} = \\text{Total Load} - \\text{Solar}\n  - \\text{Wind Onshore} - \\text{Wind Offshore}\n\nIt is the single most important driver of wholesale electricity prices:\n\nHigh residual load → more conventional plants must run, including\nexpensive gas turbines → higher prices\n\nLow / negative residual load → renewables cover (or exceed) demand →\ncheap plants suffice → lower prices (sometimes negative)\n\nThe stacked area chart below shows renewable generation (solar, onshore wind,\noffshore wind) against total electricity load. The gap between the top of the\nrenewables stack and the load line is the residual load.\n\n# Load generation and load data\nsolar = pd.read_parquet(paths.smard_solar_file)\nwind_on = pd.read_parquet(paths.smard_wind_onshore_file)\nwind_off = pd.read_parquet(paths.smard_wind_offshore_file)\ntotal_load = pd.read_parquet(paths.smard_total_load_file)\n\n# Combine into one DataFrame\ngen = pd.concat([\n    solar.rename(columns={solar.columns[0]: \"solar\"}),\n    wind_on.rename(columns={wind_on.columns[0]: \"wind_onshore\"}),\n    wind_off.rename(columns={wind_off.columns[0]: \"wind_offshore\"}),\n    total_load.rename(columns={total_load.columns[0]: \"total_load\"}),\n], axis=1).dropna()\n\ngen[\"renewables\"] = gen[\"solar\"] + gen[\"wind_onshore\"] + gen[\"wind_offshore\"]\ngen[\"residual_load\"] = gen[\"total_load\"] - gen[\"renewables\"]\n\nprint(f\"Generation data: {len(gen)} records\")\nprint(f\"Date range: {gen.index.min()} to {gen.index.max()}\")\n\n\n\n\n\n# Renewables vs total load (monthly averages for readability)\nmonthly_gen = gen.resample(\"ME\").mean()\n\nfig, ax = plt.subplots(figsize=(14, 6))\n\nax.stackplot(\n    monthly_gen.index,\n    monthly_gen[\"solar\"],\n    monthly_gen[\"wind_onshore\"],\n    monthly_gen[\"wind_offshore\"],\n    labels=[\"Solar\", \"Wind Onshore\", \"Wind Offshore\"],\n    alpha=0.7,\n)\nax.plot(monthly_gen.index, monthly_gen[\"total_load\"],\n        color=\"black\", linewidth=0.8, label=\"Total Load\")\n\nax.set_xlabel(\"Date\")\nax.set_ylabel(\"Power (MW)\")\nax.set_title(\"Renewable Generation vs Total Load (Monthly Averages)\")\nax.legend(loc=\"upper left\")\nax.grid(True, alpha=0.3)\n\nfig.tight_layout()\nfig.savefig(paths.images_path / \"03_renewables_vs_load.png\", dpi=150, bbox_inches=\"tight\")\nplt.show()\n\n\n\n\n\nFigure 6:Renewable Generation vs Total Load (Monthly Averages)\n\n# Monthly average residual load\nfig, ax = plt.subplots(figsize=(14, 6))\n\nax.plot(monthly_gen.index, monthly_gen[\"residual_load\"], color=\"tab:red\", linewidth=1.2)\nax.axhline(0, color=\"black\", linewidth=0.5, linestyle=\"--\")\nax.set_xlabel(\"Date\")\nax.set_ylabel(\"Residual Load (MW)\")\nax.set_title(\"Monthly Average Residual Load\")\nax.grid(True, alpha=0.3)\n\nfig.tight_layout()\nfig.savefig(paths.images_path / \"03_monthly_residual_load.png\", dpi=150, bbox_inches=\"tight\")\nplt.show()\n\n\n\n\n\nFigure 7:Monthly Average Residual Load\n\n","type":"content","url":"/notebooks/smard-de-prices#renewable-generation-and-residual-load","position":27},{"hierarchy":{"lvl1":"Electricity prices in Germany","lvl2":"Residual Load vs Electricity Price"},"type":"lvl2","url":"/notebooks/smard-de-prices#residual-load-vs-electricity-price","position":28},{"hierarchy":{"lvl1":"Electricity prices in Germany","lvl2":"Residual Load vs Electricity Price"},"content":"Because the merit order is roughly monotonic—cheap renewables first, then\ncoal/lignite, then gas—the price is largely determined by how far up the\nsupply curve demand reaches. Residual load measures exactly that.\n\nThe charts below zoom into three-week windows to show how hourly residual\nload and electricity prices move together. A linear fit\n(price = intercept + slope × residual load) is used to align the two\ny-axes so that the visual overlap reflects the statistical relationship.\n\nimport numpy as np\n\n# Align price and residual load on the same index\nprice_res = df[[\"PRICE_DE_LU\"]].join(gen[[\"residual_load\"]], how=\"inner\").dropna()\n\n\ndef plot_price_vs_residual(price_res_window, title_dates, save_path=None):\n    \"\"\"Plot price and residual load with axes aligned via a linear fit.\"\"\"\n    X = price_res_window[\"residual_load\"].values\n    y = price_res_window[\"PRICE_DE_LU\"].values\n    slope, intercept = np.polyfit(X, y, 1)\n    print(f\"Linear fit: price = {intercept:.2f} + {slope:.4f} × residual_load\")\n\n    fig, ax1 = plt.subplots(figsize=(14, 6))\n\n    color1 = \"tab:blue\"\n    ax1.plot(price_res_window.index, price_res_window[\"residual_load\"],\n             color=color1, linewidth=0.5, alpha=0.7, label=\"Residual Load\")\n    ax1.set_xlabel(\"Date\")\n    ax1.set_ylabel(\"Residual Load (MW)\", color=color1)\n    ax1.tick_params(axis=\"y\", labelcolor=color1)\n\n    ax2 = ax1.twinx()\n    color2 = \"tab:orange\"\n    ax2.plot(price_res_window.index, price_res_window[\"PRICE_DE_LU\"],\n             color=color2, linewidth=0.5, alpha=0.7, label=\"Price\")\n    ax2.set_ylabel(\"Price (EUR/MWh)\", color=color2)\n    ax2.tick_params(axis=\"y\", labelcolor=color2)\n\n    # Align the residual load axis to the price axis using the linear fit\n    p_lo, p_hi = ax2.get_ylim()\n    ax1.set_ylim((p_lo - intercept) / slope, (p_hi - intercept) / slope)\n\n    ax1.set_title(f\"Residual Load and Electricity Price ({title_dates})\")\n    ax1.grid(True, alpha=0.3)\n\n    lines1, labels1 = ax1.get_legend_handles_labels()\n    lines2, labels2 = ax2.get_legend_handles_labels()\n    ax1.legend(lines1 + lines2, labels1 + labels2, loc=\"upper left\")\n\n    fig.tight_layout()\n    if save_path:\n        fig.savefig(save_path, dpi=150, bbox_inches=\"tight\")\n    plt.show()\n\n\n\n\n\n# Recent 3-week window (same as intraday section above)\nprice_res_sub = price_res.loc[start_date:end_date]\nprint(f\"Matched records: {len(price_res_sub)}\")\n\nplot_price_vs_residual(\n    price_res_sub,\n    f\"{start_date.strftime('%d %b')} – {end_date.strftime('%d %b %Y')}\",\n    save_path=paths.images_path / \"03_price_vs_residual_recent.png\",\n)\n\n\n\n\n\nFigure 8:Residual Load and Electricity Price (recent 3-week window)\n\n# A second 3-week window in 2025 for comparison\nstart_2025 = pd.Timestamp(\"2025-06-01\")\nend_2025 = start_2025 + timedelta(weeks=3)\n\nprice_res_2025 = price_res.loc[start_2025:end_2025]\nprint(f\"Matched records (2025 window): {len(price_res_2025)}\")\n\nplot_price_vs_residual(\n    price_res_2025,\n    f\"{start_2025.strftime('%d %b')} – {end_2025.strftime('%d %b %Y')}\",\n    save_path=paths.images_path / \"03_price_vs_residual_2025.png\",\n)\n\n\n\n\n\nFigure 9:Residual Load and Electricity Price (June 2025 window)","type":"content","url":"/notebooks/smard-de-prices#residual-load-vs-electricity-price","position":29},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction"},"type":"lvl1","url":"/notebooks/reconstruct-prices","position":0},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction"},"content":"This notebook calculates the Short Run Marginal Costs (SRMC) of generating\nelectricity using hard coal and fossil gas, then uses a simplified merit\norder model to reconstruct wholesale electricity prices.","type":"content","url":"/notebooks/reconstruct-prices","position":1},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl2":"Approach"},"type":"lvl2","url":"/notebooks/reconstruct-prices#approach","position":2},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl2":"Approach"},"content":"Calculate SRMC for coal and gas power plants from commodity prices\n\nCalculate Fossil Residual Load: the demand that must be met by fossil plants\nafter accounting for renewables and baseload generationRL_{fossil} = \\text{Load} - (\\text{Wind} + \\text{Solar}) - (\\text{Nuclear} + \\text{Biomass} + \\text{Hydro}_{RoR})\n\nDetermine which fossil fuel (coal or gas) is cheaper based on SRMC\n\nAssign price based on merit order:\n\nIf RL_{fossil} \\leq \\text{cheaper capacity}: price = cheaper SRMC\n\nIf RL_{fossil} > \\text{cheaper capacity}: price = more expensive SRMC\n\nCompare reconstructed prices with actual market prices\n\n","type":"content","url":"/notebooks/reconstruct-prices#approach","position":3},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl2":"Short Run Marginal Costs (SRMC)"},"type":"lvl2","url":"/notebooks/reconstruct-prices#short-run-marginal-costs-srmc","position":4},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl2":"Short Run Marginal Costs (SRMC)"},"content":"The Short Run Marginal Cost (SRMC) represents the variable cost of producing\none additional MWh of electricity from a power plant. It determines the merit\norder position of generators in wholesale electricity markets.","type":"content","url":"/notebooks/reconstruct-prices#short-run-marginal-costs-srmc","position":5},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl3":"Components of SRMC","lvl2":"Short Run Marginal Costs (SRMC)"},"type":"lvl3","url":"/notebooks/reconstruct-prices#components-of-srmc","position":6},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl3":"Components of SRMC","lvl2":"Short Run Marginal Costs (SRMC)"},"content":"SRMC consists of three main components:\n\nFuel costs - The cost of the primary fuel (gas or coal) needed to\ngenerate electricity, adjusted for plant efficiency.\n\nCarbon costs - The cost of CO2 emissions under the EU Emissions Trading\nScheme (EU ETS), based on the carbon intensity of the fuel.\n\nVariable O&M costs - Operating and maintenance costs that vary with\nelectricity output.","type":"content","url":"/notebooks/reconstruct-prices#components-of-srmc","position":7},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl3":"Price References","lvl2":"Short Run Marginal Costs (SRMC)"},"type":"lvl3","url":"/notebooks/reconstruct-prices#price-references","position":8},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl3":"Price References","lvl2":"Short Run Marginal Costs (SRMC)"},"content":"Fossil Gas:\n\nDutch Title Transfer Facility (TTF) is the benchmark for gas traded in Europe\n\nOther European hubs (CEGH VTP, THE, PSV, etc.) trade at spreads to TTF\n\nPrices sourced from commodity exchanges (e.g., ICE, EEX)\n\nHard Coal:\n\nAPI 2 Rotterdam is the benchmark for coal imported into Northwest Europe\n\nFront month settlement prices in USD/metric ton\n\nThermal content approximately 6,000 kcal/kg (NAR)\n\nCarbon:\n\nEU ETS allowance prices (EUA) for the front December contract\n\nPrices in EUR per tonne CO2","type":"content","url":"/notebooks/reconstruct-prices#price-references","position":9},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl3":"Calculation Assumptions","lvl2":"Short Run Marginal Costs (SRMC)"},"type":"lvl3","url":"/notebooks/reconstruct-prices#calculation-assumptions","position":10},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl3":"Calculation Assumptions","lvl2":"Short Run Marginal Costs (SRMC)"},"content":"Parameter\n\nHard Coal\n\nFossil Gas\n\nEfficiency (HHV)\n\n40%\n\n50%\n\nCarbon intensity\n\n0.83 tCO2/MWh\n\n0.37 tCO2/MWh\n\nVariable O&M\n\n€2/MWh\n\n€2/MWh\n\nThe carbon intensity values represent emissions per MWh of electricity generated,\naccounting for the power plant efficiency.","type":"content","url":"/notebooks/reconstruct-prices#calculation-assumptions","position":11},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl3":"Why SRMC Matters","lvl2":"Short Run Marginal Costs (SRMC)"},"type":"lvl3","url":"/notebooks/reconstruct-prices#why-srmc-matters","position":12},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl3":"Why SRMC Matters","lvl2":"Short Run Marginal Costs (SRMC)"},"content":"In liberalized electricity markets, generators bid close to their marginal cost.\nThe SRMC comparison between coal and gas determines:\n\nFuel switching - When gas SRMC falls below coal, utilities switch from\ncoal to gas, reducing emissions\n\nPrice formation - The highest SRMC plant needed to meet demand often\nsets the wholesale electricity price\n\nInvestment signals - Persistent SRMC relationships influence new build\ndecisions and plant retirements\n\nimport pandas as pd\nimport numpy as np\nimport matplotlib.pyplot as plt\nfrom sklearn.linear_model import LinearRegression\nfrom sklearn.metrics import r2_score\n\nfrom woe.paths import ProjPaths\n\n\n\n","type":"content","url":"/notebooks/reconstruct-prices#why-srmc-matters","position":13},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl2":"SRMC Calculation Parameters"},"type":"lvl2","url":"/notebooks/reconstruct-prices#srmc-calculation-parameters","position":14},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl2":"SRMC Calculation Parameters"},"content":"\n\n# Power plant efficiency rates (Higher Heating Value / Gross Calorific Value)\nCOAL_EFFICIENCY = 0.40  # 40%\nGAS_EFFICIENCY = 0.50  # 50%\n\n# Carbon intensity (tCO2 per MWh of electricity generated)\nCOAL_CARBON_INTENSITY = 0.83  # tCO2/MWh\nGAS_CARBON_INTENSITY = 0.37  # tCO2/MWh\n\n# Variable Operating and Maintenance costs (EUR/MWh)\nVOM_COST = 2.0\n\n# Coal thermal content (MWh per metric ton)\n# API 2 coal specification: 6,000 kcal/kg NAR\n# 6,000 kcal/kg = 6,000,000 kcal/t ÷ 860,421 kcal/MWh ≈ 6.98 MWh/t\nCOAL_THERMAL_CONTENT = 6.98  # MWh/t\n\n# EUR/USD exchange rate (approximate)\nEURUSD_RATE = 1.08\n\n\n\n","type":"content","url":"/notebooks/reconstruct-prices#srmc-calculation-parameters","position":15},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl2":"Load Data"},"type":"lvl2","url":"/notebooks/reconstruct-prices#load-data","position":16},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl2":"Load Data"},"content":"\n\npaths = ProjPaths()\npaths.images_path.mkdir(parents=True, exist_ok=True)\n\n# Load generation and consumption data\nprint(\"Loading SMARD data...\")\nsolar = pd.read_parquet(paths.smard_solar_file)\nwind_onshore = pd.read_parquet(paths.smard_wind_onshore_file)\nwind_offshore = pd.read_parquet(paths.smard_wind_offshore_file)\ntotal_load = pd.read_parquet(paths.smard_total_load_file)\nprices = pd.read_parquet(paths.smard_prices_file)\ncapacities = pd.read_parquet(paths.smard_capacities_file)\n\nprint(f\"Generation data: {solar.index.min()} to {solar.index.max()}\")\nprint(f\"Prices: {prices.index.min()} to {prices.index.max()}\")\nprint(f\"Capacities: {capacities.index.min()} to {capacities.index.max()}\")\n\n\n\n","type":"content","url":"/notebooks/reconstruct-prices#load-data","position":17},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl3":"Baseload Generation Data","lvl2":"Load Data"},"type":"lvl3","url":"/notebooks/reconstruct-prices#baseload-generation-data","position":18},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl3":"Baseload Generation Data","lvl2":"Load Data"},"content":"Nuclear, biomass, and hydro generation data for the fossil residual load calculation.\n\nprint(\"Loading baseload generation data...\")\nnuclear = pd.read_parquet(paths.smard_nuclear_file)\nbiomass = pd.read_parquet(paths.smard_biomass_file)\nhydro = pd.read_parquet(paths.smard_hydro_file)\n\nprint(f\"Nuclear: {len(nuclear)} records\")\nprint(f\"Biomass: {len(biomass)} records\")\nprint(f\"Hydro: {len(hydro)} records\")\n\n\n\n","type":"content","url":"/notebooks/reconstruct-prices#baseload-generation-data","position":19},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl3":"Commodity Prices","lvl2":"Load Data"},"type":"lvl3","url":"/notebooks/reconstruct-prices#commodity-prices","position":20},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl3":"Commodity Prices","lvl2":"Load Data"},"content":"\n\ndef load_investing_com_csv(filepath: str) -> pd.Series:\n    \"\"\"Load price data from Investing.com CSV export.\"\"\"\n    df = pd.read_csv(\n        filepath,\n        encoding=\"utf-8-sig\",\n        parse_dates=[\"Date\"],\n        dayfirst=False,\n    )\n    df = df.set_index(\"Date\").sort_index()\n    return df[\"Price\"]\n\n\n\n\n\n# Load commodity prices\nprint(\"Loading commodity prices...\")\ngas_df = pd.read_parquet(paths.ttf_gas_prices_file)\ngas_prices = gas_df[\"Close\"].rename(\"gas_price\")\n\ncoal_prices = load_investing_com_csv(paths.rotterdam_coal_prices_file).rename(\n    \"coal_price\"\n)\n\ncarbon_prices = load_investing_com_csv(paths.eu_carbon_prices_file).rename(\n    \"carbon_price\"\n)\n\nprint(f\"Gas prices: {gas_prices.index.min()} to {gas_prices.index.max()}\")\nprint(f\"Coal prices: {coal_prices.index.min()} to {coal_prices.index.max()}\")\nprint(f\"Carbon prices: {carbon_prices.index.min()} to {carbon_prices.index.max()}\")\n\n\n\n","type":"content","url":"/notebooks/reconstruct-prices#commodity-prices","position":21},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl2":"Calculate SRMC"},"type":"lvl2","url":"/notebooks/reconstruct-prices#calculate-srmc","position":22},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl2":"Calculate SRMC"},"content":"","type":"content","url":"/notebooks/reconstruct-prices#calculate-srmc","position":23},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl3":"Gas SRMC","lvl2":"Calculate SRMC"},"type":"lvl3","url":"/notebooks/reconstruct-prices#gas-srmc","position":24},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl3":"Gas SRMC","lvl2":"Calculate SRMC"},"content":"\\text{Gas SRMC} = \\frac{\\text{Gas Price}}{\\text{Efficiency}} + \\text{Carbon Intensity} \\times \\text{Carbon Price} + \\text{VOM}","type":"content","url":"/notebooks/reconstruct-prices#gas-srmc","position":25},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl3":"Coal SRMC","lvl2":"Calculate SRMC"},"type":"lvl3","url":"/notebooks/reconstruct-prices#coal-srmc","position":26},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl3":"Coal SRMC","lvl2":"Calculate SRMC"},"content":"\\text{Coal SRMC} = \\frac{\\text{Coal Price (EUR/MWh)}}{\\text{Efficiency}} + \\text{Carbon Intensity} \\times \\text{Carbon Price} + \\text{VOM}\n\nNote: Coal prices in USD/t need to be converted to EUR/MWh using:\n\nExchange rate (USD/EUR)\n\nThermal content (MWh/t)\n\n# Combine commodity prices (daily)\ncommodity_prices = pd.concat(\n    [gas_prices, coal_prices, carbon_prices], axis=1, join=\"inner\"\n)\ncommodity_prices = commodity_prices.ffill()\n\n# Convert coal from USD/t to EUR/MWh\ncoal_eur_mwh = commodity_prices[\"coal_price\"] / EURUSD_RATE / COAL_THERMAL_CONTENT\n\n# Calculate SRMC components\ngas_fuel_cost = commodity_prices[\"gas_price\"] / GAS_EFFICIENCY\ncoal_fuel_cost = coal_eur_mwh / COAL_EFFICIENCY\n\ngas_carbon_cost = GAS_CARBON_INTENSITY * commodity_prices[\"carbon_price\"]\ncoal_carbon_cost = COAL_CARBON_INTENSITY * commodity_prices[\"carbon_price\"]\n\n# Total SRMC (daily)\nsrmc_daily = pd.DataFrame(index=commodity_prices.index)\nsrmc_daily[\"gas_srmc\"] = gas_fuel_cost + gas_carbon_cost + VOM_COST\nsrmc_daily[\"coal_srmc\"] = coal_fuel_cost + coal_carbon_cost + VOM_COST\n\n# Store components for analysis\nsrmc_daily[\"gas_fuel_cost\"] = gas_fuel_cost\nsrmc_daily[\"gas_carbon_cost\"] = gas_carbon_cost\nsrmc_daily[\"coal_fuel_cost\"] = coal_fuel_cost\nsrmc_daily[\"coal_carbon_cost\"] = coal_carbon_cost\n\nprint(\"SRMC Summary (EUR/MWh):\")\nprint(srmc_daily[[\"gas_srmc\", \"coal_srmc\"]].describe().round(2))\n\n\n\n","type":"content","url":"/notebooks/reconstruct-prices#coal-srmc","position":27},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl2":"SRMC Time Series"},"type":"lvl2","url":"/notebooks/reconstruct-prices#srmc-time-series","position":28},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl2":"SRMC Time Series"},"content":"\n\nfig, ax = plt.subplots(figsize=(14, 6))\n\nax.plot(srmc_daily.index, srmc_daily[\"gas_srmc\"], label=\"Gas SRMC\", linewidth=1, alpha=0.8)\nax.plot(srmc_daily.index, srmc_daily[\"coal_srmc\"], label=\"Coal SRMC\", linewidth=1, alpha=0.8)\n\nax.set_xlabel(\"Date\")\nax.set_ylabel(\"SRMC (EUR/MWh)\")\nax.set_title(\"Short Run Marginal Costs: Coal vs Gas\")\nax.legend()\nax.grid(True, alpha=0.3)\n\nfig.tight_layout()\nfig.savefig(paths.images_path / \"04_srmc_timeseries.png\", dpi=150, bbox_inches=\"tight\")\nplt.show()\n\n\n\n\n\nFigure 1:Short Run Marginal Costs: Coal vs Gas\n\n","type":"content","url":"/notebooks/reconstruct-prices#srmc-time-series","position":29},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl2":"Monthly Average SRMC"},"type":"lvl2","url":"/notebooks/reconstruct-prices#monthly-average-srmc","position":30},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl2":"Monthly Average SRMC"},"content":"\n\nmonthly_srmc = srmc_daily[[\"gas_srmc\", \"coal_srmc\"]].resample(\"ME\").mean()\n\nfig, ax = plt.subplots(figsize=(14, 6))\n\nax.plot(\n    monthly_srmc.index,\n    monthly_srmc[\"gas_srmc\"],\n    label=\"Gas SRMC\",\n    marker=\"o\",\n    markersize=3,\n)\nax.plot(\n    monthly_srmc.index,\n    monthly_srmc[\"coal_srmc\"],\n    label=\"Coal SRMC\",\n    marker=\"o\",\n    markersize=3,\n)\n\nax.set_xlabel(\"Date\")\nax.set_ylabel(\"SRMC (EUR/MWh)\")\nax.set_title(\"Monthly Average Short Run Marginal Costs\")\nax.legend()\nax.grid(True, alpha=0.3)\n\nfig.tight_layout()\nfig.savefig(paths.images_path / \"04_monthly_srmc.png\", dpi=150, bbox_inches=\"tight\")\nplt.show()\n\n\n\n\n\nFigure 2:Monthly Average Short Run Marginal Costs\n\n","type":"content","url":"/notebooks/reconstruct-prices#monthly-average-srmc","position":31},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl2":"Fuel Switching Indicator"},"type":"lvl2","url":"/notebooks/reconstruct-prices#fuel-switching-indicator","position":32},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl2":"Fuel Switching Indicator"},"content":"When gas SRMC is lower than coal SRMC, it is economically favorable to dispatch\ngas plants over coal plants, leading to lower emissions. This “fuel switching”\nis a key mechanism for carbon price effectiveness.\n\n# Calculate the spread (positive = gas cheaper than coal)\nsrmc_daily[\"spread\"] = srmc_daily[\"coal_srmc\"] - srmc_daily[\"gas_srmc\"]\n\nfig, axes = plt.subplots(2, 1, figsize=(14, 10), sharex=True)\n\n# SRMC comparison\nax1 = axes[0]\nax1.plot(srmc_daily.index, srmc_daily[\"gas_srmc\"], label=\"Gas SRMC\", linewidth=1, alpha=0.8)\nax1.plot(srmc_daily.index, srmc_daily[\"coal_srmc\"], label=\"Coal SRMC\", linewidth=1, alpha=0.8)\nax1.set_ylabel(\"SRMC (EUR/MWh)\")\nax1.set_title(\"Short Run Marginal Costs and Fuel Switching\")\nax1.legend()\nax1.grid(True, alpha=0.3)\n\n# Spread (coal - gas)\nax2 = axes[1]\nax2.fill_between(\n    srmc_daily.index,\n    srmc_daily[\"spread\"],\n    0,\n    where=srmc_daily[\"spread\"] >= 0,\n    color=\"green\",\n    alpha=0.5,\n    label=\"Gas cheaper (fuel switch)\",\n)\nax2.fill_between(\n    srmc_daily.index,\n    srmc_daily[\"spread\"],\n    0,\n    where=srmc_daily[\"spread\"] < 0,\n    color=\"red\",\n    alpha=0.5,\n    label=\"Coal cheaper\",\n)\nax2.axhline(y=0, color=\"black\", linestyle=\"-\", linewidth=0.5)\nax2.set_xlabel(\"Date\")\nax2.set_ylabel(\"Spread (EUR/MWh)\")\nax2.set_title(\"Coal-Gas Spread (positive = gas cheaper)\")\nax2.legend()\nax2.grid(True, alpha=0.3)\n\nfig.tight_layout()\nfig.savefig(paths.images_path / \"04_fuel_switching.png\", dpi=150, bbox_inches=\"tight\")\nplt.show()\n\n\n\n\n\nFigure 3:Short Run Marginal Costs and Fuel Switching Indicator\n\n","type":"content","url":"/notebooks/reconstruct-prices#fuel-switching-indicator","position":33},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl2":"SRMC Cost Components"},"type":"lvl2","url":"/notebooks/reconstruct-prices#srmc-cost-components","position":34},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl2":"SRMC Cost Components"},"content":"Breaking down the SRMC into its fuel and carbon cost components shows the\nrelative importance of each driver.\n\nfig, axes = plt.subplots(1, 2, figsize=(14, 6))\n\n# Gas SRMC components\nax1 = axes[0]\nax1.stackplot(\n    srmc_daily.index,\n    srmc_daily[\"gas_fuel_cost\"],\n    srmc_daily[\"gas_carbon_cost\"],\n    [VOM_COST] * len(srmc_daily),\n    labels=[\"Fuel Cost\", \"Carbon Cost\", \"Variable O&M\"],\n    alpha=0.8,\n)\nax1.set_xlabel(\"Date\")\nax1.set_ylabel(\"Cost (EUR/MWh)\")\nax1.set_title(\"Gas SRMC Components\")\nax1.legend(loc=\"upper left\")\nax1.grid(True, alpha=0.3)\n\n# Coal SRMC components\nax2 = axes[1]\nax2.stackplot(\n    srmc_daily.index,\n    srmc_daily[\"coal_fuel_cost\"],\n    srmc_daily[\"coal_carbon_cost\"],\n    [VOM_COST] * len(srmc_daily),\n    labels=[\"Fuel Cost\", \"Carbon Cost\", \"Variable O&M\"],\n    alpha=0.8,\n)\nax2.set_xlabel(\"Date\")\nax2.set_ylabel(\"Cost (EUR/MWh)\")\nax2.set_title(\"Coal SRMC Components\")\nax2.legend(loc=\"upper left\")\nax2.grid(True, alpha=0.3)\n\nfig.tight_layout()\nfig.savefig(paths.images_path / \"04_srmc_components.png\", dpi=150, bbox_inches=\"tight\")\nplt.show()\n\n\n\n\n\nFigure 4:SRMC Cost Components (Gas and Coal)\n\n","type":"content","url":"/notebooks/reconstruct-prices#srmc-cost-components","position":35},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl2":"Combine All Data"},"type":"lvl2","url":"/notebooks/reconstruct-prices#combine-all-data","position":36},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl2":"Combine All Data"},"content":"Align all data to hourly resolution by forward-filling daily/monthly data.\n\n# Combine generation data into single DataFrame\ndf = pd.concat(\n    [\n        solar.rename(columns={solar.columns[0]: \"solar\"}),\n        wind_onshore.rename(columns={wind_onshore.columns[0]: \"wind_onshore\"}),\n        wind_offshore.rename(columns={wind_offshore.columns[0]: \"wind_offshore\"}),\n        total_load.rename(columns={total_load.columns[0]: \"total_load\"}),\n        prices.rename(columns={prices.columns[0]: \"price\"}),\n        nuclear.rename(columns={nuclear.columns[0]: \"nuclear\"}),\n        biomass.rename(columns={biomass.columns[0]: \"biomass\"}),\n        hydro.rename(columns={hydro.columns[0]: \"hydro\"}),\n    ],\n    axis=1,\n)\n\n# Drop rows with missing generation/price data\ndf = df.dropna()\nprint(f\"Combined hourly data: {len(df)} records\")\nprint(f\"Date range: {df.index.min()} to {df.index.max()}\")\n\n\n\n\n\n# Forward-fill SRMC to hourly\n# Normalize index to date only for merging\ndf[\"date\"] = df.index.date\nsrmc_daily_reset = srmc_daily.copy()\nsrmc_daily_reset.index = srmc_daily_reset.index.date\n\ndf = df.merge(\n    srmc_daily_reset[[\"gas_srmc\", \"coal_srmc\"]],\n    left_on=\"date\",\n    right_index=True,\n    how=\"left\",\n)\ndf = df.drop(columns=[\"date\"])\n\n# Forward-fill any gaps in SRMC\ndf[\"gas_srmc\"] = df[\"gas_srmc\"].ffill()\ndf[\"coal_srmc\"] = df[\"coal_srmc\"].ffill()\n\n# Drop rows without SRMC data\ndf = df.dropna(subset=[\"gas_srmc\", \"coal_srmc\"])\nprint(f\"After SRMC merge: {len(df)} records\")\n\n\n\n\n\n# Forward-fill capacities to hourly\n# Capacities are monthly, so we need to reindex and forward-fill\ncapacities_hourly = capacities.reindex(df.index, method=\"ffill\")\n\n# Add relevant capacity columns to main DataFrame\ndf[\"capacity_coal\"] = (\n    capacities_hourly[\"brown_coal\"].fillna(0)\n    + capacities_hourly[\"hard_coal\"].fillna(0)\n)\ndf[\"capacity_gas\"] = capacities_hourly[\"natural_gas\"].fillna(0)\n\n# Drop rows without capacity data\ndf = df.dropna(subset=[\"capacity_coal\", \"capacity_gas\"])\nprint(f\"After capacity merge: {len(df)} records\")\nprint(f\"Final date range: {df.index.min()} to {df.index.max()}\")\n\n\n\n","type":"content","url":"/notebooks/reconstruct-prices#combine-all-data","position":37},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl2":"Calculate Fossil Residual Load"},"type":"lvl2","url":"/notebooks/reconstruct-prices#calculate-fossil-residual-load","position":38},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl2":"Calculate Fossil Residual Load"},"content":"RL_{fossil} = \\text{Load} - (\\text{Wind} + \\text{Solar}) - (\\text{Nuclear} + \\text{Biomass} + \\text{Hydro})\n\n# Calculate components\ndf[\"wind\"] = df[\"wind_onshore\"] + df[\"wind_offshore\"]\ndf[\"renewables\"] = df[\"solar\"] + df[\"wind\"]\ndf[\"baseload\"] = df[\"nuclear\"] + df[\"biomass\"] + df[\"hydro\"]\n\n# Residual load for fossil plants\ndf[\"rl_fossil\"] = df[\"total_load\"] - df[\"renewables\"] - df[\"baseload\"]\n\n# Standard residual load (for comparison)\ndf[\"residual_load\"] = df[\"total_load\"] - df[\"renewables\"]\n\nprint(\"Fossil Residual Load Statistics (MW):\")\nprint(df[\"rl_fossil\"].describe().round(0))\n\n# Count negative fossil residual load hours\nnegative_hours = (df[\"rl_fossil\"] < 0).sum()\nprint(f\"\\nHours with negative RL_fossil: {negative_hours} ({100*negative_hours/len(df):.1f}%)\")\n\n\n\n","type":"content","url":"/notebooks/reconstruct-prices#calculate-fossil-residual-load","position":39},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl2":"Reconstruct Prices Using Merit Order"},"type":"lvl2","url":"/notebooks/reconstruct-prices#reconstruct-prices-using-merit-order","position":40},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl2":"Reconstruct Prices Using Merit Order"},"content":"For each hour:\n\nDetermine which fuel (coal or gas) has lower SRMC\n\nIf fossil residual load can be met by cheaper fuel capacity alone, use cheaper SRMC\n\nOtherwise, use more expensive SRMC as the marginal price\n\ndef reconstruct_price(row):\n    \"\"\"Reconstruct electricity price based on merit order.\"\"\"\n    rl_fossil = row[\"rl_fossil\"]\n    gas_srmc = row[\"gas_srmc\"]\n    coal_srmc = row[\"coal_srmc\"]\n    capacity_coal = row[\"capacity_coal\"]\n    capacity_gas = row[\"capacity_gas\"]\n\n    # Handle negative residual load (renewable surplus)\n    if rl_fossil <= 0:\n        return 0.0  # Price floor at zero for simplicity\n\n    # Determine merit order based on SRMC\n    if coal_srmc <= gas_srmc:\n        # Coal is cheaper\n        cheaper_srmc = coal_srmc\n        expensive_srmc = gas_srmc\n        cheaper_capacity = capacity_coal\n    else:\n        # Gas is cheaper\n        cheaper_srmc = gas_srmc\n        expensive_srmc = coal_srmc\n        cheaper_capacity = capacity_gas\n\n    # Assign price based on which fuel is marginal\n    if rl_fossil <= cheaper_capacity:\n        return cheaper_srmc\n    else:\n        return expensive_srmc\n\n\n\n\n\n# Apply reconstruction\nprint(\"Reconstructing prices...\")\ndf[\"price_reconstructed\"] = df.apply(reconstruct_price, axis=1)\n\nprint(\"\\nReconstructed Price Statistics (EUR/MWh):\")\nprint(df[\"price_reconstructed\"].describe().round(2))\n\nprint(\"\\nActual Price Statistics (EUR/MWh):\")\nprint(df[\"price\"].describe().round(2))\n\n\n\n","type":"content","url":"/notebooks/reconstruct-prices#reconstruct-prices-using-merit-order","position":41},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl2":"Compare Reconstructed vs Actual Prices"},"type":"lvl2","url":"/notebooks/reconstruct-prices#compare-reconstructed-vs-actual-prices","position":42},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl2":"Compare Reconstructed vs Actual Prices"},"content":"\n\n# Time series comparison (monthly averages)\nmonthly = df[[\"price\", \"price_reconstructed\"]].resample(\"ME\").mean()\n\nfig, ax = plt.subplots(figsize=(14, 6))\n\nax.plot(monthly.index, monthly[\"price\"], label=\"Actual Price\", linewidth=2)\nax.plot(\n    monthly.index,\n    monthly[\"price_reconstructed\"],\n    label=\"Reconstructed Price\",\n    linewidth=2,\n    linestyle=\"--\",\n)\n\nax.set_xlabel(\"Date\")\nax.set_ylabel(\"Price (EUR/MWh)\")\nax.set_title(\"Monthly Average: Actual vs Reconstructed Electricity Prices\")\nax.legend()\nax.grid(True, alpha=0.3)\n\nfig.tight_layout()\nfig.savefig(paths.images_path / \"04_actual_vs_reconstructed.png\", dpi=150, bbox_inches=\"tight\")\nplt.show()\n\n\n\n\n\nFigure 5:Monthly Average: Actual vs Reconstructed Electricity Prices\n\n","type":"content","url":"/notebooks/reconstruct-prices#compare-reconstructed-vs-actual-prices","position":43},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl2":"Scatterplots"},"type":"lvl2","url":"/notebooks/reconstruct-prices#scatterplots","position":44},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl2":"Scatterplots"},"content":"\n\n# Sample data for scatterplots (performance)\nsample_size = min(50000, len(df))\nsample = df.sample(sample_size, random_state=42)\n\n\n\n","type":"content","url":"/notebooks/reconstruct-prices#scatterplots","position":45},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl3":"Reconstructed Prices vs Actual Prices","lvl2":"Scatterplots"},"type":"lvl3","url":"/notebooks/reconstruct-prices#reconstructed-prices-vs-actual-prices","position":46},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl3":"Reconstructed Prices vs Actual Prices","lvl2":"Scatterplots"},"content":"\n\nfig, ax = plt.subplots(figsize=(10, 10))\n\nax.scatter(\n    sample[\"price_reconstructed\"],\n    sample[\"price\"],\n    alpha=0.1,\n    s=1,\n)\n\n# Add 45-degree line\nprice_range = [\n    min(sample[\"price\"].min(), sample[\"price_reconstructed\"].min()),\n    max(sample[\"price\"].max(), sample[\"price_reconstructed\"].max()),\n]\nax.plot(price_range, price_range, \"r--\", linewidth=1, label=\"Perfect fit\")\n\nax.set_xlabel(\"Reconstructed Price (EUR/MWh)\")\nax.set_ylabel(\"Actual Price (EUR/MWh)\")\nax.set_title(\"Reconstructed vs Actual Electricity Prices\")\nax.legend()\nax.grid(True, alpha=0.3)\n\n# Add R² annotation\nr2_reconstructed = r2_score(df[\"price\"], df[\"price_reconstructed\"])\nax.text(\n    0.05,\n    0.95,\n    f\"R² = {r2_reconstructed:.3f}\",\n    transform=ax.transAxes,\n    fontsize=12,\n    verticalalignment=\"top\",\n    bbox=dict(boxstyle=\"round\", facecolor=\"wheat\", alpha=0.5),\n)\n\nfig.tight_layout()\nfig.savefig(paths.images_path / \"04_scatter_reconstructed_vs_actual.png\", dpi=150, bbox_inches=\"tight\")\nplt.show()\n\n\n\n\n\nFigure 6:Reconstructed vs Actual Electricity Prices\n\n","type":"content","url":"/notebooks/reconstruct-prices#reconstructed-prices-vs-actual-prices","position":47},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl3":"Residual Load vs Actual Prices","lvl2":"Scatterplots"},"type":"lvl3","url":"/notebooks/reconstruct-prices#residual-load-vs-actual-prices","position":48},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl3":"Residual Load vs Actual Prices","lvl2":"Scatterplots"},"content":"\n\nfig, ax = plt.subplots(figsize=(10, 10))\n\nax.scatter(\n    sample[\"residual_load\"],\n    sample[\"price\"],\n    alpha=0.1,\n    s=1,\n)\n\nax.set_xlabel(\"Residual Load (MW)\")\nax.set_ylabel(\"Actual Price (EUR/MWh)\")\nax.set_title(\"Residual Load vs Electricity Price\")\nax.grid(True, alpha=0.3)\n\n# Add correlation\ncorr = df[\"residual_load\"].corr(df[\"price\"])\nax.text(\n    0.05,\n    0.95,\n    f\"Correlation: {corr:.3f}\",\n    transform=ax.transAxes,\n    fontsize=12,\n    verticalalignment=\"top\",\n    bbox=dict(boxstyle=\"round\", facecolor=\"wheat\", alpha=0.5),\n)\n\nfig.tight_layout()\nfig.savefig(paths.images_path / \"04_scatter_residual_load_vs_price.png\", dpi=150, bbox_inches=\"tight\")\nplt.show()\n\n\n\n\n\nFigure 7:Residual Load vs Electricity Price\n\n","type":"content","url":"/notebooks/reconstruct-prices#residual-load-vs-actual-prices","position":49},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl3":"Fossil Residual Load vs Actual Prices","lvl2":"Scatterplots"},"type":"lvl3","url":"/notebooks/reconstruct-prices#fossil-residual-load-vs-actual-prices","position":50},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl3":"Fossil Residual Load vs Actual Prices","lvl2":"Scatterplots"},"content":"\n\nfig, ax = plt.subplots(figsize=(10, 10))\n\nax.scatter(\n    sample[\"rl_fossil\"],\n    sample[\"price\"],\n    alpha=0.1,\n    s=1,\n)\n\nax.set_xlabel(\"Fossil Residual Load (MW)\")\nax.set_ylabel(\"Actual Price (EUR/MWh)\")\nax.set_title(\"Fossil Residual Load vs Electricity Price\")\nax.grid(True, alpha=0.3)\n\n# Add correlation\ncorr_fossil = df[\"rl_fossil\"].corr(df[\"price\"])\nax.text(\n    0.05,\n    0.95,\n    f\"Correlation: {corr_fossil:.3f}\",\n    transform=ax.transAxes,\n    fontsize=12,\n    verticalalignment=\"top\",\n    bbox=dict(boxstyle=\"round\", facecolor=\"wheat\", alpha=0.5),\n)\n\nfig.tight_layout()\nfig.savefig(paths.images_path / \"04_scatter_fossil_rl_vs_price.png\", dpi=150, bbox_inches=\"tight\")\nplt.show()\n\n\n\n\n\nFigure 8:Fossil Residual Load vs Electricity Price\n\n","type":"content","url":"/notebooks/reconstruct-prices#fossil-residual-load-vs-actual-prices","position":51},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl2":"Variance Explained (R²)"},"type":"lvl2","url":"/notebooks/reconstruct-prices#variance-explained-r","position":52},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl2":"Variance Explained (R²)"},"content":"How much of the price variation is explained by each model?\n\n# Prepare data for regression (drop NaN and infinite values)\ndf_clean = df[[\"price\", \"residual_load\", \"rl_fossil\", \"price_reconstructed\"]].copy()\ndf_clean = df_clean.replace([np.inf, -np.inf], np.nan).dropna()\n\nX_residual = df_clean[[\"residual_load\"]].values\nX_fossil = df_clean[[\"rl_fossil\"]].values\nX_reconstructed = df_clean[[\"price_reconstructed\"]].values\ny = df_clean[\"price\"].values\n\n# Fit linear models\nmodel_residual = LinearRegression().fit(X_residual, y)\nmodel_fossil = LinearRegression().fit(X_fossil, y)\n\n# Calculate R² scores\nr2_residual = model_residual.score(X_residual, y)\nr2_fossil = model_fossil.score(X_fossil, y)\nr2_reconstructed = r2_score(y, df_clean[\"price_reconstructed\"].values)\n\nprint(\"=\" * 60)\nprint(\"VARIANCE EXPLAINED (R²)\")\nprint(\"=\" * 60)\nprint(f\"\\nResidual Load (linear regression):      R² = {r2_residual:.4f}\")\nprint(f\"Fossil Residual Load (linear regression): R² = {r2_fossil:.4f}\")\nprint(f\"Reconstructed Prices (merit order model): R² = {r2_reconstructed:.4f}\")\nprint()\n\n\n\n","type":"content","url":"/notebooks/reconstruct-prices#variance-explained-r","position":53},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl2":"Summary Statistics"},"type":"lvl2","url":"/notebooks/reconstruct-prices#summary-statistics","position":54},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl2":"Summary Statistics"},"content":"\n\n# Calculate additional metrics\nmae = np.abs(df_clean[\"price\"] - df_clean[\"price_reconstructed\"]).mean()\nrmse = np.sqrt(((df_clean[\"price\"] - df_clean[\"price_reconstructed\"]) ** 2).mean())\n\nprint(\"=\" * 60)\nprint(\"MODEL PERFORMANCE SUMMARY\")\nprint(\"=\" * 60)\nprint(f\"\\nMean Absolute Error (MAE):     {mae:.2f} EUR/MWh\")\nprint(f\"Root Mean Square Error (RMSE): {rmse:.2f} EUR/MWh\")\nprint(f\"\\nActual price mean:        {df_clean['price'].mean():.2f} EUR/MWh\")\nprint(f\"Reconstructed price mean: {df_clean['price_reconstructed'].mean():.2f} EUR/MWh\")\nprint()\n\n\n\n","type":"content","url":"/notebooks/reconstruct-prices#summary-statistics","position":55},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl2":"Comparison Chart: What Explains Price Variation?"},"type":"lvl2","url":"/notebooks/reconstruct-prices#comparison-chart-what-explains-price-variation","position":56},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl2":"Comparison Chart: What Explains Price Variation?"},"content":"\n\nfig, ax = plt.subplots(figsize=(10, 6))\n\nmodels = [\"Residual Load\\n(Linear)\", \"Fossil RL\\n(Linear)\", \"Merit Order\\n(Reconstructed)\"]\nr2_values = [r2_residual, r2_fossil, r2_reconstructed]\ncolors = [\"#3498db\", \"#2ecc71\", \"#e74c3c\"]\n\nbars = ax.bar(models, r2_values, color=colors, edgecolor=\"black\", linewidth=1.2)\n\n# Add value labels on bars\nfor bar, val in zip(bars, r2_values):\n    height = bar.get_height()\n    ax.text(\n        bar.get_x() + bar.get_width() / 2.0,\n        height + 0.01,\n        f\"{val:.3f}\",\n        ha=\"center\",\n        va=\"bottom\",\n        fontsize=12,\n        fontweight=\"bold\",\n    )\n\nax.set_ylabel(\"R² (Variance Explained)\")\nax.set_title(\"How Much Price Variation is Explained?\")\nax.set_ylim(0, 1.0)\nax.grid(True, alpha=0.3, axis=\"y\")\n\nfig.tight_layout()\nfig.savefig(paths.images_path / \"04_r2_comparison.png\", dpi=150, bbox_inches=\"tight\")\nplt.show()\n\n\n\n\n\nFigure 9:How Much Price Variation is Explained?","type":"content","url":"/notebooks/reconstruct-prices#comparison-chart-what-explains-price-variation","position":57},{"hierarchy":{"lvl1":"Seasonality Heatmaps"},"type":"lvl1","url":"/notebooks/load-seasonalities","position":0},{"hierarchy":{"lvl1":"Seasonality Heatmaps"},"content":"Heatmaps of hour of day vs day of year reveal the combined diurnal and seasonal\npatterns in generation, load, and prices across Germany’s electricity system.\n\nimport pandas as pd\nimport matplotlib.pyplot as plt\n\nfrom woe.paths import ProjPaths\n\n\n\n# Load all data files\npaths = ProjPaths()\n\nsolar = pd.read_parquet(paths.smard_solar_file)\nwind_onshore = pd.read_parquet(paths.smard_wind_onshore_file)\nwind_offshore = pd.read_parquet(paths.smard_wind_offshore_file)\ntotal_load = pd.read_parquet(paths.smard_total_load_file)\nprices = pd.read_parquet(paths.smard_prices_file)\n\n\n\n# Combine into single DataFrame\ndf = pd.concat([\n    solar.rename(columns={solar.columns[0]: \"solar\"}),\n    wind_onshore.rename(columns={wind_onshore.columns[0]: \"wind_onshore\"}),\n    wind_offshore.rename(columns={wind_offshore.columns[0]: \"wind_offshore\"}),\n    total_load.rename(columns={total_load.columns[0]: \"total_load\"}),\n    prices.rename(columns={prices.columns[0]: \"price\"}),\n], axis=1)\n\ndf = df.dropna()\n\n# Derived columns\ndf[\"renewables\"] = df[\"solar\"] + df[\"wind_onshore\"] + df[\"wind_offshore\"]\ndf[\"residual_load\"] = df[\"total_load\"] - df[\"renewables\"]\ndf[\"wind\"] = df[\"wind_onshore\"] + df[\"wind_offshore\"]\ndf[\"hour\"] = df.index.hour\ndf[\"dayofyear\"] = df.index.dayofyear\n\nprint(f\"Combined data: {len(df)} records\")\nprint(f\"Date range: {df.index.min()} to {df.index.max()}\")\n\n\n\n# Heatmap helper\nmonth_starts = [1, 32, 60, 91, 121, 152, 182, 213, 244, 274, 305, 335]\nmonth_labels = [\"Jan\", \"Feb\", \"Mar\", \"Apr\", \"May\", \"Jun\", \"Jul\", \"Aug\", \"Sep\", \"Oct\", \"Nov\", \"Dec\"]\n\n\ndef plot_heatmap(df, column, title, cmap, unit, diverging=False, save_name=None):\n    \"\"\"Plot a heatmap of hour of day vs day of year.\"\"\"\n    pivot = df.groupby([\"dayofyear\", \"hour\"])[column].mean().unstack(level=0)\n\n    fig, ax = plt.subplots(figsize=(14, 6))\n\n    vmin, vmax = pivot.min().min(), pivot.max().max()\n    if diverging:\n        abs_max = max(abs(vmin), abs(vmax))\n        vmin, vmax = -abs_max, abs_max\n\n    im = ax.pcolormesh(\n        pivot.columns,\n        pivot.index,\n        pivot.values,\n        cmap=cmap,\n        shading=\"auto\",\n        vmin=vmin,\n        vmax=vmax,\n    )\n    cbar = fig.colorbar(im, ax=ax, pad=0.02)\n    cbar.set_label(unit)\n\n    ax.set_xlabel(\"Month\")\n    ax.set_ylabel(\"Hour of Day\")\n    ax.set_title(title)\n    ax.set_xticks(month_starts)\n    ax.set_xticklabels(month_labels)\n    ax.set_yticks(range(0, 24, 3))\n    ax.invert_yaxis()\n\n    fig.tight_layout()\n    if save_name:\n        fig.savefig(paths.images_path / save_name, dpi=150, bbox_inches=\"tight\")\n    plt.show()\n\n\n\n","type":"content","url":"/notebooks/load-seasonalities","position":1},{"hierarchy":{"lvl1":"Seasonality Heatmaps","lvl2":"Solar Generation"},"type":"lvl2","url":"/notebooks/load-seasonalities#solar-generation","position":2},{"hierarchy":{"lvl1":"Seasonality Heatmaps","lvl2":"Solar Generation"},"content":"Solar output peaks around midday in summer months. The heatmap clearly shows\nzero generation at night and the seasonal shift in daylight hours.\n\nplot_heatmap(df, \"solar\", \"Average Solar Generation (Hour vs Day of Year)\", \"YlOrRd\", \"MW\",\n             save_name=\"05_seasonality_solar.png\")\n\n\n\n\n\nFigure 1:Average solar generation by hour of day and day of year\n\n","type":"content","url":"/notebooks/load-seasonalities#solar-generation","position":3},{"hierarchy":{"lvl1":"Seasonality Heatmaps","lvl2":"Wind Generation"},"type":"lvl2","url":"/notebooks/load-seasonalities#wind-generation","position":4},{"hierarchy":{"lvl1":"Seasonality Heatmaps","lvl2":"Wind Generation"},"content":"Wind generation (onshore + offshore) tends to be higher in winter and shows\nless pronounced diurnal patterns compared to solar.\n\nplot_heatmap(df, \"wind\", \"Average Wind Generation (Hour vs Day of Year)\", \"YlGnBu\", \"MW\",\n             save_name=\"05_seasonality_wind.png\")\n\n\n\n\n\nFigure 2:Average wind generation by hour of day and day of year\n\n","type":"content","url":"/notebooks/load-seasonalities#wind-generation","position":5},{"hierarchy":{"lvl1":"Seasonality Heatmaps","lvl2":"Aggregate Renewable Generation"},"type":"lvl2","url":"/notebooks/load-seasonalities#aggregate-renewable-generation","position":6},{"hierarchy":{"lvl1":"Seasonality Heatmaps","lvl2":"Aggregate Renewable Generation"},"content":"The combined solar and wind heatmap reveals the complementary nature of these\nsources: solar dominates summer midday, wind dominates winter.\n\nplot_heatmap(df, \"renewables\", \"Average Renewable Generation (Hour vs Day of Year)\", \"YlGn\", \"MW\",\n             save_name=\"05_seasonality_renewables.png\")\n\n\n\n\n\nFigure 3:Average aggregate renewable generation by hour of day and day of year\n\n","type":"content","url":"/notebooks/load-seasonalities#aggregate-renewable-generation","position":7},{"hierarchy":{"lvl1":"Seasonality Heatmaps","lvl2":"Electricity Load"},"type":"lvl2","url":"/notebooks/load-seasonalities#electricity-load","position":8},{"hierarchy":{"lvl1":"Seasonality Heatmaps","lvl2":"Electricity Load"},"content":"Load follows a clear double-peak pattern (morning and evening) with lower\ndemand on summer middays and overnight. Winter months show higher overall load.\n\nplot_heatmap(df, \"total_load\", \"Average Electricity Load (Hour vs Day of Year)\", \"inferno\", \"MW\",\n             save_name=\"05_seasonality_load.png\")\n\n\n\n\n\nFigure 4:Average electricity load by hour of day and day of year\n\n","type":"content","url":"/notebooks/load-seasonalities#electricity-load","position":9},{"hierarchy":{"lvl1":"Seasonality Heatmaps","lvl2":"Residual Load"},"type":"lvl2","url":"/notebooks/load-seasonalities#residual-load","position":10},{"hierarchy":{"lvl1":"Seasonality Heatmaps","lvl2":"Residual Load"},"content":"The residual load heatmap highlights when conventional generation is most needed\n(red) and when renewable surpluses occur (blue). Negative values in summer\nmidday reflect solar overproduction.\n\nplot_heatmap(df, \"residual_load\", \"Average Residual Load (Hour vs Day of Year)\", \"RdBu_r\", \"MW\",\n             diverging=True, save_name=\"05_seasonality_residual_load.png\")\n\n\n\n\n\nFigure 5:Average residual load by hour of day and day of year\n\n","type":"content","url":"/notebooks/load-seasonalities#residual-load","position":11},{"hierarchy":{"lvl1":"Seasonality Heatmaps","lvl2":"Electricity Price"},"type":"lvl2","url":"/notebooks/load-seasonalities#electricity-price","position":12},{"hierarchy":{"lvl1":"Seasonality Heatmaps","lvl2":"Electricity Price"},"content":"Price patterns mirror residual load closely. Low or negative prices appear\nduring summer midday (solar surplus), while winter evening peaks drive the\nhighest prices.\n\nplot_heatmap(df, \"price\", \"Average Electricity Price (Hour vs Day of Year)\", \"RdBu_r\", \"EUR/MWh\",\n             diverging=True, save_name=\"05_seasonality_price.png\")\n\n\n\n\n\nFigure 6:Average electricity price by hour of day and day of year\n\nfrom datetime import datetime\nfrom IPython.display import Markdown\n\nMarkdown(f\"Last run: {datetime.now().strftime('%Y-%m-%d')}\")\n\n","type":"content","url":"/notebooks/load-seasonalities#electricity-price","position":13},{"hierarchy":{"lvl1":"Earth’s Seasons — From Sunlight to Vegetation"},"type":"lvl1","url":"/notebooks/earth-seasons","position":0},{"hierarchy":{"lvl1":"Earth’s Seasons — From Sunlight to Vegetation"},"content":"Why do we have seasons? The answer lies in a single geometric fact: the\nEarth’s rotation axis is tilted by about 23.4° relative to the plane of\nits orbit around the Sun. As the Earth travels along its annual orbit, this\ntilt causes different hemispheres to lean toward or away from the Sun,\nchanging both the angle at which sunlight strikes the surface and the\nnumber of hours of daylight each location receives.\n\nThis chapter traces the chain of consequences:\n\nSunlight geometry — how the Sun illuminates different parts of the\nEarth during the day, and how this pattern shifts between summer and winter.\n\nThe subsolar point — the latitude where the Sun is directly overhead,\nand how it migrates between the Tropics over the year.\n\nSolar elevation — the angle of the Sun above the horizon for any\nlocation and time, which determines how concentrated the incoming energy is.\n\nTemperature — how the uneven distribution of sunlight drives the\nglobal temperature pattern, both over the course of a day and across seasons.\n\nVegetation — how the resulting temperature and moisture patterns\ncontrol where and when vegetation grows, visible from space as a seasonal\n“green wave”.\n\nimport calendar\nimport math\nimport os\nfrom datetime import datetime, date, timedelta\n\nimport numpy as np\nimport matplotlib.pyplot as plt\nimport cartopy.crs as ccrs\nimport cartopy.feature as cfeature\nfrom cartopy.feature.nightshade import Nightshade\nfrom matplotlib.animation import FuncAnimation, PillowWriter\nfrom PIL import Image, ImageDraw\n\nfrom woe.paths import ProjPaths\n\npaths = ProjPaths()\n\n\n\n","type":"content","url":"/notebooks/earth-seasons","position":1},{"hierarchy":{"lvl1":"Earth’s Seasons — From Sunlight to Vegetation","lvl2":"Sunlight on Earth — the day cycle"},"type":"lvl2","url":"/notebooks/earth-seasons#sunlight-on-earth-the-day-cycle","position":2},{"hierarchy":{"lvl1":"Earth’s Seasons — From Sunlight to Vegetation","lvl2":"Sunlight on Earth — the day cycle"},"content":"At any given moment, exactly half of the Earth is illuminated by the Sun.\nBut the angle at which sunlight arrives varies enormously by latitude and\ntime of day. Near the equator, sunlight can arrive nearly vertically,\nconcentrating its energy on a small area. Near the poles, it arrives at a\nshallow angle, spreading the same energy over a much larger area — which\nis why polar regions are cold even when they receive 24 hours of daylight in\nsummer.\n\nThe two animations below show the illumination pattern over 24 hours on\nthe summer solstice (June 21) and the winter solstice (December 21).\nThe contrast is striking: in June, the North Pole enjoys continuous daylight\nwhile the South Pole is in complete darkness. In December, the situation is\nreversed.\n\ndates = [datetime(2025, 6, 21), datetime(2025, 12, 21)]\nn_frames = 64\nframe_hours = np.linspace(0, 24, n_frames, endpoint=False)\n\n\ndef create_sunlight_animation(anim_date, output_path):\n    fig, ax = plt.subplots(figsize=(16, 9), subplot_kw={\"projection\": ccrs.Robinson()})\n    fig.patch.set_facecolor(\"black\")\n\n    def draw_frame(fractional_hour):\n        ax.clear()\n        h = int(fractional_hour)\n        m = int((fractional_hour - h) * 60)\n        obs_time = datetime(anim_date.year, anim_date.month, anim_date.day, h, m, 0)\n\n        # Solar geometry\n        day_of_year = obs_time.timetuple().tm_yday\n        declination = 23.44 * np.sin(np.radians(360 / 365 * (day_of_year - 81)))\n        hours_utc = obs_time.hour + obs_time.minute / 60\n        subsolar_lon = 180 - (hours_utc / 24) * 360\n\n        ax.stock_img()\n        ax.add_feature(Nightshade(obs_time, alpha=0.4))\n\n        # Subsolar point marker\n        ax.plot(\n            subsolar_lon, declination,\n            marker=\"*\", markersize=18, color=\"yellow\", markeredgecolor=\"orange\",\n            markeredgewidth=0.8, transform=ccrs.PlateCarree(), zorder=10,\n        )\n\n        # Declination latitude line\n        ax.plot(\n            [-180, 180], [declination, declination],\n            color=\"yellow\", linewidth=1.2, linestyle=\"--\", alpha=0.7,\n            transform=ccrs.PlateCarree(), zorder=9,\n        )\n        # Equator\n        ax.plot(\n            [-180, 180], [0, 0],\n            color=\"white\", linewidth=0.6, linestyle=\":\", alpha=0.5,\n            transform=ccrs.PlateCarree(), zorder=9,\n        )\n\n        ax.add_feature(cfeature.COASTLINE, linewidth=0.4, color=\"0.3\")\n        ax.set_global()\n        ax.set_facecolor(\"black\")\n        ax.set_title(\n            f\"Sunlight on Earth — {obs_time:%Y-%m-%d %H:%M} UTC — \"\n            f\"Subsolar point {declination:.1f}°N, {subsolar_lon:.1f}°E\",\n            fontsize=13, color=\"white\", pad=12,\n        )\n\n    anim = FuncAnimation(fig, draw_frame, frames=list(frame_hours), interval=1000 / 15)\n    anim.save(str(output_path), writer=PillowWriter(fps=15), dpi=120, savefig_kwargs={\"facecolor\": \"black\"})\n    plt.close(fig)\n    print(f\"Saved animation to {output_path}\")\n\n\nfor d in dates:\n    suffix = f\"{d:%Y_%m_%d}\"\n    create_sunlight_animation(d, paths.images_path / f\"10_sunlight_animation_{suffix}.gif\")\n\n\n\n\n\nFigure 1:Sunlight on Earth over 24 hours on 2025-06-21 (summer solstice). The yellow\nstar marks the subsolar point; the dashed line shows the solar declination\nlatitude (~23.4°N). Notice that the Arctic never enters darkness.\n\n\n\nFigure 2:Winter solstice (2025-12-21). The subsolar point has moved to ~23.4°S.\nNow it is the Antarctic that enjoys continuous daylight, while the Arctic\nremains in polar night.\n\n","type":"content","url":"/notebooks/earth-seasons#sunlight-on-earth-the-day-cycle","position":3},{"hierarchy":{"lvl1":"Earth’s Seasons — From Sunlight to Vegetation","lvl2":"The subsolar point and its annual migration"},"type":"lvl2","url":"/notebooks/earth-seasons#the-subsolar-point-and-its-annual-migration","position":4},{"hierarchy":{"lvl1":"Earth’s Seasons — From Sunlight to Vegetation","lvl2":"The subsolar point and its annual migration"},"content":"The subsolar point is the location on Earth where the Sun is directly\noverhead — i.e. the solar elevation is exactly 90°. Its latitude equals the\nsolar declination, which can be approximated as:\\delta = 23.44° \\times \\sin\\!\\left(\\frac{360°}{365} \\times (d - 81)\\right)\n\nwhere d is the day of the year (so d = 81 corresponds to the spring\nequinox around March 22, when \\delta = 0).\n\nOver the course of a year, the subsolar latitude oscillates between the\nTropic of Cancer (~23.4°N, around June 21) and the Tropic of\nCapricorn (~23.4°S, around December 21). The animation below shows one\nframe per week, tracing this migration at solar noon (12:00 UTC).\n\nweeks = np.arange(0, 52)\nweek_dates = [datetime(2025, 1, 1) + timedelta(weeks=int(w)) for w in weeks]\n\nfig, ax = plt.subplots(figsize=(16, 9), subplot_kw={\"projection\": ccrs.Robinson()})\nfig.patch.set_facecolor(\"black\")\n\n\ndef draw_subsolar_frame(i):\n    ax.clear()\n    d = week_dates[i]\n    obs_time = datetime(d.year, d.month, d.day, 12, 0, 0)\n\n    day_of_year = obs_time.timetuple().tm_yday\n    declination = 23.44 * np.sin(np.radians(360 / 365 * (day_of_year - 81)))\n    subsolar_lon = 0.0  # at 12:00 UTC\n\n    ax.stock_img()\n    ax.add_feature(Nightshade(obs_time, alpha=0.3))\n\n    # Declination latitude line\n    ax.plot(\n        [-180, 180], [declination, declination],\n        color=\"yellow\", linewidth=2, linestyle=\"--\", alpha=0.9,\n        transform=ccrs.PlateCarree(), zorder=9,\n    )\n    # Subsolar point\n    ax.plot(\n        subsolar_lon, declination,\n        marker=\"*\", markersize=20, color=\"yellow\", markeredgecolor=\"orange\",\n        markeredgewidth=0.8, transform=ccrs.PlateCarree(), zorder=10,\n    )\n\n    # Tropic lines\n    for tropic_lat in [23.44, -23.44]:\n        ax.plot(\n            [-180, 180], [tropic_lat, tropic_lat],\n            color=\"white\", linewidth=0.5, linestyle=\":\", alpha=0.4,\n            transform=ccrs.PlateCarree(), zorder=8,\n        )\n    # Equator\n    ax.plot(\n        [-180, 180], [0, 0],\n        color=\"white\", linewidth=0.6, linestyle=\":\", alpha=0.5,\n        transform=ccrs.PlateCarree(), zorder=8,\n    )\n\n    ax.add_feature(cfeature.COASTLINE, linewidth=0.4, color=\"0.3\")\n    ax.set_global()\n    ax.set_facecolor(\"black\")\n    ax.set_title(\n        f\"Subsolar Latitude — {obs_time:%Y-%m-%d} (week {i + 1}/52) — \"\n        f\"Declination {declination:.1f}°{'N' if declination >= 0 else 'S'}\",\n        fontsize=13, color=\"white\", pad=12,\n    )\n\n\nanim = FuncAnimation(fig, draw_subsolar_frame, frames=len(week_dates), interval=1000 / 15)\noutput_file = paths.images_path / \"10_subsolar_migration.gif\"\nanim.save(str(output_file), writer=PillowWriter(fps=15), dpi=120, savefig_kwargs={\"facecolor\": \"black\"})\nplt.close(fig)\nprint(f\"Saved animation to {output_file}\")\n\n\n\n\n\nFigure 3:Migration of the subsolar latitude over the year (one frame per week). The\nyellow dashed line shows where the Sun is directly overhead at noon UTC. It\noscillates between the Tropic of Cancer (~23.4°N in June) and the Tropic of\nCapricorn (~23.4°S in December).\n\n","type":"content","url":"/notebooks/earth-seasons#the-subsolar-point-and-its-annual-migration","position":5},{"hierarchy":{"lvl1":"Earth’s Seasons — From Sunlight to Vegetation","lvl2":"Solar elevation — the Sun’s angle above the horizon"},"type":"lvl2","url":"/notebooks/earth-seasons#solar-elevation-the-suns-angle-above-the-horizon","position":6},{"hierarchy":{"lvl1":"Earth’s Seasons — From Sunlight to Vegetation","lvl2":"Solar elevation — the Sun’s angle above the horizon"},"content":"The solar elevation (or altitude angle) is the angle of the Sun above\nthe horizon, measured from 0° (sunrise/sunset) to 90° (directly overhead).\nIt determines how much energy a square metre of surface receives: a high\nSun concentrates light into a small area, while a low Sun spreads it thin.\n\nFor any location (latitude \\varphi) and time, the elevation \\alpha is:\\sin(\\alpha) = \\sin(\\varphi)\\,\\sin(\\delta) + \\cos(\\varphi)\\,\\cos(\\delta)\\,\\cos(h)\n\nwhere \\delta is the solar declination (computed above) and h is the\nhour angle — the Sun’s angular displacement from local solar noon\n(h = 0 at noon, 15° per hour).\n\nThe heatmaps below show solar elevation for every day of the year and every\nminute of the day, for two cities at very different latitudes: Munich\n(48.1°N) and Sydney (33.9°S). Grey areas indicate nighttime (elevation\nbelow 0°).\n\nlocations = [\n    {\"name\": \"Munich\", \"lat\": 48.14, \"lon\": 11.58, \"utc_offset\": 1, \"tz_label\": \"CET\"},\n    {\"name\": \"Sydney\", \"lat\": -33.87, \"lon\": 151.21, \"utc_offset\": 11, \"tz_label\": \"AEDT\"},\n]\n\ndays = np.arange(1, 366)\nhours_of_day = np.arange(0, 24, 1 / 60)  # one-minute resolution\nday_grid, hour_grid = np.meshgrid(days, hours_of_day)\n\n# Solar declination (same for all locations)\ndeclination_rad = np.radians(\n    23.44 * np.sin(np.radians(360 / 365 * (day_grid - 81)))\n)\n\nmonth_starts = [1, 32, 60, 91, 121, 152, 182, 213, 244, 274, 305, 335]\nmonth_labels = [\"Jan\", \"Feb\", \"Mar\", \"Apr\", \"May\", \"Jun\",\n                \"Jul\", \"Aug\", \"Sep\", \"Oct\", \"Nov\", \"Dec\"]\n\nfor loc in locations:\n    lat_rad = np.radians(loc[\"lat\"])\n\n    local_hours = hours_of_day\n    utc_hours = local_hours - loc[\"utc_offset\"]\n    day_grid_loc, utc_hour_grid = np.meshgrid(days, utc_hours)\n    _, local_hour_grid = np.meshgrid(days, local_hours)\n\n    # Hour angle: sun's angular displacement from solar noon\n    solar_hour = utc_hour_grid + loc[\"lon\"] / 15\n    hour_angle_rad = np.radians(15 * (solar_hour - 12))\n\n    # Solar elevation\n    sin_elev = (\n        np.sin(lat_rad) * np.sin(declination_rad)\n        + np.cos(lat_rad) * np.cos(declination_rad) * np.cos(hour_angle_rad)\n    )\n    elevation_deg = np.degrees(np.arcsin(np.clip(sin_elev, -1, 1)))\n    elevation_deg = np.where(elevation_deg < 0, np.nan, elevation_deg)\n\n    fig, ax = plt.subplots(figsize=(14, 6))\n\n    cmap = plt.cm.YlOrRd.copy()\n    cmap.set_bad(\"0.15\")\n\n    im = ax.pcolormesh(\n        day_grid_loc, local_hour_grid, elevation_deg,\n        cmap=cmap, vmin=0, vmax=70, shading=\"auto\",\n    )\n\n    cb = fig.colorbar(im, ax=ax, pad=0.02)\n    cb.set_label(\"Solar elevation (°)\", fontsize=11)\n\n    ax.set_xticks(month_starts)\n    ax.set_xticklabels(month_labels)\n    ax.set_yticks(range(0, 25, 3))\n    ax.set_ylabel(f\"Hour of day ({loc['tz_label']}, UTC{loc['utc_offset']:+d})\", fontsize=11)\n    ax.set_xlabel(\"Day of year\", fontsize=11)\n    ax.set_title(\n        f\"Solar Elevation — {loc['name']} ({abs(loc['lat']):.1f}°{'N' if loc['lat'] >= 0 else 'S'}, \"\n        f\"{abs(loc['lon']):.1f}°{'E' if loc['lon'] >= 0 else 'W'})\",\n        fontsize=13,\n    )\n\n    fig.tight_layout()\n    filename = f\"10_elevation_heatmap_{loc['name'].lower()}.png\"\n    fig.savefig(paths.images_path / filename, dpi=150, bbox_inches=\"tight\")\n    plt.show()\n\n\n\n\n\nFigure 4:Solar elevation at Munich (48.1°N, 11.6°E) for every day and minute of\nthe year. In summer, the Sun reaches ~65° and daylight lasts over 16 hours.\nIn winter, the maximum elevation drops to ~18° with less than 8 hours of\ndaylight. Grey areas indicate nighttime.\n\n\n\nFigure 5:Solar elevation at Sydney (33.9°S, 151.2°E). Being in the Southern\nHemisphere, Sydney’s seasons are inverted — longest days around December,\nshortest in June. The higher maximum elevation (~80°) reflects its lower\nlatitude compared to Munich, and the seasonal daylight variation is less\nextreme.\n\n","type":"content","url":"/notebooks/earth-seasons#solar-elevation-the-suns-angle-above-the-horizon","position":7},{"hierarchy":{"lvl1":"Earth’s Seasons — From Sunlight to Vegetation","lvl2":"Global temperatures — the diurnal cycle"},"type":"lvl2","url":"/notebooks/earth-seasons#global-temperatures-the-diurnal-cycle","position":8},{"hierarchy":{"lvl1":"Earth’s Seasons — From Sunlight to Vegetation","lvl2":"Global temperatures — the diurnal cycle"},"content":"The varying sunlight intensity directly drives temperature patterns across\nthe globe. To observe this, we use ERA5 reanalysis data — a global\ngridded dataset produced by the European Centre for Medium-Range Weather\nForecasts (ECMWF) that combines weather observations with numerical models.\nThe variable shown is 2-metre temperature (the air temperature at 2 m\nabove the surface), which is the standard measure of surface air temperature.\n\nNote that this dataset is ERA5-Land, which only covers land surfaces —\noceans appear black (no data). A key feature visible in the animation is how\nquickly continents heat and cool: land has a low heat capacity, so\ntemperatures swing sharply between day and night. Oceans, by contrast, change\ntemperature much more slowly, which is why coastal cities have milder\nclimates than continental interiors.\n\nimport ee\nimport geemap\nfrom dotenv import load_dotenv\n\nload_dotenv()\nee.Initialize(project=os.environ[\"EE_GCP_PROJECT_ID\"])\n\n\n\n\n\nera5 = ee.ImageCollection(\"ECMWF/ERA5_LAND/HOURLY\").select(\"temperature_2m\")\n\nstart = \"2024-01-01\"\nend = \"2025-01-01\"\nera5_year = era5.filterDate(start, end)\n\n# Build a 24-image collection: one mean image per UTC hour\nhourly_images = []\nfor hour in range(24):\n    hourly_mean = (\n        era5_year\n        .filter(ee.Filter.calendarRange(hour, hour, \"hour\"))\n        .mean()\n        .subtract(273.15)  # K -> °C\n    )\n    hourly_mean = hourly_mean.set(\"hour\", hour).set(\"label\", f\"{hour:02d}:00 UTC\")\n    hourly_images.append(hourly_mean)\n\ncol = ee.ImageCollection(hourly_images)\nprint(f\"Collection size: {col.size().getInfo()} images\")\n\n\n\n\n\nvis_params = {\n    \"min\": -40,\n    \"max\": 40,\n    \"palette\": [\n        \"#313695\", \"#4575b4\", \"#74add1\", \"#abd9e9\",\n        \"#e0f3f8\", \"#ffffbf\", \"#fee090\", \"#fdae61\",\n        \"#f46d43\", \"#d73027\", \"#a50026\",\n    ],\n    \"dimensions\": 800,\n    \"framesPerSecond\": 3,\n}\n\ngif_path = str(paths.images_path / \"10_ee_temperature_by_hour.gif\")\n\ngeemap.download_ee_video(col, vis_params, gif_path)\nprint(f\"GIF saved to {gif_path}\")\n\n\n\n\n\nlabels = [f\"{h:02d}:00 UTC\" for h in range(24)]\n\ngeemap.add_text_to_gif(\n    gif_path,\n    gif_path,\n    xy=(\"5%\", \"90%\"),\n    text_sequence=labels,\n    font_size=20,\n    font_color=\"white\",\n    add_progress_bar=True,\n    progress_bar_color=\"cyan\",\n    progress_bar_height=5,\n)\nprint(f\"Annotated GIF saved to {gif_path}\")\n\n\n\n\n\nFigure 6:Average 2-metre temperature by hour of day (UTC), computed from a full year\nof ERA5-Land reanalysis data. The “heat wave” sweeps westward as the Sun\nmoves, and the large day-night temperature swing over continents is clearly\nvisible. Oceans appear black because ERA5-Land only covers land surfaces.\n\n","type":"content","url":"/notebooks/earth-seasons#global-temperatures-the-diurnal-cycle","position":9},{"hierarchy":{"lvl1":"Earth’s Seasons — From Sunlight to Vegetation","lvl2":"Global temperatures — the seasonal cycle"},"type":"lvl2","url":"/notebooks/earth-seasons#global-temperatures-the-seasonal-cycle","position":10},{"hierarchy":{"lvl1":"Earth’s Seasons — From Sunlight to Vegetation","lvl2":"Global temperatures — the seasonal cycle"},"content":"Over the course of months, the sustained difference in sunlight between\nhemispheres creates the familiar seasons. Note that temperature extremes\ntypically lag the solstices by about 4–6 weeks — this thermal lag occurs\nbecause the Earth’s surface and atmosphere take time to heat up and cool\ndown, similar to how the hottest part of the day is usually mid-afternoon\nrather than noon.\n\nThe ocean again plays a moderating role: maritime and coastal climates have\nmilder seasonal swings, while continental interiors (like Siberia or central\nCanada) experience the most extreme temperature differences between summer\nand winter.\n\nmonthly_images = []\nmonthly_labels = []\nfor month in range(1, 13):\n    month_slices = []\n    for year in range(2022, 2025):\n        days_in_month = calendar.monthrange(year, month)[1]\n        m_start = f\"{year}-{month:02d}-01\"\n        m_end = f\"{year}-{month:02d}-{days_in_month:02d}T23:59\"\n        month_slices.append(\n            era5.filterDate(m_start, m_end)\n            .filter(ee.Filter.calendarRange(12, 12, \"hour\"))\n        )\n    merged = month_slices[0]\n    for s in month_slices[1:]:\n        merged = merged.merge(s)\n    monthly_mean = merged.mean().subtract(273.15)\n    label = calendar.month_abbr[month]\n    monthly_mean = monthly_mean.set(\"month\", month).set(\"label\", label)\n    monthly_images.append(monthly_mean)\n    monthly_labels.append(label)\n\ncol_monthly = ee.ImageCollection(monthly_images)\nprint(f\"Monthly collection size: {col_monthly.size().getInfo()} images\")\n\n\n\n\n\nvis_params_monthly = {\n    \"min\": -40,\n    \"max\": 40,\n    \"palette\": [\n        \"#313695\", \"#4575b4\", \"#74add1\", \"#abd9e9\",\n        \"#e0f3f8\", \"#ffffbf\", \"#fee090\", \"#fdae61\",\n        \"#f46d43\", \"#d73027\", \"#a50026\",\n    ],\n    \"dimensions\": 600,\n    \"framesPerSecond\": 1,\n}\n\ngif_monthly_path = str(paths.images_path / \"10_ee_temperature_by_month.gif\")\n\ngeemap.download_ee_video(col_monthly, vis_params_monthly, gif_monthly_path)\nprint(f\"Monthly GIF saved to {gif_monthly_path}\")\n\n\n\n\n\ngeemap.add_text_to_gif(\n    gif_monthly_path,\n    gif_monthly_path,\n    xy=(\"5%\", \"90%\"),\n    text_sequence=monthly_labels,\n    font_size=20,\n    font_color=\"white\",\n    add_progress_bar=True,\n    progress_bar_color=\"cyan\",\n    progress_bar_height=5,\n)\nprint(f\"Annotated monthly GIF saved to {gif_monthly_path}\")\n\n\n\n\n\nFigure 7:Average 2-metre temperature by month, computed from ERA5-Land noon snapshots\nacross 2022–2024. The hemispheric temperature contrast shifts as the\nsubsolar latitude migrates. Continental interiors show the most extreme\nseasonal swings. Oceans are not shown (ERA5-Land covers land only).\n\n","type":"content","url":"/notebooks/earth-seasons#global-temperatures-the-seasonal-cycle","position":11},{"hierarchy":{"lvl1":"Earth’s Seasons — From Sunlight to Vegetation","lvl2":"Vegetation — the seasonal green wave"},"type":"lvl2","url":"/notebooks/earth-seasons#vegetation-the-seasonal-green-wave","position":12},{"hierarchy":{"lvl1":"Earth’s Seasons — From Sunlight to Vegetation","lvl2":"Vegetation — the seasonal green wave"},"content":"The temperature and moisture patterns driven by the Sun’s position have a\ndirect and visible impact on vegetation. We can observe this from space\nusing the Normalized Difference Vegetation Index (NDVI), computed from\nsatellite imagery as:\\text{NDVI} = \\frac{\\text{NIR} - \\text{Red}}{\\text{NIR} + \\text{Red}}\n\nwhere NIR is near-infrared reflectance and Red is visible red reflectance.\nHealthy green vegetation strongly reflects near-infrared light (which\nit doesn’t need) and absorbs red light (which it uses for\nphotosynthesis). This makes NDVI a reliable indicator of vegetation health:\n\nNDVI > 0.6 — dense, healthy vegetation (tropical forests, croplands\nin growing season)\n\nNDVI 0.2–0.6 — moderate vegetation (grasslands, sparse forests)\n\nNDVI < 0.1 — bare soil, water, snow, or desert\n\nWe use MODIS Terra 16-day NDVI composites (MOD13A2, 1 km resolution)\nto build a multi-year median for each 16-day period, producing ~23 frames\nthat reveal the seasonal “green wave”. The wave tracks the subsolar latitude\n— as warmth and moisture arrive, vegetation pulses to life. We overlay the\nsubsolar declination line (yellow dashed) to make this connection visible.\n\nndvi_col = ee.ImageCollection(\"MODIS/061/MOD13A2\").select(\"NDVI\")\n\nndvi_col = ndvi_col.map(\n    lambda img: img.set(\n        \"doy\", ee.Date(img.get(\"system:time_start\")).getRelative(\"day\", \"year\")\n    )\n)\n\n# Use one year as the DOY template (23 composites, every 16 days)\ndistinct_doy = ndvi_col.filterDate(\"2020-01-01\", \"2021-01-01\")\n\n# Join all years by matching DOY, then take the median\njoin_filter = ee.Filter.equals(leftField=\"doy\", rightField=\"doy\")\njoin = ee.Join.saveAll(\"doy_matches\")\njoined = ee.ImageCollection(join.apply(distinct_doy, ndvi_col, join_filter))\n\nndvi_composites = joined.map(\n    lambda img: (\n        ee.ImageCollection.fromImages(img.get(\"doy_matches\"))\n        .reduce(ee.Reducer.median())\n        .rename(\"NDVI\")\n        .copyProperties(img, [\"doy\", \"system:time_start\"])\n    )\n)\n\nprint(f\"NDVI composites: {ndvi_composites.size().getInfo()} frames\")\n\n\n\n\n\nndvi_vis = {\n    \"min\": 0,\n    \"max\": 9000,\n    \"palette\": [\n        \"FFFFFF\", \"CE7E45\", \"DF923D\", \"F1B555\", \"FCD163\", \"99B718\", \"74A901\",\n        \"66A000\", \"529400\", \"3E8601\", \"207401\", \"056201\", \"004C00\", \"023B01\",\n        \"012E01\", \"011D01\", \"011301\",\n    ],\n}\n\nndvi_rgb = ndvi_composites.map(lambda img: img.visualize(**ndvi_vis))\n\ngif_ndvi_params = {\n    \"dimensions\": 600,\n    \"framesPerSecond\": 4,\n}\n\ngif_ndvi_path = str(paths.images_path / \"10_ee_ndvi_by_doy.gif\")\n\ngeemap.download_ee_video(ndvi_rgb, gif_ndvi_params, gif_ndvi_path)\nprint(f\"NDVI GIF saved to {gif_ndvi_path}\")\n\n\n\n\n\ndoy_list = list(range(1, 366, 16))  # 1, 17, 33, ...\nndvi_labels = [\n    (date(2024, 1, 1) + timedelta(days=d - 1)).strftime(\"%b %d\")\n    for d in doy_list\n]\n\ngeemap.add_text_to_gif(\n    gif_ndvi_path,\n    gif_ndvi_path,\n    xy=(\"5%\", \"90%\"),\n    text_sequence=ndvi_labels,\n    font_size=20,\n    font_color=\"white\",\n    add_progress_bar=True,\n    progress_bar_color=\"green\",\n    progress_bar_height=5,\n)\nprint(f\"Annotated NDVI GIF saved to {gif_ndvi_path}\")\n\n\n\n","type":"content","url":"/notebooks/earth-seasons#vegetation-the-seasonal-green-wave","position":13},{"hierarchy":{"lvl1":"Earth’s Seasons — From Sunlight to Vegetation","lvl3":"Subsolar latitude overlay","lvl2":"Vegetation — the seasonal green wave"},"type":"lvl3","url":"/notebooks/earth-seasons#subsolar-latitude-overlay","position":14},{"hierarchy":{"lvl1":"Earth’s Seasons — From Sunlight to Vegetation","lvl3":"Subsolar latitude overlay","lvl2":"Vegetation — the seasonal green wave"},"content":"To highlight the connection between the Sun’s position and vegetation, we\ndraw the subsolar declination latitude as a yellow dashed line on each frame.\n\nglobal_lat_min, global_lat_max = -90, 90\n\n\ndef solar_declination(doy: int) -> float:\n    \"\"\"Solar declination in degrees for a given day-of-year.\"\"\"\n    return 23.44 * math.sin(math.radians(360 / 365 * (doy - 81)))\n\n\ndef add_subsolar_line(gif_in_path, lat_min, lat_max):\n    \"\"\"Add a dashed yellow subsolar-latitude line to each frame of a GIF.\"\"\"\n    gif = Image.open(gif_in_path)\n    frames = []\n    durations = []\n    frame_idx = 0\n\n    try:\n        while True:\n            frame = gif.copy().convert(\"RGBA\")\n            draw = ImageDraw.Draw(frame)\n            w, h = frame.size\n\n            doy = doy_list[frame_idx % len(doy_list)]\n            decl = solar_declination(doy)\n            y = int((lat_max - decl) / (lat_max - lat_min) * h)\n\n            dash_len, gap_len = 12, 6\n            x = 0\n            while x < w:\n                draw.line([(x, y), (min(x + dash_len, w), y)], fill=\"yellow\", width=2)\n                x += dash_len + gap_len\n\n            frames.append(frame)\n            durations.append(gif.info.get(\"duration\", 250))\n            frame_idx += 1\n            gif.seek(gif.tell() + 1)\n    except EOFError:\n        pass\n\n    frames[0].save(\n        gif_in_path,\n        save_all=True,\n        append_images=frames[1:],\n        duration=durations,\n        loop=0,\n    )\n\n\nadd_subsolar_line(gif_ndvi_path, global_lat_min, global_lat_max)\nprint(f\"Subsolar line added to {gif_ndvi_path}\")\n\n\n\n\n\nFigure 8:Global NDVI seasonal cycle (multi-year median of MODIS Terra 16-day\ncomposites). The yellow dashed line marks the subsolar latitude. Vegetation\ngreens up in each hemisphere’s spring/summer, closely tracking the Sun’s\nposition. The boreal forest “green wave” sweeping northward in May–June is\none of the most visible seasonal changes on Earth.\n\n","type":"content","url":"/notebooks/earth-seasons#subsolar-latitude-overlay","position":15},{"hierarchy":{"lvl1":"Earth’s Seasons — From Sunlight to Vegetation","lvl2":"Vegetation — Africa close-up"},"type":"lvl2","url":"/notebooks/earth-seasons#vegetation-africa-close-up","position":16},{"hierarchy":{"lvl1":"Earth’s Seasons — From Sunlight to Vegetation","lvl2":"Vegetation — Africa close-up"},"content":"Africa straddles both tropics, making it an ideal region to observe the\nseasonal vegetation pulse. The most dramatic change occurs in the Sahel\n— the semi-arid transition zone between the Sahara and the tropical savannas.\nDuring the West African monsoon (approximately June–September), moisture\nfrom the Gulf of Guinea pushes northward, triggering a rapid greening of the\nSahel. This vegetation pulse closely follows the northward migration of the\nsubsolar latitude and retreats as the Sun moves south again.\n\nafrica = ee.Geometry.Rectangle([-20, -35, 55, 38])\n\nndvi_rgb_africa = ndvi_composites.map(\n    lambda img: img.visualize(**ndvi_vis).clip(africa)\n)\n\ngif_ndvi_africa_params = {\n    \"dimensions\": 800,\n    \"framesPerSecond\": 4,\n    \"region\": africa,\n}\n\ngif_ndvi_africa_path = str(paths.images_path / \"10_ee_ndvi_africa_by_doy.gif\")\n\ngeemap.download_ee_video(ndvi_rgb_africa, gif_ndvi_africa_params, gif_ndvi_africa_path)\nprint(f\"NDVI Africa GIF saved to {gif_ndvi_africa_path}\")\n\n\n\n\n\ngeemap.add_text_to_gif(\n    gif_ndvi_africa_path,\n    gif_ndvi_africa_path,\n    xy=(\"5%\", \"90%\"),\n    text_sequence=ndvi_labels,\n    font_size=20,\n    font_color=\"white\",\n    add_progress_bar=True,\n    progress_bar_color=\"green\",\n    progress_bar_height=5,\n)\nprint(f\"Annotated NDVI Africa GIF saved to {gif_ndvi_africa_path}\")\n\n\n\n\n\nadd_subsolar_line(gif_ndvi_africa_path, lat_min=-35, lat_max=38)\nprint(f\"Subsolar line added to {gif_ndvi_africa_path}\")\n\n\n\n\n\nFigure 9:NDVI seasonal cycle over Africa. The Sahel’s rapid greening during the\nmonsoon season (June–September) is clearly visible as a band of green\npushing northward, closely following the subsolar latitude (yellow dashed\nline). Southern Africa shows the opposite pattern, greening during the\naustral summer (November–March).","type":"content","url":"/notebooks/earth-seasons#vegetation-africa-close-up","position":17}]}