{"version":"1","records":[{"hierarchy":{"lvl1":"World of energy"},"type":"lvl1","url":"/","position":0},{"hierarchy":{"lvl1":"World of energy"},"content":"List of planned topics:\n\nelectricity markets / prices\n\nweather as driver of residual load\n\nweather forecasting\n\ngrid congestion\n\nbattery storage\n\nbattery optimization","type":"content","url":"/","position":1},{"hierarchy":{"lvl1":"Resources"},"type":"lvl1","url":"/markdown/resources","position":0},{"hierarchy":{"lvl1":"Resources"},"content":"Capture prices as published by \n\nNetztransparenz:","type":"content","url":"/markdown/resources","position":1},{"hierarchy":{"lvl1":"Resources","lvl2":"Prices"},"type":"lvl2","url":"/markdown/resources#prices","position":2},{"hierarchy":{"lvl1":"Resources","lvl2":"Prices"},"content":"From \n\ndestatis\n\nFrom \n\nsmard:\n\nFrom \n\ntrading economics:\n\nFrom \n\nEMBER:\n\nRegarding SRMC:\n\nhttps://​support​.montel​.energy​/how​-are​-short​-run​-marginal​-costs​-srmc​-calculated​-in​-montel​-online\n\nhttps://​ember​-energy​.org​/data​/european​-electricity​-prices​-and​-costs​/​#methodology\n\nSMARD API:\n\nhttps://​smard​.api​.bund​.dev/","type":"content","url":"/markdown/resources#prices","position":3},{"hierarchy":{"lvl1":"Resources","lvl2":"Weather"},"type":"lvl2","url":"/markdown/resources#weather","position":4},{"hierarchy":{"lvl1":"Resources","lvl2":"Weather"},"content":"","type":"content","url":"/markdown/resources#weather","position":5},{"hierarchy":{"lvl1":"Resources","lvl2":"Data"},"type":"lvl2","url":"/markdown/resources#data","position":6},{"hierarchy":{"lvl1":"Resources","lvl2":"Data"},"content":"Investing.com:\n\nCarbon Emissions Futures Prices: \n\nhttps://​www​.investing​.com​/commodities​/carbon​-emissions​-historical​-data\n\nRotterdam Coal Futures Prices: \n\nhttps://​www​.investing​.com​/commodities​/rotterdam​-coal​-futures​-historical​-data","type":"content","url":"/markdown/resources#data","position":7},{"hierarchy":{"lvl1":"Electricity prices in Germany"},"type":"lvl1","url":"/notebooks/smard-de-prices","position":0},{"hierarchy":{"lvl1":"Electricity prices in Germany"},"content":"This notebook loads and visualizes day-ahead electricity prices for the\nGerman-Luxembourg market area from SMARD data.","type":"content","url":"/notebooks/smard-de-prices","position":1},{"hierarchy":{"lvl1":"Electricity prices in Germany","lvl2":"Background"},"type":"lvl2","url":"/notebooks/smard-de-prices#background","position":2},{"hierarchy":{"lvl1":"Electricity prices in Germany","lvl2":"Background"},"content":"The SMARD platform (operated by the German Federal Network Agency,\nBundesnetzagentur) is the primary hub for high-resolution electricity market\ndata in Germany. It serves as a transparent “scoreboard” for the energy\ntransition.","type":"content","url":"/notebooks/smard-de-prices#background","position":3},{"hierarchy":{"lvl1":"Electricity prices in Germany","lvl3":"What are SMARD Electricity Prices (DE/LU)?","lvl2":"Background"},"type":"lvl3","url":"/notebooks/smard-de-prices#what-are-smard-electricity-prices-de-lu","position":4},{"hierarchy":{"lvl1":"Electricity prices in Germany","lvl3":"What are SMARD Electricity Prices (DE/LU)?","lvl2":"Background"},"content":"The DE/LU price refers to the wholesale cost of electricity for the joint\nbidding zone comprising Germany and Luxembourg.\n\nUniform Price: Within this zone, electricity is treated as if it were on\na “copper plate”—the wholesale price is the same regardless of location.\n\nWholesale vs. Retail: These are wholesale prices (what energy suppliers\npay on the exchange). Retail bills include additional taxes, grid fees, and\nlevies.\n\nVolatility: Prices fluctuate hourly based on weather (wind/solar), demand\n(industrial activity), and fuel prices (natural gas).","type":"content","url":"/notebooks/smard-de-prices#what-are-smard-electricity-prices-de-lu","position":5},{"hierarchy":{"lvl1":"Electricity prices in Germany","lvl3":"What is Day-Ahead?","lvl2":"Background"},"type":"lvl3","url":"/notebooks/smard-de-prices#what-is-day-ahead","position":6},{"hierarchy":{"lvl1":"Electricity prices in Germany","lvl3":"What is Day-Ahead?","lvl2":"Background"},"content":"The Day-Ahead Market is the primary exchange for electricity. Because\nelectricity is difficult to store, it must be traded before production.\n\nThe Auction: Every day at 12:00 CET, an auction takes place for each\nhour of the following day.\n\nClearing Price: The exchange algorithm finds where supply meets demand.\nThis “Market Clearing Price” is what SMARD publishes.","type":"content","url":"/notebooks/smard-de-prices#what-is-day-ahead","position":7},{"hierarchy":{"lvl1":"Electricity prices in Germany","lvl3":"Connection to Other Bidding Zones","lvl2":"Background"},"type":"lvl3","url":"/notebooks/smard-de-prices#connection-to-other-bidding-zones","position":8},{"hierarchy":{"lvl1":"Electricity prices in Germany","lvl3":"Connection to Other Bidding Zones","lvl2":"Background"},"content":"Germany/Luxembourg is part of the Single Day-Ahead Coupling (SDAC), linking\nmost of Europe. Through interconnectors, electricity flows from low-price areas\n(high supply) to high-price areas (high demand). When cables are congested,\nprices “split” between zones.","type":"content","url":"/notebooks/smard-de-prices#connection-to-other-bidding-zones","position":9},{"hierarchy":{"lvl1":"Electricity prices in Germany","lvl3":"Daylight Savings Time Transitions","lvl2":"Background"},"type":"lvl3","url":"/notebooks/smard-de-prices#daylight-savings-time-transitions","position":10},{"hierarchy":{"lvl1":"Electricity prices in Germany","lvl3":"Daylight Savings Time Transitions","lvl2":"Background"},"content":"Spring (23-hour day): When clocks jump from 02:00 to 03:00, the 2 AM hour\nis missing from the data.\n\nAutumn (25-hour day): When clocks fall back, the extra hour is labeled\nas 3A and 3B (or similar). This often shows very low prices due to\nreduced demand and extra generation capacity.","type":"content","url":"/notebooks/smard-de-prices#daylight-savings-time-transitions","position":11},{"hierarchy":{"lvl1":"Electricity prices in Germany","lvl2":"Observations from the Data"},"type":"lvl2","url":"/notebooks/smard-de-prices#observations-from-the-data","position":12},{"hierarchy":{"lvl1":"Electricity prices in Germany","lvl2":"Observations from the Data"},"content":"","type":"content","url":"/notebooks/smard-de-prices#observations-from-the-data","position":13},{"hierarchy":{"lvl1":"Electricity prices in Germany","lvl3":"The 2021-2023 Energy Crisis","lvl2":"Observations from the Data"},"type":"lvl3","url":"/notebooks/smard-de-prices#the-2021-2023-energy-crisis","position":14},{"hierarchy":{"lvl1":"Electricity prices in Germany","lvl3":"The 2021-2023 Energy Crisis","lvl2":"Observations from the Data"},"content":"The most striking feature in the data is the dramatic price surge from mid-2021\nthrough early 2023, with monthly averages peaking above 460 EUR/MWh in\nAugust 2022—roughly 10x the pre-crisis baseline of ~40 EUR/MWh.\n\nPrimary causes:\n\nPost-COVID recovery (2021): Economic rebound increased global energy\ndemand, particularly for LNG in Asia, tightening European gas supplies.\n\nRussia’s invasion of Ukraine (Feb 2022): Russia had supplied ~44% of\nEU natural gas imports. The subsequent supply cuts caused gas prices to surge\n5-fold, directly impacting electricity prices since gas plants often set the\nmarginal price.\n\nMerit order effect: In electricity markets, the most expensive plant\nneeded to meet demand sets the price for all generators. With gas prices\nsoaring, this “marginal” plant became extremely costly.\n\nThe crisis peaked in August 2022 when wholesale prices exceeded 850 EUR/MWh.","type":"content","url":"/notebooks/smard-de-prices#the-2021-2023-energy-crisis","position":15},{"hierarchy":{"lvl1":"Electricity prices in Germany","lvl3":"Negative Prices","lvl2":"Observations from the Data"},"type":"lvl3","url":"/notebooks/smard-de-prices#negative-prices","position":16},{"hierarchy":{"lvl1":"Electricity prices in Germany","lvl3":"Negative Prices","lvl2":"Observations from the Data"},"content":"The hourly data shows prices occasionally dropping below zero (visible as\ndownward spikes reaching -200 to -500 EUR/MWh). Negative prices mean\nproducers must pay to have their electricity taken off the grid.\n\nWhy this happens:\n\nRenewable oversupply: On sunny, windy days (especially weekends), solar\nand wind generation can exceed demand. Germany added massive renewable\ncapacity—the EU installed a record 56 GW of solar in 2023 alone.\n\nInflexible generation: Nuclear and some coal plants cannot quickly ramp\ndown, so they pay to keep running rather than face costly shutdown/restart.\n\nGrid congestion: Limited transmission capacity can trap excess power in\ncertain regions.\n\nTiming mismatch: Peak solar production (midday) doesn’t align with peak\ndemand (mornings/evenings), especially on low-demand weekends.\n\nIn H1 2025, Germany experienced 389 hours of negative day-ahead prices.","type":"content","url":"/notebooks/smard-de-prices#negative-prices","position":17},{"hierarchy":{"lvl1":"Electricity prices in Germany","lvl3":"Positive Price Spikes","lvl2":"Observations from the Data"},"type":"lvl3","url":"/notebooks/smard-de-prices#positive-price-spikes","position":18},{"hierarchy":{"lvl1":"Electricity prices in Germany","lvl3":"Positive Price Spikes","lvl2":"Observations from the Data"},"content":"Extreme upward spikes (600-900+ EUR/MWh) occur during supply scarcity events:\n\nDunkelflaute: German for “dark doldrums”—periods of cold, cloudy, windless\nweather when renewable output collapses. In December 2024, intraday prices\nbriefly hit ~1,000 EUR/MWh during an extended Dunkelflaute.\n\nPlant outages: Unplanned maintenance or failures of conventional plants\nduring high-demand periods exacerbate scarcity.\n\nPeak demand: Cold winter evenings with high heating demand and low\nrenewable output force reliance on expensive gas “peaker” plants.\n\nThese dynamics illustrate why flexibility (storage, demand response, grid\nexpansion) is critical for integrating high shares of variable renewables.\n\n","type":"content","url":"/notebooks/smard-de-prices#positive-price-spikes","position":19},{"hierarchy":{"lvl1":"Electricity prices in Germany","lvl2":"Data Source"},"type":"lvl2","url":"/notebooks/smard-de-prices#data-source","position":20},{"hierarchy":{"lvl1":"Electricity prices in Germany","lvl2":"Data Source"},"content":"The price data is downloaded from the SMARD API using the following function:\n\ndef download_smard_data(\n    region: str, \n    resolution: str, \n    variable: int, \n    variable_name: str,\n    start_time: Optional[datetime] = None\n) -> pd.DataFrame:\n    \"\"\"Download data from SMARD API for given parameters.\n    \n    Note: The SMARD API uses a block-based data retrieval system where we first get\n    timestamps marking the start of data blocks (e.g. weekly chunks), then fetch\n    the actual observations for each block in separate requests.\n    \n    Args:\n        region: Region code (e.g. 'DE' for Germany)\n        resolution: Time resolution (e.g. 'day', 'hour')\n        variable: Variable ID for the type of power data\n        variable_name: Name of the variable to use as column label\n        start_time: Optional datetime to specify start of data collection.\n                   If None, returns all available data.\n    \n    Returns:\n        pd.DataFrame: DataFrame with timestamp index and value column\n        \n    Raises:\n        RuntimeError: If there's an error fetching data from the API\n    \"\"\"\n    base_url = \"https://www.smard.de/app\"\n    \n    # Step 1: Get available timestamps\n    index_url = f\"{base_url}/chart_data/{variable}/{region}/index_{resolution}.json\"\n    response = requests.get(index_url)\n    \n    if response.status_code != 200:\n        raise RuntimeError(f\"Error fetching timestamps: {response.status_code}\")\n        \n    timestamps = response.json()[\"timestamps\"]\n    \n    if not timestamps:\n        raise RuntimeError(\"No timestamps available for the specified parameters\")\n\n    # Filter timestamps if start_time is provided\n    if start_time:\n        start_timestamp = int(start_time.timestamp() * 1000)  # Convert to milliseconds\n        timestamps = [ts for ts in timestamps if ts >= start_timestamp]\n        \n        if not timestamps:\n            raise RuntimeError(f\"No data available after {start_time}\")\n\n    # Initialize empty lists to store all data\n    all_timestamps = []\n    all_values = []\n\n    # Step 2: Get data for each timestamp\n    for timestamp in timestamps:\n        data_url = f\"{base_url}/chart_data/{variable}/{region}/{variable}_{region}_{resolution}_{timestamp}.json\"\n        data_response = requests.get(data_url)\n        \n        if data_response.status_code != 200:\n            print(f\"Warning: Error fetching data for timestamp {timestamp}: {data_response.status_code}\")\n            continue\n            \n        data = data_response.json()\n        series_data: List[Tuple[int, float]] = data[\"series\"]\n        \n        # Extract timestamps and values\n        ts = [datetime.fromtimestamp(ts/1000) for ts, _ in series_data]\n        values = [val for _, val in series_data]\n        \n        all_timestamps.extend(ts)\n        all_values.extend(values)\n    \n    # Create and return dataframe\n    df = pd.DataFrame({\n        'timestamp': all_timestamps,\n        variable_name: all_values\n    })\n    \n    # Sort by timestamp and remove duplicates\n    df = df.sort_values('timestamp').drop_duplicates(subset='timestamp')\n    df.set_index('timestamp', inplace=True)\n    df = df.dropna()\n    \n    return df \n\nimport pandas as pd\nimport matplotlib.pyplot as plt\n\nfrom woe.paths import ProjPaths\n\n\n\n\n\n# Load the price data\npaths = ProjPaths()\npaths.images_path.mkdir(parents=True, exist_ok=True)\nprices_file = paths.smard_prices_file\n\nprint(f\"Loading data from: {prices_file}\")\ndf = pd.read_parquet(prices_file)\n\nprint(f\"Data shape: {df.shape}\")\nprint(f\"Date range: {df.index.min()} to {df.index.max()}\")\ndf.head()\n\n\n\n\n\n# Time series plot of electricity prices\nfig, ax = plt.subplots(figsize=(14, 6))\n\nax.plot(df.index, df[\"PRICE_DE_LU\"], linewidth=0.5, alpha=0.8)\nax.set_xlabel(\"Date\")\nax.set_ylabel(\"Price (EUR/MWh)\")\nax.set_title(\"DE/LU Day-Ahead Electricity Prices\")\nax.grid(True, alpha=0.3)\n\nfig.tight_layout()\nfig.savefig(paths.images_path / \"03_hourly_prices.png\", dpi=150, bbox_inches=\"tight\")\nplt.show()\n\n\n\n\n\nFigure 1:DE/LU Day-Ahead Electricity Prices\n\n# Monthly average prices\nmonthly_avg = df.resample(\"ME\").mean()\n\nfig, ax = plt.subplots(figsize=(14, 6))\n\nax.plot(monthly_avg.index, monthly_avg[\"PRICE_DE_LU\"], marker=\"o\", markersize=3)\nax.set_xlabel(\"Date\")\nax.set_ylabel(\"Price (EUR/MWh)\")\nax.set_title(\"DE/LU Monthly Average Electricity Prices\")\nax.grid(True, alpha=0.3)\n\nfig.tight_layout()\nfig.savefig(paths.images_path / \"03_monthly_avg_prices.png\", dpi=150, bbox_inches=\"tight\")\nplt.show()\n\n\n\n\n\nFigure 2:DE/LU Monthly Average Electricity Prices\n\n","type":"content","url":"/notebooks/smard-de-prices#data-source","position":21},{"hierarchy":{"lvl1":"Electricity prices in Germany","lvl2":"Intraday Seasonality"},"type":"lvl2","url":"/notebooks/smard-de-prices#intraday-seasonality","position":22},{"hierarchy":{"lvl1":"Electricity prices in Germany","lvl2":"Intraday Seasonality"},"content":"The charts above use hourly resolution which compresses daily patterns. Below\nwe zoom into a three-week window so that the recurring daily and weekly price\ncycles become clearly visible.\n\nTypical patterns:\n\nMorning ramp (06:00–09:00): Prices rise sharply as households and\nindustry come online.\n\nSolar dip (11:00–15:00): On sunny days, abundant solar generation\npushes prices down around midday—sometimes below zero.\n\nEvening peak (17:00–20:00): Demand stays high while solar fades,\nforcing expensive gas plants onto the grid.\n\nWeekend effect: Lower industrial demand on Saturdays and Sundays\ncompresses the entire price curve downward.\n\nfrom datetime import datetime, timedelta\n\n# Pick a recent 3-week window ending at the last full day in the hourly data\nend_date = df.index.max().normalize()\nstart_date = end_date - timedelta(weeks=3)\n\nsub_prices = df.loc[start_date:end_date].copy()\nprint(f\"Hourly prices: {start_date.date()} to {end_date.date()} ({len(sub_prices)} records)\")\n\n\n\n\n\nfig, ax = plt.subplots(figsize=(14, 5))\n\nimport matplotlib.dates as mdates\n\nax.plot(sub_prices.index, sub_prices[\"PRICE_DE_LU\"], linewidth=0.6)\nax.set_ylabel(\"Price (EUR/MWh)\")\nax.set_title(\n    f\"Hourly DE/LU Day-Ahead Prices \"\n    f\"({start_date.strftime('%d %b')} – {end_date.strftime('%d %b %Y')})\"\n)\nax.grid(True, alpha=0.3)\n\n# Show every day on the x-axis\nax.xaxis.set_major_locator(mdates.DayLocator())\nax.xaxis.set_major_formatter(mdates.DateFormatter(\"%d %b\"))\nfig.autofmt_xdate(rotation=45)\n\n# Shade weekends\nfor dt in pd.date_range(start_date, end_date, freq=\"D\"):\n    if dt.weekday() >= 5:  # Saturday=5, Sunday=6\n        ax.axvspan(dt, dt + timedelta(days=1), alpha=0.08, color=\"grey\")\n\nax.legend([\"Price\", \"Weekend\"], loc=\"upper right\")\nfig.tight_layout()\nfig.savefig(paths.images_path / \"03_intraday_3week.png\", dpi=150, bbox_inches=\"tight\")\nplt.show()\n\n\n\n\n\nFigure 3:Hourly DE/LU Day-Ahead Prices (3-week window)\n\n# Average daily profile across the 3-week window\nsub_prices[\"hour\"] = sub_prices.index.hour + sub_prices.index.minute / 60\nsub_prices[\"is_weekend\"] = sub_prices.index.weekday >= 5\n\nweekday_profile = sub_prices[~sub_prices[\"is_weekend\"]].groupby(\"hour\")[\"PRICE_DE_LU\"].mean()\nweekend_profile = sub_prices[sub_prices[\"is_weekend\"]].groupby(\"hour\")[\"PRICE_DE_LU\"].mean()\n\nfig, ax = plt.subplots(figsize=(10, 5))\n\nax.plot(weekday_profile.index, weekday_profile.values, label=\"Weekday avg\", linewidth=1.5)\nax.plot(weekend_profile.index, weekend_profile.values, label=\"Weekend avg\", linewidth=1.5)\nax.set_xlabel(\"Hour of day\")\nax.set_ylabel(\"Price (EUR/MWh)\")\nax.set_title(\n    f\"Average Daily Price Profile \"\n    f\"({start_date.strftime('%d %b')} – {end_date.strftime('%d %b %Y')})\"\n)\nax.set_xlim(0, 24)\nax.set_xticks(range(0, 25, 3))\nax.legend()\nax.grid(True, alpha=0.3)\n\n# Clean up helper columns\nsub_prices.drop(columns=[\"hour\", \"is_weekend\"], inplace=True)\n\nfig.tight_layout()\nfig.savefig(paths.images_path / \"03_daily_profile.png\", dpi=150, bbox_inches=\"tight\")\nplt.show()\n\n\n\n\n\nFigure 4:Average Daily Price Profile (weekday vs weekend)\n\n","type":"content","url":"/notebooks/smard-de-prices#intraday-seasonality","position":23},{"hierarchy":{"lvl1":"Electricity prices in Germany","lvl2":"Electricity Prices and Natural Gas"},"type":"lvl2","url":"/notebooks/smard-de-prices#electricity-prices-and-natural-gas","position":24},{"hierarchy":{"lvl1":"Electricity prices in Germany","lvl2":"Electricity Prices and Natural Gas"},"content":"In European electricity markets, natural gas plants frequently set the\nmarginal (price-setting) price because they sit at the expensive end of the\nmerit order. When gas prices rise, the cost of running these plants increases,\nwhich lifts the clearing price for all generators—even low-cost renewables.\n\nThe chart below overlays monthly average electricity prices with the TTF\n(Title Transfer Facility) natural gas front-month futures price. TTF is the\nbenchmark hub for north-west European gas trading and the most liquid gas\ncontract on the continent.\n\nThe tight co-movement during 2021-2023 illustrates how the gas supply crisis\ndirectly transmitted into record electricity prices.\n\n# Load TTF gas prices\ngas_df = pd.read_parquet(paths.ttf_gas_prices_file)\ngas_df.index = pd.to_datetime(gas_df.index)\n\nprint(f\"Gas prices: {len(gas_df)} records\")\nprint(f\"Date range: {gas_df.index.min().date()} to {gas_df.index.max().date()}\")\n\n\n\n\n\n# Monthly averages for both series\nmonthly_power = df.resample(\"ME\").mean()\nmonthly_gas = gas_df[\"Close\"].resample(\"ME\").mean()\n\nfig, ax1 = plt.subplots(figsize=(14, 6))\n\ncolor_power = \"tab:blue\"\nax1.plot(monthly_power.index, monthly_power[\"PRICE_DE_LU\"],\n         color=color_power, linewidth=1.2, label=\"Electricity (DE/LU)\")\nax1.set_xlabel(\"Date\")\nax1.set_ylabel(\"Electricity Price (EUR/MWh)\", color=color_power)\nax1.tick_params(axis=\"y\", labelcolor=color_power)\n\nax2 = ax1.twinx()\ncolor_gas = \"tab:orange\"\nax2.plot(monthly_gas.index, monthly_gas.values,\n         color=color_gas, linewidth=1.2, label=\"TTF Gas\")\nax2.set_ylabel(\"TTF Gas Price (EUR/MWh)\", color=color_gas)\nax2.tick_params(axis=\"y\", labelcolor=color_gas)\n\nax1.set_title(\"Monthly Average Electricity vs Natural Gas Prices\")\nax1.grid(True, alpha=0.3)\n\n# Combined legend\nlines1, labels1 = ax1.get_legend_handles_labels()\nlines2, labels2 = ax2.get_legend_handles_labels()\nax1.legend(lines1 + lines2, labels1 + labels2, loc=\"upper left\")\n\nfig.tight_layout()\nfig.savefig(paths.images_path / \"03_electricity_vs_gas.png\", dpi=150, bbox_inches=\"tight\")\nplt.show()\n\n\n\n\n\nFigure 5:Monthly Average Electricity vs Natural Gas Prices\n\n","type":"content","url":"/notebooks/smard-de-prices#electricity-prices-and-natural-gas","position":25},{"hierarchy":{"lvl1":"Electricity prices in Germany","lvl2":"Renewable Generation and Residual Load"},"type":"lvl2","url":"/notebooks/smard-de-prices#renewable-generation-and-residual-load","position":26},{"hierarchy":{"lvl1":"Electricity prices in Germany","lvl2":"Renewable Generation and Residual Load"},"content":"Residual load is the electricity demand that must be covered by\ndispatchable (controllable) power plants after subtracting variable\nrenewable generation:\\text{Residual Load} = \\text{Total Load} - \\text{Solar}\n  - \\text{Wind Onshore} - \\text{Wind Offshore}\n\nIt is the single most important driver of wholesale electricity prices:\n\nHigh residual load → more conventional plants must run, including\nexpensive gas turbines → higher prices\n\nLow / negative residual load → renewables cover (or exceed) demand →\ncheap plants suffice → lower prices (sometimes negative)\n\nThe stacked area chart below shows renewable generation (solar, onshore wind,\noffshore wind) against total electricity load. The gap between the top of the\nrenewables stack and the load line is the residual load.\n\n# Load generation and load data\nsolar = pd.read_parquet(paths.smard_solar_file)\nwind_on = pd.read_parquet(paths.smard_wind_onshore_file)\nwind_off = pd.read_parquet(paths.smard_wind_offshore_file)\ntotal_load = pd.read_parquet(paths.smard_total_load_file)\n\n# Combine into one DataFrame\ngen = pd.concat([\n    solar.rename(columns={solar.columns[0]: \"solar\"}),\n    wind_on.rename(columns={wind_on.columns[0]: \"wind_onshore\"}),\n    wind_off.rename(columns={wind_off.columns[0]: \"wind_offshore\"}),\n    total_load.rename(columns={total_load.columns[0]: \"total_load\"}),\n], axis=1).dropna()\n\ngen[\"renewables\"] = gen[\"solar\"] + gen[\"wind_onshore\"] + gen[\"wind_offshore\"]\ngen[\"residual_load\"] = gen[\"total_load\"] - gen[\"renewables\"]\n\nprint(f\"Generation data: {len(gen)} records\")\nprint(f\"Date range: {gen.index.min()} to {gen.index.max()}\")\n\n\n\n\n\n# Renewables vs total load (monthly averages for readability)\nmonthly_gen = gen.resample(\"ME\").mean()\n\nfig, ax = plt.subplots(figsize=(14, 6))\n\nax.stackplot(\n    monthly_gen.index,\n    monthly_gen[\"solar\"],\n    monthly_gen[\"wind_onshore\"],\n    monthly_gen[\"wind_offshore\"],\n    labels=[\"Solar\", \"Wind Onshore\", \"Wind Offshore\"],\n    alpha=0.7,\n)\nax.plot(monthly_gen.index, monthly_gen[\"total_load\"],\n        color=\"black\", linewidth=0.8, label=\"Total Load\")\n\nax.set_xlabel(\"Date\")\nax.set_ylabel(\"Power (MW)\")\nax.set_title(\"Renewable Generation vs Total Load (Monthly Averages)\")\nax.legend(loc=\"upper left\")\nax.grid(True, alpha=0.3)\n\nfig.tight_layout()\nfig.savefig(paths.images_path / \"03_renewables_vs_load.png\", dpi=150, bbox_inches=\"tight\")\nplt.show()\n\n\n\n\n\nFigure 6:Renewable Generation vs Total Load (Monthly Averages)\n\n# Monthly average residual load\nfig, ax = plt.subplots(figsize=(14, 6))\n\nax.plot(monthly_gen.index, monthly_gen[\"residual_load\"], color=\"tab:red\", linewidth=1.2)\nax.axhline(0, color=\"black\", linewidth=0.5, linestyle=\"--\")\nax.set_xlabel(\"Date\")\nax.set_ylabel(\"Residual Load (MW)\")\nax.set_title(\"Monthly Average Residual Load\")\nax.grid(True, alpha=0.3)\n\nfig.tight_layout()\nfig.savefig(paths.images_path / \"03_monthly_residual_load.png\", dpi=150, bbox_inches=\"tight\")\nplt.show()\n\n\n\n\n\nFigure 7:Monthly Average Residual Load\n\n","type":"content","url":"/notebooks/smard-de-prices#renewable-generation-and-residual-load","position":27},{"hierarchy":{"lvl1":"Electricity prices in Germany","lvl2":"Residual Load vs Electricity Price"},"type":"lvl2","url":"/notebooks/smard-de-prices#residual-load-vs-electricity-price","position":28},{"hierarchy":{"lvl1":"Electricity prices in Germany","lvl2":"Residual Load vs Electricity Price"},"content":"Because the merit order is roughly monotonic—cheap renewables first, then\ncoal/lignite, then gas—the price is largely determined by how far up the\nsupply curve demand reaches. Residual load measures exactly that.\n\nThe charts below zoom into three-week windows to show how hourly residual\nload and electricity prices move together. A linear fit\n(price = intercept + slope × residual load) is used to align the two\ny-axes so that the visual overlap reflects the statistical relationship.\n\nimport numpy as np\n\n# Align price and residual load on the same index\nprice_res = df[[\"PRICE_DE_LU\"]].join(gen[[\"residual_load\"]], how=\"inner\").dropna()\n\n\ndef plot_price_vs_residual(price_res_window, title_dates, save_path=None):\n    \"\"\"Plot price and residual load with axes aligned via a linear fit.\"\"\"\n    X = price_res_window[\"residual_load\"].values\n    y = price_res_window[\"PRICE_DE_LU\"].values\n    slope, intercept = np.polyfit(X, y, 1)\n    print(f\"Linear fit: price = {intercept:.2f} + {slope:.4f} × residual_load\")\n\n    fig, ax1 = plt.subplots(figsize=(14, 6))\n\n    color1 = \"tab:blue\"\n    ax1.plot(price_res_window.index, price_res_window[\"residual_load\"],\n             color=color1, linewidth=0.5, alpha=0.7, label=\"Residual Load\")\n    ax1.set_xlabel(\"Date\")\n    ax1.set_ylabel(\"Residual Load (MW)\", color=color1)\n    ax1.tick_params(axis=\"y\", labelcolor=color1)\n\n    ax2 = ax1.twinx()\n    color2 = \"tab:orange\"\n    ax2.plot(price_res_window.index, price_res_window[\"PRICE_DE_LU\"],\n             color=color2, linewidth=0.5, alpha=0.7, label=\"Price\")\n    ax2.set_ylabel(\"Price (EUR/MWh)\", color=color2)\n    ax2.tick_params(axis=\"y\", labelcolor=color2)\n\n    # Align the residual load axis to the price axis using the linear fit\n    p_lo, p_hi = ax2.get_ylim()\n    ax1.set_ylim((p_lo - intercept) / slope, (p_hi - intercept) / slope)\n\n    ax1.set_title(f\"Residual Load and Electricity Price ({title_dates})\")\n    ax1.grid(True, alpha=0.3)\n\n    lines1, labels1 = ax1.get_legend_handles_labels()\n    lines2, labels2 = ax2.get_legend_handles_labels()\n    ax1.legend(lines1 + lines2, labels1 + labels2, loc=\"upper left\")\n\n    fig.tight_layout()\n    if save_path:\n        fig.savefig(save_path, dpi=150, bbox_inches=\"tight\")\n    plt.show()\n\n\n\n\n\n# Recent 3-week window (same as intraday section above)\nprice_res_sub = price_res.loc[start_date:end_date]\nprint(f\"Matched records: {len(price_res_sub)}\")\n\nplot_price_vs_residual(\n    price_res_sub,\n    f\"{start_date.strftime('%d %b')} – {end_date.strftime('%d %b %Y')}\",\n    save_path=paths.images_path / \"03_price_vs_residual_recent.png\",\n)\n\n\n\n\n\nFigure 8:Residual Load and Electricity Price (recent 3-week window)\n\n# A second 3-week window in 2025 for comparison\nstart_2025 = pd.Timestamp(\"2025-06-01\")\nend_2025 = start_2025 + timedelta(weeks=3)\n\nprice_res_2025 = price_res.loc[start_2025:end_2025]\nprint(f\"Matched records (2025 window): {len(price_res_2025)}\")\n\nplot_price_vs_residual(\n    price_res_2025,\n    f\"{start_2025.strftime('%d %b')} – {end_2025.strftime('%d %b %Y')}\",\n    save_path=paths.images_path / \"03_price_vs_residual_2025.png\",\n)\n\n\n\n\n\nFigure 9:Residual Load and Electricity Price (June 2025 window)","type":"content","url":"/notebooks/smard-de-prices#residual-load-vs-electricity-price","position":29},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction"},"type":"lvl1","url":"/notebooks/reconstruct-prices","position":0},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction"},"content":"This notebook calculates the Short Run Marginal Costs (SRMC) of generating\nelectricity using hard coal and fossil gas, then uses a simplified merit\norder model to reconstruct wholesale electricity prices.","type":"content","url":"/notebooks/reconstruct-prices","position":1},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl2":"Approach"},"type":"lvl2","url":"/notebooks/reconstruct-prices#approach","position":2},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl2":"Approach"},"content":"Calculate SRMC for coal and gas power plants from commodity prices\n\nCalculate Fossil Residual Load: the demand that must be met by fossil plants\nafter accounting for renewables and baseload generationRL_{fossil} = \\text{Load} - (\\text{Wind} + \\text{Solar}) - (\\text{Nuclear} + \\text{Biomass} + \\text{Hydro}_{RoR})\n\nDetermine which fossil fuel (coal or gas) is cheaper based on SRMC\n\nAssign price based on merit order:\n\nIf RL_{fossil} \\leq \\text{cheaper capacity}: price = cheaper SRMC\n\nIf RL_{fossil} > \\text{cheaper capacity}: price = more expensive SRMC\n\nCompare reconstructed prices with actual market prices\n\n","type":"content","url":"/notebooks/reconstruct-prices#approach","position":3},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl2":"Short Run Marginal Costs (SRMC)"},"type":"lvl2","url":"/notebooks/reconstruct-prices#short-run-marginal-costs-srmc","position":4},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl2":"Short Run Marginal Costs (SRMC)"},"content":"The Short Run Marginal Cost (SRMC) represents the variable cost of producing\none additional MWh of electricity from a power plant. It determines the merit\norder position of generators in wholesale electricity markets.","type":"content","url":"/notebooks/reconstruct-prices#short-run-marginal-costs-srmc","position":5},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl3":"Components of SRMC","lvl2":"Short Run Marginal Costs (SRMC)"},"type":"lvl3","url":"/notebooks/reconstruct-prices#components-of-srmc","position":6},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl3":"Components of SRMC","lvl2":"Short Run Marginal Costs (SRMC)"},"content":"SRMC consists of three main components:\n\nFuel costs - The cost of the primary fuel (gas or coal) needed to\ngenerate electricity, adjusted for plant efficiency.\n\nCarbon costs - The cost of CO2 emissions under the EU Emissions Trading\nScheme (EU ETS), based on the carbon intensity of the fuel.\n\nVariable O&M costs - Operating and maintenance costs that vary with\nelectricity output.","type":"content","url":"/notebooks/reconstruct-prices#components-of-srmc","position":7},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl3":"Price References","lvl2":"Short Run Marginal Costs (SRMC)"},"type":"lvl3","url":"/notebooks/reconstruct-prices#price-references","position":8},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl3":"Price References","lvl2":"Short Run Marginal Costs (SRMC)"},"content":"Fossil Gas:\n\nDutch Title Transfer Facility (TTF) is the benchmark for gas traded in Europe\n\nOther European hubs (CEGH VTP, THE, PSV, etc.) trade at spreads to TTF\n\nPrices sourced from commodity exchanges (e.g., ICE, EEX)\n\nHard Coal:\n\nAPI 2 Rotterdam is the benchmark for coal imported into Northwest Europe\n\nFront month settlement prices in USD/metric ton\n\nThermal content approximately 6,000 kcal/kg (NAR)\n\nCarbon:\n\nEU ETS allowance prices (EUA) for the front December contract\n\nPrices in EUR per tonne CO2","type":"content","url":"/notebooks/reconstruct-prices#price-references","position":9},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl3":"Calculation Assumptions","lvl2":"Short Run Marginal Costs (SRMC)"},"type":"lvl3","url":"/notebooks/reconstruct-prices#calculation-assumptions","position":10},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl3":"Calculation Assumptions","lvl2":"Short Run Marginal Costs (SRMC)"},"content":"Parameter\n\nHard Coal\n\nFossil Gas\n\nEfficiency (HHV)\n\n40%\n\n50%\n\nCarbon intensity\n\n0.83 tCO2/MWh\n\n0.37 tCO2/MWh\n\nVariable O&M\n\n€2/MWh\n\n€2/MWh\n\nThe carbon intensity values represent emissions per MWh of electricity generated,\naccounting for the power plant efficiency.","type":"content","url":"/notebooks/reconstruct-prices#calculation-assumptions","position":11},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl3":"Why SRMC Matters","lvl2":"Short Run Marginal Costs (SRMC)"},"type":"lvl3","url":"/notebooks/reconstruct-prices#why-srmc-matters","position":12},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl3":"Why SRMC Matters","lvl2":"Short Run Marginal Costs (SRMC)"},"content":"In liberalized electricity markets, generators bid close to their marginal cost.\nThe SRMC comparison between coal and gas determines:\n\nFuel switching - When gas SRMC falls below coal, utilities switch from\ncoal to gas, reducing emissions\n\nPrice formation - The highest SRMC plant needed to meet demand often\nsets the wholesale electricity price\n\nInvestment signals - Persistent SRMC relationships influence new build\ndecisions and plant retirements\n\nimport pandas as pd\nimport numpy as np\nimport matplotlib.pyplot as plt\nfrom sklearn.linear_model import LinearRegression\nfrom sklearn.metrics import r2_score\n\nfrom woe.paths import ProjPaths\n\n\n\n","type":"content","url":"/notebooks/reconstruct-prices#why-srmc-matters","position":13},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl2":"SRMC Calculation Parameters"},"type":"lvl2","url":"/notebooks/reconstruct-prices#srmc-calculation-parameters","position":14},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl2":"SRMC Calculation Parameters"},"content":"\n\n# Power plant efficiency rates (Higher Heating Value / Gross Calorific Value)\nCOAL_EFFICIENCY = 0.40  # 40%\nGAS_EFFICIENCY = 0.50  # 50%\n\n# Carbon intensity (tCO2 per MWh of electricity generated)\nCOAL_CARBON_INTENSITY = 0.83  # tCO2/MWh\nGAS_CARBON_INTENSITY = 0.37  # tCO2/MWh\n\n# Variable Operating and Maintenance costs (EUR/MWh)\nVOM_COST = 2.0\n\n# Coal thermal content (MWh per metric ton)\n# API 2 coal specification: 6,000 kcal/kg NAR\n# 6,000 kcal/kg = 6,000,000 kcal/t ÷ 860,421 kcal/MWh ≈ 6.98 MWh/t\nCOAL_THERMAL_CONTENT = 6.98  # MWh/t\n\n# EUR/USD exchange rate (approximate)\nEURUSD_RATE = 1.08\n\n\n\n","type":"content","url":"/notebooks/reconstruct-prices#srmc-calculation-parameters","position":15},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl2":"Load Data"},"type":"lvl2","url":"/notebooks/reconstruct-prices#load-data","position":16},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl2":"Load Data"},"content":"\n\npaths = ProjPaths()\npaths.images_path.mkdir(parents=True, exist_ok=True)\n\n# Load generation and consumption data\nprint(\"Loading SMARD data...\")\nsolar = pd.read_parquet(paths.smard_solar_file)\nwind_onshore = pd.read_parquet(paths.smard_wind_onshore_file)\nwind_offshore = pd.read_parquet(paths.smard_wind_offshore_file)\ntotal_load = pd.read_parquet(paths.smard_total_load_file)\nprices = pd.read_parquet(paths.smard_prices_file)\ncapacities = pd.read_parquet(paths.smard_capacities_file)\n\nprint(f\"Generation data: {solar.index.min()} to {solar.index.max()}\")\nprint(f\"Prices: {prices.index.min()} to {prices.index.max()}\")\nprint(f\"Capacities: {capacities.index.min()} to {capacities.index.max()}\")\n\n\n\n","type":"content","url":"/notebooks/reconstruct-prices#load-data","position":17},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl3":"Baseload Generation Data","lvl2":"Load Data"},"type":"lvl3","url":"/notebooks/reconstruct-prices#baseload-generation-data","position":18},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl3":"Baseload Generation Data","lvl2":"Load Data"},"content":"Nuclear, biomass, and hydro generation data for the fossil residual load calculation.\n\nprint(\"Loading baseload generation data...\")\nnuclear = pd.read_parquet(paths.smard_nuclear_file)\nbiomass = pd.read_parquet(paths.smard_biomass_file)\nhydro = pd.read_parquet(paths.smard_hydro_file)\n\nprint(f\"Nuclear: {len(nuclear)} records\")\nprint(f\"Biomass: {len(biomass)} records\")\nprint(f\"Hydro: {len(hydro)} records\")\n\n\n\n","type":"content","url":"/notebooks/reconstruct-prices#baseload-generation-data","position":19},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl3":"Commodity Prices","lvl2":"Load Data"},"type":"lvl3","url":"/notebooks/reconstruct-prices#commodity-prices","position":20},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl3":"Commodity Prices","lvl2":"Load Data"},"content":"\n\ndef load_investing_com_csv(filepath: str) -> pd.Series:\n    \"\"\"Load price data from Investing.com CSV export.\"\"\"\n    df = pd.read_csv(\n        filepath,\n        encoding=\"utf-8-sig\",\n        parse_dates=[\"Date\"],\n        dayfirst=False,\n    )\n    df = df.set_index(\"Date\").sort_index()\n    return df[\"Price\"]\n\n\n\n\n\n# Load commodity prices\nprint(\"Loading commodity prices...\")\ngas_df = pd.read_parquet(paths.ttf_gas_prices_file)\ngas_prices = gas_df[\"Close\"].rename(\"gas_price\")\n\ncoal_prices = load_investing_com_csv(paths.rotterdam_coal_prices_file).rename(\n    \"coal_price\"\n)\n\ncarbon_prices = load_investing_com_csv(paths.eu_carbon_prices_file).rename(\n    \"carbon_price\"\n)\n\nprint(f\"Gas prices: {gas_prices.index.min()} to {gas_prices.index.max()}\")\nprint(f\"Coal prices: {coal_prices.index.min()} to {coal_prices.index.max()}\")\nprint(f\"Carbon prices: {carbon_prices.index.min()} to {carbon_prices.index.max()}\")\n\n\n\n","type":"content","url":"/notebooks/reconstruct-prices#commodity-prices","position":21},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl2":"Calculate SRMC"},"type":"lvl2","url":"/notebooks/reconstruct-prices#calculate-srmc","position":22},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl2":"Calculate SRMC"},"content":"","type":"content","url":"/notebooks/reconstruct-prices#calculate-srmc","position":23},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl3":"Gas SRMC","lvl2":"Calculate SRMC"},"type":"lvl3","url":"/notebooks/reconstruct-prices#gas-srmc","position":24},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl3":"Gas SRMC","lvl2":"Calculate SRMC"},"content":"\\text{Gas SRMC} = \\frac{\\text{Gas Price}}{\\text{Efficiency}} + \\text{Carbon Intensity} \\times \\text{Carbon Price} + \\text{VOM}","type":"content","url":"/notebooks/reconstruct-prices#gas-srmc","position":25},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl3":"Coal SRMC","lvl2":"Calculate SRMC"},"type":"lvl3","url":"/notebooks/reconstruct-prices#coal-srmc","position":26},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl3":"Coal SRMC","lvl2":"Calculate SRMC"},"content":"\\text{Coal SRMC} = \\frac{\\text{Coal Price (EUR/MWh)}}{\\text{Efficiency}} + \\text{Carbon Intensity} \\times \\text{Carbon Price} + \\text{VOM}\n\nNote: Coal prices in USD/t need to be converted to EUR/MWh using:\n\nExchange rate (USD/EUR)\n\nThermal content (MWh/t)\n\n# Combine commodity prices (daily)\ncommodity_prices = pd.concat(\n    [gas_prices, coal_prices, carbon_prices], axis=1, join=\"inner\"\n)\ncommodity_prices = commodity_prices.ffill()\n\n# Convert coal from USD/t to EUR/MWh\ncoal_eur_mwh = commodity_prices[\"coal_price\"] / EURUSD_RATE / COAL_THERMAL_CONTENT\n\n# Calculate SRMC components\ngas_fuel_cost = commodity_prices[\"gas_price\"] / GAS_EFFICIENCY\ncoal_fuel_cost = coal_eur_mwh / COAL_EFFICIENCY\n\ngas_carbon_cost = GAS_CARBON_INTENSITY * commodity_prices[\"carbon_price\"]\ncoal_carbon_cost = COAL_CARBON_INTENSITY * commodity_prices[\"carbon_price\"]\n\n# Total SRMC (daily)\nsrmc_daily = pd.DataFrame(index=commodity_prices.index)\nsrmc_daily[\"gas_srmc\"] = gas_fuel_cost + gas_carbon_cost + VOM_COST\nsrmc_daily[\"coal_srmc\"] = coal_fuel_cost + coal_carbon_cost + VOM_COST\n\n# Store components for analysis\nsrmc_daily[\"gas_fuel_cost\"] = gas_fuel_cost\nsrmc_daily[\"gas_carbon_cost\"] = gas_carbon_cost\nsrmc_daily[\"coal_fuel_cost\"] = coal_fuel_cost\nsrmc_daily[\"coal_carbon_cost\"] = coal_carbon_cost\n\nprint(\"SRMC Summary (EUR/MWh):\")\nprint(srmc_daily[[\"gas_srmc\", \"coal_srmc\"]].describe().round(2))\n\n\n\n","type":"content","url":"/notebooks/reconstruct-prices#coal-srmc","position":27},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl2":"SRMC Time Series"},"type":"lvl2","url":"/notebooks/reconstruct-prices#srmc-time-series","position":28},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl2":"SRMC Time Series"},"content":"\n\nfig, ax = plt.subplots(figsize=(14, 6))\n\nax.plot(srmc_daily.index, srmc_daily[\"gas_srmc\"], label=\"Gas SRMC\", linewidth=1, alpha=0.8)\nax.plot(srmc_daily.index, srmc_daily[\"coal_srmc\"], label=\"Coal SRMC\", linewidth=1, alpha=0.8)\n\nax.set_xlabel(\"Date\")\nax.set_ylabel(\"SRMC (EUR/MWh)\")\nax.set_title(\"Short Run Marginal Costs: Coal vs Gas\")\nax.legend()\nax.grid(True, alpha=0.3)\n\nfig.tight_layout()\nfig.savefig(paths.images_path / \"04_srmc_timeseries.png\", dpi=150, bbox_inches=\"tight\")\nplt.show()\n\n\n\n\n\nFigure 1:Short Run Marginal Costs: Coal vs Gas\n\n","type":"content","url":"/notebooks/reconstruct-prices#srmc-time-series","position":29},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl2":"Monthly Average SRMC"},"type":"lvl2","url":"/notebooks/reconstruct-prices#monthly-average-srmc","position":30},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl2":"Monthly Average SRMC"},"content":"\n\nmonthly_srmc = srmc_daily[[\"gas_srmc\", \"coal_srmc\"]].resample(\"ME\").mean()\n\nfig, ax = plt.subplots(figsize=(14, 6))\n\nax.plot(\n    monthly_srmc.index,\n    monthly_srmc[\"gas_srmc\"],\n    label=\"Gas SRMC\",\n    marker=\"o\",\n    markersize=3,\n)\nax.plot(\n    monthly_srmc.index,\n    monthly_srmc[\"coal_srmc\"],\n    label=\"Coal SRMC\",\n    marker=\"o\",\n    markersize=3,\n)\n\nax.set_xlabel(\"Date\")\nax.set_ylabel(\"SRMC (EUR/MWh)\")\nax.set_title(\"Monthly Average Short Run Marginal Costs\")\nax.legend()\nax.grid(True, alpha=0.3)\n\nfig.tight_layout()\nfig.savefig(paths.images_path / \"04_monthly_srmc.png\", dpi=150, bbox_inches=\"tight\")\nplt.show()\n\n\n\n\n\nFigure 2:Monthly Average Short Run Marginal Costs\n\n","type":"content","url":"/notebooks/reconstruct-prices#monthly-average-srmc","position":31},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl2":"Fuel Switching Indicator"},"type":"lvl2","url":"/notebooks/reconstruct-prices#fuel-switching-indicator","position":32},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl2":"Fuel Switching Indicator"},"content":"When gas SRMC is lower than coal SRMC, it is economically favorable to dispatch\ngas plants over coal plants, leading to lower emissions. This “fuel switching”\nis a key mechanism for carbon price effectiveness.\n\n# Calculate the spread (positive = gas cheaper than coal)\nsrmc_daily[\"spread\"] = srmc_daily[\"coal_srmc\"] - srmc_daily[\"gas_srmc\"]\n\nfig, axes = plt.subplots(2, 1, figsize=(14, 10), sharex=True)\n\n# SRMC comparison\nax1 = axes[0]\nax1.plot(srmc_daily.index, srmc_daily[\"gas_srmc\"], label=\"Gas SRMC\", linewidth=1, alpha=0.8)\nax1.plot(srmc_daily.index, srmc_daily[\"coal_srmc\"], label=\"Coal SRMC\", linewidth=1, alpha=0.8)\nax1.set_ylabel(\"SRMC (EUR/MWh)\")\nax1.set_title(\"Short Run Marginal Costs and Fuel Switching\")\nax1.legend()\nax1.grid(True, alpha=0.3)\n\n# Spread (coal - gas)\nax2 = axes[1]\nax2.fill_between(\n    srmc_daily.index,\n    srmc_daily[\"spread\"],\n    0,\n    where=srmc_daily[\"spread\"] >= 0,\n    color=\"green\",\n    alpha=0.5,\n    label=\"Gas cheaper (fuel switch)\",\n)\nax2.fill_between(\n    srmc_daily.index,\n    srmc_daily[\"spread\"],\n    0,\n    where=srmc_daily[\"spread\"] < 0,\n    color=\"red\",\n    alpha=0.5,\n    label=\"Coal cheaper\",\n)\nax2.axhline(y=0, color=\"black\", linestyle=\"-\", linewidth=0.5)\nax2.set_xlabel(\"Date\")\nax2.set_ylabel(\"Spread (EUR/MWh)\")\nax2.set_title(\"Coal-Gas Spread (positive = gas cheaper)\")\nax2.legend()\nax2.grid(True, alpha=0.3)\n\nfig.tight_layout()\nfig.savefig(paths.images_path / \"04_fuel_switching.png\", dpi=150, bbox_inches=\"tight\")\nplt.show()\n\n\n\n\n\nFigure 3:Short Run Marginal Costs and Fuel Switching Indicator\n\n","type":"content","url":"/notebooks/reconstruct-prices#fuel-switching-indicator","position":33},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl2":"SRMC Cost Components"},"type":"lvl2","url":"/notebooks/reconstruct-prices#srmc-cost-components","position":34},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl2":"SRMC Cost Components"},"content":"Breaking down the SRMC into its fuel and carbon cost components shows the\nrelative importance of each driver.\n\nfig, axes = plt.subplots(1, 2, figsize=(14, 6))\n\n# Gas SRMC components\nax1 = axes[0]\nax1.stackplot(\n    srmc_daily.index,\n    srmc_daily[\"gas_fuel_cost\"],\n    srmc_daily[\"gas_carbon_cost\"],\n    [VOM_COST] * len(srmc_daily),\n    labels=[\"Fuel Cost\", \"Carbon Cost\", \"Variable O&M\"],\n    alpha=0.8,\n)\nax1.set_xlabel(\"Date\")\nax1.set_ylabel(\"Cost (EUR/MWh)\")\nax1.set_title(\"Gas SRMC Components\")\nax1.legend(loc=\"upper left\")\nax1.grid(True, alpha=0.3)\n\n# Coal SRMC components\nax2 = axes[1]\nax2.stackplot(\n    srmc_daily.index,\n    srmc_daily[\"coal_fuel_cost\"],\n    srmc_daily[\"coal_carbon_cost\"],\n    [VOM_COST] * len(srmc_daily),\n    labels=[\"Fuel Cost\", \"Carbon Cost\", \"Variable O&M\"],\n    alpha=0.8,\n)\nax2.set_xlabel(\"Date\")\nax2.set_ylabel(\"Cost (EUR/MWh)\")\nax2.set_title(\"Coal SRMC Components\")\nax2.legend(loc=\"upper left\")\nax2.grid(True, alpha=0.3)\n\nfig.tight_layout()\nfig.savefig(paths.images_path / \"04_srmc_components.png\", dpi=150, bbox_inches=\"tight\")\nplt.show()\n\n\n\n\n\nFigure 4:SRMC Cost Components (Gas and Coal)\n\n","type":"content","url":"/notebooks/reconstruct-prices#srmc-cost-components","position":35},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl2":"Combine All Data"},"type":"lvl2","url":"/notebooks/reconstruct-prices#combine-all-data","position":36},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl2":"Combine All Data"},"content":"Align all data to hourly resolution by forward-filling daily/monthly data.\n\n# Combine generation data into single DataFrame\ndf = pd.concat(\n    [\n        solar.rename(columns={solar.columns[0]: \"solar\"}),\n        wind_onshore.rename(columns={wind_onshore.columns[0]: \"wind_onshore\"}),\n        wind_offshore.rename(columns={wind_offshore.columns[0]: \"wind_offshore\"}),\n        total_load.rename(columns={total_load.columns[0]: \"total_load\"}),\n        prices.rename(columns={prices.columns[0]: \"price\"}),\n        nuclear.rename(columns={nuclear.columns[0]: \"nuclear\"}),\n        biomass.rename(columns={biomass.columns[0]: \"biomass\"}),\n        hydro.rename(columns={hydro.columns[0]: \"hydro\"}),\n    ],\n    axis=1,\n)\n\n# Drop rows with missing generation/price data\ndf = df.dropna()\nprint(f\"Combined hourly data: {len(df)} records\")\nprint(f\"Date range: {df.index.min()} to {df.index.max()}\")\n\n\n\n\n\n# Forward-fill SRMC to hourly\n# Normalize index to date only for merging\ndf[\"date\"] = df.index.date\nsrmc_daily_reset = srmc_daily.copy()\nsrmc_daily_reset.index = srmc_daily_reset.index.date\n\ndf = df.merge(\n    srmc_daily_reset[[\"gas_srmc\", \"coal_srmc\"]],\n    left_on=\"date\",\n    right_index=True,\n    how=\"left\",\n)\ndf = df.drop(columns=[\"date\"])\n\n# Forward-fill any gaps in SRMC\ndf[\"gas_srmc\"] = df[\"gas_srmc\"].ffill()\ndf[\"coal_srmc\"] = df[\"coal_srmc\"].ffill()\n\n# Drop rows without SRMC data\ndf = df.dropna(subset=[\"gas_srmc\", \"coal_srmc\"])\nprint(f\"After SRMC merge: {len(df)} records\")\n\n\n\n\n\n# Forward-fill capacities to hourly\n# Capacities are monthly, so we need to reindex and forward-fill\ncapacities_hourly = capacities.reindex(df.index, method=\"ffill\")\n\n# Add relevant capacity columns to main DataFrame\ndf[\"capacity_coal\"] = (\n    capacities_hourly[\"brown_coal\"].fillna(0)\n    + capacities_hourly[\"hard_coal\"].fillna(0)\n)\ndf[\"capacity_gas\"] = capacities_hourly[\"natural_gas\"].fillna(0)\n\n# Drop rows without capacity data\ndf = df.dropna(subset=[\"capacity_coal\", \"capacity_gas\"])\nprint(f\"After capacity merge: {len(df)} records\")\nprint(f\"Final date range: {df.index.min()} to {df.index.max()}\")\n\n\n\n","type":"content","url":"/notebooks/reconstruct-prices#combine-all-data","position":37},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl2":"Calculate Fossil Residual Load"},"type":"lvl2","url":"/notebooks/reconstruct-prices#calculate-fossil-residual-load","position":38},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl2":"Calculate Fossil Residual Load"},"content":"RL_{fossil} = \\text{Load} - (\\text{Wind} + \\text{Solar}) - (\\text{Nuclear} + \\text{Biomass} + \\text{Hydro})\n\n# Calculate components\ndf[\"wind\"] = df[\"wind_onshore\"] + df[\"wind_offshore\"]\ndf[\"renewables\"] = df[\"solar\"] + df[\"wind\"]\ndf[\"baseload\"] = df[\"nuclear\"] + df[\"biomass\"] + df[\"hydro\"]\n\n# Residual load for fossil plants\ndf[\"rl_fossil\"] = df[\"total_load\"] - df[\"renewables\"] - df[\"baseload\"]\n\n# Standard residual load (for comparison)\ndf[\"residual_load\"] = df[\"total_load\"] - df[\"renewables\"]\n\nprint(\"Fossil Residual Load Statistics (MW):\")\nprint(df[\"rl_fossil\"].describe().round(0))\n\n# Count negative fossil residual load hours\nnegative_hours = (df[\"rl_fossil\"] < 0).sum()\nprint(f\"\\nHours with negative RL_fossil: {negative_hours} ({100*negative_hours/len(df):.1f}%)\")\n\n\n\n","type":"content","url":"/notebooks/reconstruct-prices#calculate-fossil-residual-load","position":39},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl2":"Reconstruct Prices Using Merit Order"},"type":"lvl2","url":"/notebooks/reconstruct-prices#reconstruct-prices-using-merit-order","position":40},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl2":"Reconstruct Prices Using Merit Order"},"content":"For each hour:\n\nDetermine which fuel (coal or gas) has lower SRMC\n\nIf fossil residual load can be met by cheaper fuel capacity alone, use cheaper SRMC\n\nOtherwise, use more expensive SRMC as the marginal price\n\ndef reconstruct_price(row):\n    \"\"\"Reconstruct electricity price based on merit order.\"\"\"\n    rl_fossil = row[\"rl_fossil\"]\n    gas_srmc = row[\"gas_srmc\"]\n    coal_srmc = row[\"coal_srmc\"]\n    capacity_coal = row[\"capacity_coal\"]\n    capacity_gas = row[\"capacity_gas\"]\n\n    # Handle negative residual load (renewable surplus)\n    if rl_fossil <= 0:\n        return 0.0  # Price floor at zero for simplicity\n\n    # Determine merit order based on SRMC\n    if coal_srmc <= gas_srmc:\n        # Coal is cheaper\n        cheaper_srmc = coal_srmc\n        expensive_srmc = gas_srmc\n        cheaper_capacity = capacity_coal\n    else:\n        # Gas is cheaper\n        cheaper_srmc = gas_srmc\n        expensive_srmc = coal_srmc\n        cheaper_capacity = capacity_gas\n\n    # Assign price based on which fuel is marginal\n    if rl_fossil <= cheaper_capacity:\n        return cheaper_srmc\n    else:\n        return expensive_srmc\n\n\n\n\n\n# Apply reconstruction\nprint(\"Reconstructing prices...\")\ndf[\"price_reconstructed\"] = df.apply(reconstruct_price, axis=1)\n\nprint(\"\\nReconstructed Price Statistics (EUR/MWh):\")\nprint(df[\"price_reconstructed\"].describe().round(2))\n\nprint(\"\\nActual Price Statistics (EUR/MWh):\")\nprint(df[\"price\"].describe().round(2))\n\n\n\n","type":"content","url":"/notebooks/reconstruct-prices#reconstruct-prices-using-merit-order","position":41},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl2":"Compare Reconstructed vs Actual Prices"},"type":"lvl2","url":"/notebooks/reconstruct-prices#compare-reconstructed-vs-actual-prices","position":42},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl2":"Compare Reconstructed vs Actual Prices"},"content":"\n\n# Time series comparison (monthly averages)\nmonthly = df[[\"price\", \"price_reconstructed\"]].resample(\"ME\").mean()\n\nfig, ax = plt.subplots(figsize=(14, 6))\n\nax.plot(monthly.index, monthly[\"price\"], label=\"Actual Price\", linewidth=2)\nax.plot(\n    monthly.index,\n    monthly[\"price_reconstructed\"],\n    label=\"Reconstructed Price\",\n    linewidth=2,\n    linestyle=\"--\",\n)\n\nax.set_xlabel(\"Date\")\nax.set_ylabel(\"Price (EUR/MWh)\")\nax.set_title(\"Monthly Average: Actual vs Reconstructed Electricity Prices\")\nax.legend()\nax.grid(True, alpha=0.3)\n\nfig.tight_layout()\nfig.savefig(paths.images_path / \"04_actual_vs_reconstructed.png\", dpi=150, bbox_inches=\"tight\")\nplt.show()\n\n\n\n\n\nFigure 5:Monthly Average: Actual vs Reconstructed Electricity Prices\n\n","type":"content","url":"/notebooks/reconstruct-prices#compare-reconstructed-vs-actual-prices","position":43},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl2":"Scatterplots"},"type":"lvl2","url":"/notebooks/reconstruct-prices#scatterplots","position":44},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl2":"Scatterplots"},"content":"\n\n# Sample data for scatterplots (performance)\nsample_size = min(50000, len(df))\nsample = df.sample(sample_size, random_state=42)\n\n\n\n","type":"content","url":"/notebooks/reconstruct-prices#scatterplots","position":45},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl3":"Reconstructed Prices vs Actual Prices","lvl2":"Scatterplots"},"type":"lvl3","url":"/notebooks/reconstruct-prices#reconstructed-prices-vs-actual-prices","position":46},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl3":"Reconstructed Prices vs Actual Prices","lvl2":"Scatterplots"},"content":"\n\nfig, ax = plt.subplots(figsize=(10, 10))\n\nax.scatter(\n    sample[\"price_reconstructed\"],\n    sample[\"price\"],\n    alpha=0.1,\n    s=1,\n)\n\n# Add 45-degree line\nprice_range = [\n    min(sample[\"price\"].min(), sample[\"price_reconstructed\"].min()),\n    max(sample[\"price\"].max(), sample[\"price_reconstructed\"].max()),\n]\nax.plot(price_range, price_range, \"r--\", linewidth=1, label=\"Perfect fit\")\n\nax.set_xlabel(\"Reconstructed Price (EUR/MWh)\")\nax.set_ylabel(\"Actual Price (EUR/MWh)\")\nax.set_title(\"Reconstructed vs Actual Electricity Prices\")\nax.legend()\nax.grid(True, alpha=0.3)\n\n# Add R² annotation\nr2_reconstructed = r2_score(df[\"price\"], df[\"price_reconstructed\"])\nax.text(\n    0.05,\n    0.95,\n    f\"R² = {r2_reconstructed:.3f}\",\n    transform=ax.transAxes,\n    fontsize=12,\n    verticalalignment=\"top\",\n    bbox=dict(boxstyle=\"round\", facecolor=\"wheat\", alpha=0.5),\n)\n\nfig.tight_layout()\nfig.savefig(paths.images_path / \"04_scatter_reconstructed_vs_actual.png\", dpi=150, bbox_inches=\"tight\")\nplt.show()\n\n\n\n\n\nFigure 6:Reconstructed vs Actual Electricity Prices\n\n","type":"content","url":"/notebooks/reconstruct-prices#reconstructed-prices-vs-actual-prices","position":47},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl3":"Residual Load vs Actual Prices","lvl2":"Scatterplots"},"type":"lvl3","url":"/notebooks/reconstruct-prices#residual-load-vs-actual-prices","position":48},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl3":"Residual Load vs Actual Prices","lvl2":"Scatterplots"},"content":"\n\nfig, ax = plt.subplots(figsize=(10, 10))\n\nax.scatter(\n    sample[\"residual_load\"],\n    sample[\"price\"],\n    alpha=0.1,\n    s=1,\n)\n\nax.set_xlabel(\"Residual Load (MW)\")\nax.set_ylabel(\"Actual Price (EUR/MWh)\")\nax.set_title(\"Residual Load vs Electricity Price\")\nax.grid(True, alpha=0.3)\n\n# Add correlation\ncorr = df[\"residual_load\"].corr(df[\"price\"])\nax.text(\n    0.05,\n    0.95,\n    f\"Correlation: {corr:.3f}\",\n    transform=ax.transAxes,\n    fontsize=12,\n    verticalalignment=\"top\",\n    bbox=dict(boxstyle=\"round\", facecolor=\"wheat\", alpha=0.5),\n)\n\nfig.tight_layout()\nfig.savefig(paths.images_path / \"04_scatter_residual_load_vs_price.png\", dpi=150, bbox_inches=\"tight\")\nplt.show()\n\n\n\n\n\nFigure 7:Residual Load vs Electricity Price\n\n","type":"content","url":"/notebooks/reconstruct-prices#residual-load-vs-actual-prices","position":49},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl3":"Fossil Residual Load vs Actual Prices","lvl2":"Scatterplots"},"type":"lvl3","url":"/notebooks/reconstruct-prices#fossil-residual-load-vs-actual-prices","position":50},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl3":"Fossil Residual Load vs Actual Prices","lvl2":"Scatterplots"},"content":"\n\nfig, ax = plt.subplots(figsize=(10, 10))\n\nax.scatter(\n    sample[\"rl_fossil\"],\n    sample[\"price\"],\n    alpha=0.1,\n    s=1,\n)\n\nax.set_xlabel(\"Fossil Residual Load (MW)\")\nax.set_ylabel(\"Actual Price (EUR/MWh)\")\nax.set_title(\"Fossil Residual Load vs Electricity Price\")\nax.grid(True, alpha=0.3)\n\n# Add correlation\ncorr_fossil = df[\"rl_fossil\"].corr(df[\"price\"])\nax.text(\n    0.05,\n    0.95,\n    f\"Correlation: {corr_fossil:.3f}\",\n    transform=ax.transAxes,\n    fontsize=12,\n    verticalalignment=\"top\",\n    bbox=dict(boxstyle=\"round\", facecolor=\"wheat\", alpha=0.5),\n)\n\nfig.tight_layout()\nfig.savefig(paths.images_path / \"04_scatter_fossil_rl_vs_price.png\", dpi=150, bbox_inches=\"tight\")\nplt.show()\n\n\n\n\n\nFigure 8:Fossil Residual Load vs Electricity Price\n\n","type":"content","url":"/notebooks/reconstruct-prices#fossil-residual-load-vs-actual-prices","position":51},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl2":"Variance Explained (R²)"},"type":"lvl2","url":"/notebooks/reconstruct-prices#variance-explained-r","position":52},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl2":"Variance Explained (R²)"},"content":"How much of the price variation is explained by each model?\n\n# Prepare data for regression (drop NaN and infinite values)\ndf_clean = df[[\"price\", \"residual_load\", \"rl_fossil\", \"price_reconstructed\"]].copy()\ndf_clean = df_clean.replace([np.inf, -np.inf], np.nan).dropna()\n\nX_residual = df_clean[[\"residual_load\"]].values\nX_fossil = df_clean[[\"rl_fossil\"]].values\nX_reconstructed = df_clean[[\"price_reconstructed\"]].values\ny = df_clean[\"price\"].values\n\n# Fit linear models\nmodel_residual = LinearRegression().fit(X_residual, y)\nmodel_fossil = LinearRegression().fit(X_fossil, y)\n\n# Calculate R² scores\nr2_residual = model_residual.score(X_residual, y)\nr2_fossil = model_fossil.score(X_fossil, y)\nr2_reconstructed = r2_score(y, df_clean[\"price_reconstructed\"].values)\n\nprint(\"=\" * 60)\nprint(\"VARIANCE EXPLAINED (R²)\")\nprint(\"=\" * 60)\nprint(f\"\\nResidual Load (linear regression):      R² = {r2_residual:.4f}\")\nprint(f\"Fossil Residual Load (linear regression): R² = {r2_fossil:.4f}\")\nprint(f\"Reconstructed Prices (merit order model): R² = {r2_reconstructed:.4f}\")\nprint()\n\n\n\n","type":"content","url":"/notebooks/reconstruct-prices#variance-explained-r","position":53},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl2":"Summary Statistics"},"type":"lvl2","url":"/notebooks/reconstruct-prices#summary-statistics","position":54},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl2":"Summary Statistics"},"content":"\n\n# Calculate additional metrics\nmae = np.abs(df_clean[\"price\"] - df_clean[\"price_reconstructed\"]).mean()\nrmse = np.sqrt(((df_clean[\"price\"] - df_clean[\"price_reconstructed\"]) ** 2).mean())\n\nprint(\"=\" * 60)\nprint(\"MODEL PERFORMANCE SUMMARY\")\nprint(\"=\" * 60)\nprint(f\"\\nMean Absolute Error (MAE):     {mae:.2f} EUR/MWh\")\nprint(f\"Root Mean Square Error (RMSE): {rmse:.2f} EUR/MWh\")\nprint(f\"\\nActual price mean:        {df_clean['price'].mean():.2f} EUR/MWh\")\nprint(f\"Reconstructed price mean: {df_clean['price_reconstructed'].mean():.2f} EUR/MWh\")\nprint()\n\n\n\n","type":"content","url":"/notebooks/reconstruct-prices#summary-statistics","position":55},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl2":"Comparison Chart: What Explains Price Variation?"},"type":"lvl2","url":"/notebooks/reconstruct-prices#comparison-chart-what-explains-price-variation","position":56},{"hierarchy":{"lvl1":"Fossil Fuel Costs and Electricity Price Reconstruction","lvl2":"Comparison Chart: What Explains Price Variation?"},"content":"\n\nfig, ax = plt.subplots(figsize=(10, 6))\n\nmodels = [\"Residual Load\\n(Linear)\", \"Fossil RL\\n(Linear)\", \"Merit Order\\n(Reconstructed)\"]\nr2_values = [r2_residual, r2_fossil, r2_reconstructed]\ncolors = [\"#3498db\", \"#2ecc71\", \"#e74c3c\"]\n\nbars = ax.bar(models, r2_values, color=colors, edgecolor=\"black\", linewidth=1.2)\n\n# Add value labels on bars\nfor bar, val in zip(bars, r2_values):\n    height = bar.get_height()\n    ax.text(\n        bar.get_x() + bar.get_width() / 2.0,\n        height + 0.01,\n        f\"{val:.3f}\",\n        ha=\"center\",\n        va=\"bottom\",\n        fontsize=12,\n        fontweight=\"bold\",\n    )\n\nax.set_ylabel(\"R² (Variance Explained)\")\nax.set_title(\"How Much Price Variation is Explained?\")\nax.set_ylim(0, 1.0)\nax.grid(True, alpha=0.3, axis=\"y\")\n\nfig.tight_layout()\nfig.savefig(paths.images_path / \"04_r2_comparison.png\", dpi=150, bbox_inches=\"tight\")\nplt.show()\n\n\n\n\n\nFigure 9:How Much Price Variation is Explained?","type":"content","url":"/notebooks/reconstruct-prices#comparison-chart-what-explains-price-variation","position":57},{"hierarchy":{"lvl1":"Seasonality Heatmaps"},"type":"lvl1","url":"/notebooks/load-seasonalities","position":0},{"hierarchy":{"lvl1":"Seasonality Heatmaps"},"content":"Heatmaps of hour of day vs day of year reveal the combined diurnal and seasonal\npatterns in generation, load, and prices across Germany’s electricity system.\n\nimport pandas as pd\nimport matplotlib.pyplot as plt\n\nfrom woe.paths import ProjPaths\n\n\n\n# Load all data files\npaths = ProjPaths()\n\nsolar = pd.read_parquet(paths.smard_solar_file)\nwind_onshore = pd.read_parquet(paths.smard_wind_onshore_file)\nwind_offshore = pd.read_parquet(paths.smard_wind_offshore_file)\ntotal_load = pd.read_parquet(paths.smard_total_load_file)\nprices = pd.read_parquet(paths.smard_prices_file)\n\n\n\n# Combine into single DataFrame\ndf = pd.concat([\n    solar.rename(columns={solar.columns[0]: \"solar\"}),\n    wind_onshore.rename(columns={wind_onshore.columns[0]: \"wind_onshore\"}),\n    wind_offshore.rename(columns={wind_offshore.columns[0]: \"wind_offshore\"}),\n    total_load.rename(columns={total_load.columns[0]: \"total_load\"}),\n    prices.rename(columns={prices.columns[0]: \"price\"}),\n], axis=1)\n\ndf = df.dropna()\n\n# Derived columns\ndf[\"renewables\"] = df[\"solar\"] + df[\"wind_onshore\"] + df[\"wind_offshore\"]\ndf[\"residual_load\"] = df[\"total_load\"] - df[\"renewables\"]\ndf[\"wind\"] = df[\"wind_onshore\"] + df[\"wind_offshore\"]\ndf[\"hour\"] = df.index.hour\ndf[\"dayofyear\"] = df.index.dayofyear\n\nprint(f\"Combined data: {len(df)} records\")\nprint(f\"Date range: {df.index.min()} to {df.index.max()}\")\n\n\n\n# Heatmap helper\nmonth_starts = [1, 32, 60, 91, 121, 152, 182, 213, 244, 274, 305, 335]\nmonth_labels = [\"Jan\", \"Feb\", \"Mar\", \"Apr\", \"May\", \"Jun\", \"Jul\", \"Aug\", \"Sep\", \"Oct\", \"Nov\", \"Dec\"]\n\n\ndef plot_heatmap(df, column, title, cmap, unit, diverging=False, save_name=None):\n    \"\"\"Plot a heatmap of hour of day vs day of year.\"\"\"\n    pivot = df.groupby([\"dayofyear\", \"hour\"])[column].mean().unstack(level=0)\n\n    fig, ax = plt.subplots(figsize=(14, 6))\n\n    vmin, vmax = pivot.min().min(), pivot.max().max()\n    if diverging:\n        abs_max = max(abs(vmin), abs(vmax))\n        vmin, vmax = -abs_max, abs_max\n\n    im = ax.pcolormesh(\n        pivot.columns,\n        pivot.index,\n        pivot.values,\n        cmap=cmap,\n        shading=\"auto\",\n        vmin=vmin,\n        vmax=vmax,\n    )\n    cbar = fig.colorbar(im, ax=ax, pad=0.02)\n    cbar.set_label(unit)\n\n    ax.set_xlabel(\"Month\")\n    ax.set_ylabel(\"Hour of Day\")\n    ax.set_title(title)\n    ax.set_xticks(month_starts)\n    ax.set_xticklabels(month_labels)\n    ax.set_yticks(range(0, 24, 3))\n    ax.invert_yaxis()\n\n    fig.tight_layout()\n    if save_name:\n        fig.savefig(paths.images_path / save_name, dpi=150, bbox_inches=\"tight\")\n    plt.show()\n\n\n\n","type":"content","url":"/notebooks/load-seasonalities","position":1},{"hierarchy":{"lvl1":"Seasonality Heatmaps","lvl2":"Solar Generation"},"type":"lvl2","url":"/notebooks/load-seasonalities#solar-generation","position":2},{"hierarchy":{"lvl1":"Seasonality Heatmaps","lvl2":"Solar Generation"},"content":"Solar output peaks around midday in summer months. The heatmap clearly shows\nzero generation at night and the seasonal shift in daylight hours.\n\nplot_heatmap(df, \"solar\", \"Average Solar Generation (Hour vs Day of Year)\", \"YlOrRd\", \"MW\",\n             save_name=\"05_seasonality_solar.png\")\n\n\n\n\n\nFigure 1:Average solar generation by hour of day and day of year\n\n","type":"content","url":"/notebooks/load-seasonalities#solar-generation","position":3},{"hierarchy":{"lvl1":"Seasonality Heatmaps","lvl2":"Wind Generation"},"type":"lvl2","url":"/notebooks/load-seasonalities#wind-generation","position":4},{"hierarchy":{"lvl1":"Seasonality Heatmaps","lvl2":"Wind Generation"},"content":"Wind generation (onshore + offshore) tends to be higher in winter and shows\nless pronounced diurnal patterns compared to solar.\n\nplot_heatmap(df, \"wind\", \"Average Wind Generation (Hour vs Day of Year)\", \"YlGnBu\", \"MW\",\n             save_name=\"05_seasonality_wind.png\")\n\n\n\n\n\nFigure 2:Average wind generation by hour of day and day of year\n\n","type":"content","url":"/notebooks/load-seasonalities#wind-generation","position":5},{"hierarchy":{"lvl1":"Seasonality Heatmaps","lvl2":"Aggregate Renewable Generation"},"type":"lvl2","url":"/notebooks/load-seasonalities#aggregate-renewable-generation","position":6},{"hierarchy":{"lvl1":"Seasonality Heatmaps","lvl2":"Aggregate Renewable Generation"},"content":"The combined solar and wind heatmap reveals the complementary nature of these\nsources: solar dominates summer midday, wind dominates winter.\n\nplot_heatmap(df, \"renewables\", \"Average Renewable Generation (Hour vs Day of Year)\", \"YlGn\", \"MW\",\n             save_name=\"05_seasonality_renewables.png\")\n\n\n\n\n\nFigure 3:Average aggregate renewable generation by hour of day and day of year\n\n","type":"content","url":"/notebooks/load-seasonalities#aggregate-renewable-generation","position":7},{"hierarchy":{"lvl1":"Seasonality Heatmaps","lvl2":"Electricity Load"},"type":"lvl2","url":"/notebooks/load-seasonalities#electricity-load","position":8},{"hierarchy":{"lvl1":"Seasonality Heatmaps","lvl2":"Electricity Load"},"content":"Load follows a clear double-peak pattern (morning and evening) with lower\ndemand on summer middays and overnight. Winter months show higher overall load.\n\nplot_heatmap(df, \"total_load\", \"Average Electricity Load (Hour vs Day of Year)\", \"inferno\", \"MW\",\n             save_name=\"05_seasonality_load.png\")\n\n\n\n\n\nFigure 4:Average electricity load by hour of day and day of year\n\n","type":"content","url":"/notebooks/load-seasonalities#electricity-load","position":9},{"hierarchy":{"lvl1":"Seasonality Heatmaps","lvl2":"Residual Load"},"type":"lvl2","url":"/notebooks/load-seasonalities#residual-load","position":10},{"hierarchy":{"lvl1":"Seasonality Heatmaps","lvl2":"Residual Load"},"content":"The residual load heatmap highlights when conventional generation is most needed\n(red) and when renewable surpluses occur (blue). Negative values in summer\nmidday reflect solar overproduction.\n\nplot_heatmap(df, \"residual_load\", \"Average Residual Load (Hour vs Day of Year)\", \"RdBu_r\", \"MW\",\n             diverging=True, save_name=\"05_seasonality_residual_load.png\")\n\n\n\n\n\nFigure 5:Average residual load by hour of day and day of year\n\n","type":"content","url":"/notebooks/load-seasonalities#residual-load","position":11},{"hierarchy":{"lvl1":"Seasonality Heatmaps","lvl2":"Electricity Price"},"type":"lvl2","url":"/notebooks/load-seasonalities#electricity-price","position":12},{"hierarchy":{"lvl1":"Seasonality Heatmaps","lvl2":"Electricity Price"},"content":"Price patterns mirror residual load closely. Low or negative prices appear\nduring summer midday (solar surplus), while winter evening peaks drive the\nhighest prices.\n\nplot_heatmap(df, \"price\", \"Average Electricity Price (Hour vs Day of Year)\", \"RdBu_r\", \"EUR/MWh\",\n             diverging=True, save_name=\"05_seasonality_price.png\")\n\n\n\n\n\nFigure 6:Average electricity price by hour of day and day of year\n\nfrom datetime import datetime\nfrom IPython.display import Markdown\n\nMarkdown(f\"Last run: {datetime.now().strftime('%Y-%m-%d')}\")\n\n","type":"content","url":"/notebooks/load-seasonalities#electricity-price","position":13},{"hierarchy":{"lvl1":"Earth’s Seasons — From Sunlight to Vegetation"},"type":"lvl1","url":"/notebooks/earth-seasons","position":0},{"hierarchy":{"lvl1":"Earth’s Seasons — From Sunlight to Vegetation"},"content":"Why do we have seasons? The answer lies in a single geometric fact: the\nEarth’s rotation axis is tilted by about 23.4° relative to the plane of\nits orbit around the Sun. As the Earth travels along its annual orbit, this\ntilt causes different hemispheres to lean toward or away from the Sun,\nchanging both the angle at which sunlight strikes the surface and the\nnumber of hours of daylight each location receives.\n\nThis chapter traces the chain of consequences:\n\nSunlight geometry — how the Sun illuminates different parts of the\nEarth during the day, and how this pattern shifts between summer and winter.\n\nThe subsolar point — the latitude where the Sun is directly overhead,\nand how it migrates between the Tropics over the year.\n\nSolar elevation — the angle of the Sun above the horizon for any\nlocation and time, which determines how concentrated the incoming energy is.\n\nTemperature — how the uneven distribution of sunlight drives the\nglobal temperature pattern, both over the course of a day and across seasons.\n\nVegetation — how the resulting temperature and moisture patterns\ncontrol where and when vegetation grows, visible from space as a seasonal\n“green wave”.\n\nimport calendar\nimport math\nimport os\nfrom datetime import datetime, date, timedelta\n\nimport numpy as np\nimport matplotlib.pyplot as plt\nimport cartopy.crs as ccrs\nimport cartopy.feature as cfeature\nfrom cartopy.feature.nightshade import Nightshade\nfrom matplotlib.animation import FuncAnimation, PillowWriter\nfrom PIL import Image, ImageDraw\n\nfrom woe.paths import ProjPaths\n\npaths = ProjPaths()\n\n\n\n","type":"content","url":"/notebooks/earth-seasons","position":1},{"hierarchy":{"lvl1":"Earth’s Seasons — From Sunlight to Vegetation","lvl2":"Sunlight on Earth — the day cycle"},"type":"lvl2","url":"/notebooks/earth-seasons#sunlight-on-earth-the-day-cycle","position":2},{"hierarchy":{"lvl1":"Earth’s Seasons — From Sunlight to Vegetation","lvl2":"Sunlight on Earth — the day cycle"},"content":"At any given moment, exactly half of the Earth is illuminated by the Sun.\nBut the angle at which sunlight arrives varies enormously by latitude and\ntime of day. Near the equator, sunlight can arrive nearly vertically,\nconcentrating its energy on a small area. Near the poles, it arrives at a\nshallow angle, spreading the same energy over a much larger area — which\nis why polar regions are cold even when they receive 24 hours of daylight in\nsummer.\n\nThe two animations below show the illumination pattern over 24 hours on\nthe summer solstice (June 21) and the winter solstice (December 21).\nThe contrast is striking: in June, the North Pole enjoys continuous daylight\nwhile the South Pole is in complete darkness. In December, the situation is\nreversed.\n\ndates = [datetime(2025, 6, 21), datetime(2025, 12, 21)]\nn_frames = 64\nframe_hours = np.linspace(0, 24, n_frames, endpoint=False)\n\n\ndef create_sunlight_animation(anim_date, output_path):\n    fig, ax = plt.subplots(figsize=(16, 9), subplot_kw={\"projection\": ccrs.Robinson()})\n    fig.patch.set_facecolor(\"black\")\n\n    def draw_frame(fractional_hour):\n        ax.clear()\n        h = int(fractional_hour)\n        m = int((fractional_hour - h) * 60)\n        obs_time = datetime(anim_date.year, anim_date.month, anim_date.day, h, m, 0)\n\n        # Solar geometry\n        day_of_year = obs_time.timetuple().tm_yday\n        declination = 23.44 * np.sin(np.radians(360 / 365 * (day_of_year - 81)))\n        hours_utc = obs_time.hour + obs_time.minute / 60\n        subsolar_lon = 180 - (hours_utc / 24) * 360\n\n        ax.stock_img()\n        ax.add_feature(Nightshade(obs_time, alpha=0.4))\n\n        # Subsolar point marker\n        ax.plot(\n            subsolar_lon, declination,\n            marker=\"*\", markersize=18, color=\"yellow\", markeredgecolor=\"orange\",\n            markeredgewidth=0.8, transform=ccrs.PlateCarree(), zorder=10,\n        )\n\n        # Declination latitude line\n        ax.plot(\n            [-180, 180], [declination, declination],\n            color=\"yellow\", linewidth=1.2, linestyle=\"--\", alpha=0.7,\n            transform=ccrs.PlateCarree(), zorder=9,\n        )\n        # Equator\n        ax.plot(\n            [-180, 180], [0, 0],\n            color=\"white\", linewidth=0.6, linestyle=\":\", alpha=0.5,\n            transform=ccrs.PlateCarree(), zorder=9,\n        )\n\n        ax.add_feature(cfeature.COASTLINE, linewidth=0.4, color=\"0.3\")\n        ax.set_global()\n        ax.set_facecolor(\"black\")\n        ax.set_title(\n            f\"Sunlight on Earth — {obs_time:%Y-%m-%d %H:%M} UTC — \"\n            f\"Subsolar point {declination:.1f}°N, {subsolar_lon:.1f}°E\",\n            fontsize=13, color=\"white\", pad=12,\n        )\n\n    anim = FuncAnimation(fig, draw_frame, frames=list(frame_hours), interval=1000 / 15)\n    anim.save(str(output_path), writer=PillowWriter(fps=15), dpi=120, savefig_kwargs={\"facecolor\": \"black\"})\n    plt.close(fig)\n    print(f\"Saved animation to {output_path}\")\n\n\nfor d in dates:\n    suffix = f\"{d:%Y_%m_%d}\"\n    create_sunlight_animation(d, paths.images_path / f\"10_sunlight_animation_{suffix}.gif\")\n\n\n\n\n\nFigure 1:Sunlight on Earth over 24 hours on 2025-06-21 (summer solstice). The yellow\nstar marks the subsolar point; the dashed line shows the solar declination\nlatitude (~23.4°N). Notice that the Arctic never enters darkness.\n\n\n\nFigure 2:Winter solstice (2025-12-21). The subsolar point has moved to ~23.4°S.\nNow it is the Antarctic that enjoys continuous daylight, while the Arctic\nremains in polar night.\n\n","type":"content","url":"/notebooks/earth-seasons#sunlight-on-earth-the-day-cycle","position":3},{"hierarchy":{"lvl1":"Earth’s Seasons — From Sunlight to Vegetation","lvl2":"The subsolar point and its annual migration"},"type":"lvl2","url":"/notebooks/earth-seasons#the-subsolar-point-and-its-annual-migration","position":4},{"hierarchy":{"lvl1":"Earth’s Seasons — From Sunlight to Vegetation","lvl2":"The subsolar point and its annual migration"},"content":"The subsolar point is the location on Earth where the Sun is directly\noverhead — i.e. the solar elevation is exactly 90°. Its latitude equals the\nsolar declination, which can be approximated as:\\delta = 23.44° \\times \\sin\\!\\left(\\frac{360°}{365} \\times (d - 81)\\right)\n\nwhere d is the day of the year (so d = 81 corresponds to the spring\nequinox around March 22, when \\delta = 0).\n\nOver the course of a year, the subsolar latitude oscillates between the\nTropic of Cancer (~23.4°N, around June 21) and the Tropic of\nCapricorn (~23.4°S, around December 21). The animation below shows one\nframe per week, tracing this migration at solar noon (12:00 UTC).\n\nweeks = np.arange(0, 52)\nweek_dates = [datetime(2025, 1, 1) + timedelta(weeks=int(w)) for w in weeks]\n\nfig, ax = plt.subplots(figsize=(16, 9), subplot_kw={\"projection\": ccrs.Robinson()})\nfig.patch.set_facecolor(\"black\")\n\n\ndef draw_subsolar_frame(i):\n    ax.clear()\n    d = week_dates[i]\n    obs_time = datetime(d.year, d.month, d.day, 12, 0, 0)\n\n    day_of_year = obs_time.timetuple().tm_yday\n    declination = 23.44 * np.sin(np.radians(360 / 365 * (day_of_year - 81)))\n    subsolar_lon = 0.0  # at 12:00 UTC\n\n    ax.stock_img()\n    ax.add_feature(Nightshade(obs_time, alpha=0.3))\n\n    # Declination latitude line\n    ax.plot(\n        [-180, 180], [declination, declination],\n        color=\"yellow\", linewidth=2, linestyle=\"--\", alpha=0.9,\n        transform=ccrs.PlateCarree(), zorder=9,\n    )\n    # Subsolar point\n    ax.plot(\n        subsolar_lon, declination,\n        marker=\"*\", markersize=20, color=\"yellow\", markeredgecolor=\"orange\",\n        markeredgewidth=0.8, transform=ccrs.PlateCarree(), zorder=10,\n    )\n\n    # Tropic lines\n    for tropic_lat in [23.44, -23.44]:\n        ax.plot(\n            [-180, 180], [tropic_lat, tropic_lat],\n            color=\"white\", linewidth=0.5, linestyle=\":\", alpha=0.4,\n            transform=ccrs.PlateCarree(), zorder=8,\n        )\n    # Equator\n    ax.plot(\n        [-180, 180], [0, 0],\n        color=\"white\", linewidth=0.6, linestyle=\":\", alpha=0.5,\n        transform=ccrs.PlateCarree(), zorder=8,\n    )\n\n    ax.add_feature(cfeature.COASTLINE, linewidth=0.4, color=\"0.3\")\n    ax.set_global()\n    ax.set_facecolor(\"black\")\n    ax.set_title(\n        f\"Subsolar Latitude — {obs_time:%Y-%m-%d} (week {i + 1}/52) — \"\n        f\"Declination {declination:.1f}°{'N' if declination >= 0 else 'S'}\",\n        fontsize=13, color=\"white\", pad=12,\n    )\n\n\nanim = FuncAnimation(fig, draw_subsolar_frame, frames=len(week_dates), interval=1000 / 15)\noutput_file = paths.images_path / \"10_subsolar_migration.gif\"\nanim.save(str(output_file), writer=PillowWriter(fps=15), dpi=120, savefig_kwargs={\"facecolor\": \"black\"})\nplt.close(fig)\nprint(f\"Saved animation to {output_file}\")\n\n\n\n\n\nFigure 3:Migration of the subsolar latitude over the year (one frame per week). The\nyellow dashed line shows where the Sun is directly overhead at noon UTC. It\noscillates between the Tropic of Cancer (~23.4°N in June) and the Tropic of\nCapricorn (~23.4°S in December).\n\n","type":"content","url":"/notebooks/earth-seasons#the-subsolar-point-and-its-annual-migration","position":5},{"hierarchy":{"lvl1":"Earth’s Seasons — From Sunlight to Vegetation","lvl2":"Solar elevation — the Sun’s angle above the horizon"},"type":"lvl2","url":"/notebooks/earth-seasons#solar-elevation-the-suns-angle-above-the-horizon","position":6},{"hierarchy":{"lvl1":"Earth’s Seasons — From Sunlight to Vegetation","lvl2":"Solar elevation — the Sun’s angle above the horizon"},"content":"The solar elevation (or altitude angle) is the angle of the Sun above\nthe horizon, measured from 0° (sunrise/sunset) to 90° (directly overhead).\nIt determines how much energy a square metre of surface receives: a high\nSun concentrates light into a small area, while a low Sun spreads it thin.\n\nFor any location (latitude \\varphi) and time, the elevation \\alpha is:\\sin(\\alpha) = \\sin(\\varphi)\\,\\sin(\\delta) + \\cos(\\varphi)\\,\\cos(\\delta)\\,\\cos(h)\n\nwhere \\delta is the solar declination (computed above) and h is the\nhour angle — the Sun’s angular displacement from local solar noon\n(h = 0 at noon, 15° per hour).\n\nThe heatmaps below show solar elevation for every day of the year and every\nminute of the day, for two cities at very different latitudes: Munich\n(48.1°N) and Sydney (33.9°S). Grey areas indicate nighttime (elevation\nbelow 0°).\n\nlocations = [\n    {\"name\": \"Munich\", \"lat\": 48.14, \"lon\": 11.58, \"utc_offset\": 1, \"tz_label\": \"CET\"},\n    {\"name\": \"Sydney\", \"lat\": -33.87, \"lon\": 151.21, \"utc_offset\": 11, \"tz_label\": \"AEDT\"},\n]\n\ndays = np.arange(1, 366)\nhours_of_day = np.arange(0, 24, 1 / 60)  # one-minute resolution\nday_grid, hour_grid = np.meshgrid(days, hours_of_day)\n\n# Solar declination (same for all locations)\ndeclination_rad = np.radians(\n    23.44 * np.sin(np.radians(360 / 365 * (day_grid - 81)))\n)\n\nmonth_starts = [1, 32, 60, 91, 121, 152, 182, 213, 244, 274, 305, 335]\nmonth_labels = [\"Jan\", \"Feb\", \"Mar\", \"Apr\", \"May\", \"Jun\",\n                \"Jul\", \"Aug\", \"Sep\", \"Oct\", \"Nov\", \"Dec\"]\n\nfor loc in locations:\n    lat_rad = np.radians(loc[\"lat\"])\n\n    local_hours = hours_of_day\n    utc_hours = local_hours - loc[\"utc_offset\"]\n    day_grid_loc, utc_hour_grid = np.meshgrid(days, utc_hours)\n    _, local_hour_grid = np.meshgrid(days, local_hours)\n\n    # Hour angle: sun's angular displacement from solar noon\n    solar_hour = utc_hour_grid + loc[\"lon\"] / 15\n    hour_angle_rad = np.radians(15 * (solar_hour - 12))\n\n    # Solar elevation\n    sin_elev = (\n        np.sin(lat_rad) * np.sin(declination_rad)\n        + np.cos(lat_rad) * np.cos(declination_rad) * np.cos(hour_angle_rad)\n    )\n    elevation_deg = np.degrees(np.arcsin(np.clip(sin_elev, -1, 1)))\n    elevation_deg = np.where(elevation_deg < 0, np.nan, elevation_deg)\n\n    fig, ax = plt.subplots(figsize=(14, 6))\n\n    cmap = plt.cm.YlOrRd.copy()\n    cmap.set_bad(\"0.15\")\n\n    im = ax.pcolormesh(\n        day_grid_loc, local_hour_grid, elevation_deg,\n        cmap=cmap, vmin=0, vmax=70, shading=\"auto\",\n    )\n\n    cb = fig.colorbar(im, ax=ax, pad=0.02)\n    cb.set_label(\"Solar elevation (°)\", fontsize=11)\n\n    ax.set_xticks(month_starts)\n    ax.set_xticklabels(month_labels)\n    ax.set_yticks(range(0, 25, 3))\n    ax.set_ylabel(f\"Hour of day ({loc['tz_label']}, UTC{loc['utc_offset']:+d})\", fontsize=11)\n    ax.set_xlabel(\"Day of year\", fontsize=11)\n    ax.set_title(\n        f\"Solar Elevation — {loc['name']} ({abs(loc['lat']):.1f}°{'N' if loc['lat'] >= 0 else 'S'}, \"\n        f\"{abs(loc['lon']):.1f}°{'E' if loc['lon'] >= 0 else 'W'})\",\n        fontsize=13,\n    )\n\n    fig.tight_layout()\n    filename = f\"10_elevation_heatmap_{loc['name'].lower()}.png\"\n    fig.savefig(paths.images_path / filename, dpi=150, bbox_inches=\"tight\")\n    plt.show()\n\n\n\n\n\nFigure 4:Solar elevation at Munich (48.1°N, 11.6°E) for every day and minute of\nthe year. In summer, the Sun reaches ~65° and daylight lasts over 16 hours.\nIn winter, the maximum elevation drops to ~18° with less than 8 hours of\ndaylight. Grey areas indicate nighttime.\n\n\n\nFigure 5:Solar elevation at Sydney (33.9°S, 151.2°E). Being in the Southern\nHemisphere, Sydney’s seasons are inverted — longest days around December,\nshortest in June. The higher maximum elevation (~80°) reflects its lower\nlatitude compared to Munich, and the seasonal daylight variation is less\nextreme.\n\n","type":"content","url":"/notebooks/earth-seasons#solar-elevation-the-suns-angle-above-the-horizon","position":7},{"hierarchy":{"lvl1":"Earth’s Seasons — From Sunlight to Vegetation","lvl2":"Global temperatures — the diurnal cycle"},"type":"lvl2","url":"/notebooks/earth-seasons#global-temperatures-the-diurnal-cycle","position":8},{"hierarchy":{"lvl1":"Earth’s Seasons — From Sunlight to Vegetation","lvl2":"Global temperatures — the diurnal cycle"},"content":"The varying sunlight intensity directly drives temperature patterns across\nthe globe. To observe this, we use ERA5 reanalysis data — a global\ngridded dataset produced by the European Centre for Medium-Range Weather\nForecasts (ECMWF) that combines weather observations with numerical models.\nThe variable shown is 2-metre temperature (the air temperature at 2 m\nabove the surface), which is the standard measure of surface air temperature.\n\nNote that this dataset is ERA5-Land, which only covers land surfaces —\noceans appear black (no data). A key feature visible in the animation is how\nquickly continents heat and cool: land has a low heat capacity, so\ntemperatures swing sharply between day and night. Oceans, by contrast, change\ntemperature much more slowly, which is why coastal cities have milder\nclimates than continental interiors.\n\nimport ee\nimport geemap\nfrom dotenv import load_dotenv\n\nload_dotenv()\nee.Initialize(project=os.environ[\"EE_GCP_PROJECT_ID\"])\n\n\n\n\n\nera5 = ee.ImageCollection(\"ECMWF/ERA5_LAND/HOURLY\").select(\"temperature_2m\")\n\nstart = \"2024-01-01\"\nend = \"2025-01-01\"\nera5_year = era5.filterDate(start, end)\n\n# Build a 24-image collection: one mean image per UTC hour\nhourly_images = []\nfor hour in range(24):\n    hourly_mean = (\n        era5_year\n        .filter(ee.Filter.calendarRange(hour, hour, \"hour\"))\n        .mean()\n        .subtract(273.15)  # K -> °C\n    )\n    hourly_mean = hourly_mean.set(\"hour\", hour).set(\"label\", f\"{hour:02d}:00 UTC\")\n    hourly_images.append(hourly_mean)\n\ncol = ee.ImageCollection(hourly_images)\nprint(f\"Collection size: {col.size().getInfo()} images\")\n\n\n\n\n\nvis_params = {\n    \"min\": -40,\n    \"max\": 40,\n    \"palette\": [\n        \"#313695\", \"#4575b4\", \"#74add1\", \"#abd9e9\",\n        \"#e0f3f8\", \"#ffffbf\", \"#fee090\", \"#fdae61\",\n        \"#f46d43\", \"#d73027\", \"#a50026\",\n    ],\n    \"dimensions\": 800,\n    \"framesPerSecond\": 3,\n}\n\ngif_path = str(paths.images_path / \"10_ee_temperature_by_hour.gif\")\n\ngeemap.download_ee_video(col, vis_params, gif_path)\nprint(f\"GIF saved to {gif_path}\")\n\n\n\n\n\nlabels = [f\"{h:02d}:00 UTC\" for h in range(24)]\n\ngeemap.add_text_to_gif(\n    gif_path,\n    gif_path,\n    xy=(\"5%\", \"90%\"),\n    text_sequence=labels,\n    font_size=20,\n    font_color=\"white\",\n    add_progress_bar=True,\n    progress_bar_color=\"cyan\",\n    progress_bar_height=5,\n)\nprint(f\"Annotated GIF saved to {gif_path}\")\n\n\n\n\n\nFigure 6:Average 2-metre temperature by hour of day (UTC), computed from a full year\nof ERA5-Land reanalysis data. The “heat wave” sweeps westward as the Sun\nmoves, and the large day-night temperature swing over continents is clearly\nvisible. Oceans appear black because ERA5-Land only covers land surfaces.\n\n","type":"content","url":"/notebooks/earth-seasons#global-temperatures-the-diurnal-cycle","position":9},{"hierarchy":{"lvl1":"Earth’s Seasons — From Sunlight to Vegetation","lvl2":"Global temperatures — the seasonal cycle"},"type":"lvl2","url":"/notebooks/earth-seasons#global-temperatures-the-seasonal-cycle","position":10},{"hierarchy":{"lvl1":"Earth’s Seasons — From Sunlight to Vegetation","lvl2":"Global temperatures — the seasonal cycle"},"content":"Over the course of months, the sustained difference in sunlight between\nhemispheres creates the familiar seasons. Note that temperature extremes\ntypically lag the solstices by about 4–6 weeks — this thermal lag occurs\nbecause the Earth’s surface and atmosphere take time to heat up and cool\ndown, similar to how the hottest part of the day is usually mid-afternoon\nrather than noon.\n\nThe ocean again plays a moderating role: maritime and coastal climates have\nmilder seasonal swings, while continental interiors (like Siberia or central\nCanada) experience the most extreme temperature differences between summer\nand winter.\n\nmonthly_images = []\nmonthly_labels = []\nfor month in range(1, 13):\n    month_slices = []\n    for year in range(2022, 2025):\n        days_in_month = calendar.monthrange(year, month)[1]\n        m_start = f\"{year}-{month:02d}-01\"\n        m_end = f\"{year}-{month:02d}-{days_in_month:02d}T23:59\"\n        month_slices.append(\n            era5.filterDate(m_start, m_end)\n            .filter(ee.Filter.calendarRange(12, 12, \"hour\"))\n        )\n    merged = month_slices[0]\n    for s in month_slices[1:]:\n        merged = merged.merge(s)\n    monthly_mean = merged.mean().subtract(273.15)\n    label = calendar.month_abbr[month]\n    monthly_mean = monthly_mean.set(\"month\", month).set(\"label\", label)\n    monthly_images.append(monthly_mean)\n    monthly_labels.append(label)\n\ncol_monthly = ee.ImageCollection(monthly_images)\nprint(f\"Monthly collection size: {col_monthly.size().getInfo()} images\")\n\n\n\n\n\nvis_params_monthly = {\n    \"min\": -40,\n    \"max\": 40,\n    \"palette\": [\n        \"#313695\", \"#4575b4\", \"#74add1\", \"#abd9e9\",\n        \"#e0f3f8\", \"#ffffbf\", \"#fee090\", \"#fdae61\",\n        \"#f46d43\", \"#d73027\", \"#a50026\",\n    ],\n    \"dimensions\": 600,\n    \"framesPerSecond\": 1,\n}\n\ngif_monthly_path = str(paths.images_path / \"10_ee_temperature_by_month.gif\")\n\ngeemap.download_ee_video(col_monthly, vis_params_monthly, gif_monthly_path)\nprint(f\"Monthly GIF saved to {gif_monthly_path}\")\n\n\n\n\n\ngeemap.add_text_to_gif(\n    gif_monthly_path,\n    gif_monthly_path,\n    xy=(\"5%\", \"90%\"),\n    text_sequence=monthly_labels,\n    font_size=20,\n    font_color=\"white\",\n    add_progress_bar=True,\n    progress_bar_color=\"cyan\",\n    progress_bar_height=5,\n)\nprint(f\"Annotated monthly GIF saved to {gif_monthly_path}\")\n\n\n\n\n\nFigure 7:Average 2-metre temperature by month, computed from ERA5-Land noon snapshots\nacross 2022–2024. The hemispheric temperature contrast shifts as the\nsubsolar latitude migrates. Continental interiors show the most extreme\nseasonal swings. Oceans are not shown (ERA5-Land covers land only).\n\n","type":"content","url":"/notebooks/earth-seasons#global-temperatures-the-seasonal-cycle","position":11},{"hierarchy":{"lvl1":"Earth’s Seasons — From Sunlight to Vegetation","lvl2":"Vegetation — the seasonal green wave"},"type":"lvl2","url":"/notebooks/earth-seasons#vegetation-the-seasonal-green-wave","position":12},{"hierarchy":{"lvl1":"Earth’s Seasons — From Sunlight to Vegetation","lvl2":"Vegetation — the seasonal green wave"},"content":"The temperature and moisture patterns driven by the Sun’s position have a\ndirect and visible impact on vegetation. We can observe this from space\nusing the Normalized Difference Vegetation Index (NDVI), computed from\nsatellite imagery as:\\text{NDVI} = \\frac{\\text{NIR} - \\text{Red}}{\\text{NIR} + \\text{Red}}\n\nwhere NIR is near-infrared reflectance and Red is visible red reflectance.\nHealthy green vegetation strongly reflects near-infrared light (which\nit doesn’t need) and absorbs red light (which it uses for\nphotosynthesis). This makes NDVI a reliable indicator of vegetation health:\n\nNDVI > 0.6 — dense, healthy vegetation (tropical forests, croplands\nin growing season)\n\nNDVI 0.2–0.6 — moderate vegetation (grasslands, sparse forests)\n\nNDVI < 0.1 — bare soil, water, snow, or desert\n\nWe use MODIS Terra 16-day NDVI composites (MOD13A2, 1 km resolution)\nto build a multi-year median for each 16-day period, producing ~23 frames\nthat reveal the seasonal “green wave”. The wave tracks the subsolar latitude\n— as warmth and moisture arrive, vegetation pulses to life. We overlay the\nsubsolar declination line (yellow dashed) to make this connection visible.\n\nndvi_col = ee.ImageCollection(\"MODIS/061/MOD13A2\").select(\"NDVI\")\n\nndvi_col = ndvi_col.map(\n    lambda img: img.set(\n        \"doy\", ee.Date(img.get(\"system:time_start\")).getRelative(\"day\", \"year\")\n    )\n)\n\n# Use one year as the DOY template (23 composites, every 16 days)\ndistinct_doy = ndvi_col.filterDate(\"2020-01-01\", \"2021-01-01\")\n\n# Join all years by matching DOY, then take the median\njoin_filter = ee.Filter.equals(leftField=\"doy\", rightField=\"doy\")\njoin = ee.Join.saveAll(\"doy_matches\")\njoined = ee.ImageCollection(join.apply(distinct_doy, ndvi_col, join_filter))\n\nndvi_composites = joined.map(\n    lambda img: (\n        ee.ImageCollection.fromImages(img.get(\"doy_matches\"))\n        .reduce(ee.Reducer.median())\n        .rename(\"NDVI\")\n        .copyProperties(img, [\"doy\", \"system:time_start\"])\n    )\n)\n\nprint(f\"NDVI composites: {ndvi_composites.size().getInfo()} frames\")\n\n\n\n\n\nndvi_vis = {\n    \"min\": 0,\n    \"max\": 9000,\n    \"palette\": [\n        \"FFFFFF\", \"CE7E45\", \"DF923D\", \"F1B555\", \"FCD163\", \"99B718\", \"74A901\",\n        \"66A000\", \"529400\", \"3E8601\", \"207401\", \"056201\", \"004C00\", \"023B01\",\n        \"012E01\", \"011D01\", \"011301\",\n    ],\n}\n\nndvi_rgb = ndvi_composites.map(lambda img: img.visualize(**ndvi_vis))\n\ngif_ndvi_params = {\n    \"dimensions\": 600,\n    \"framesPerSecond\": 4,\n}\n\ngif_ndvi_path = str(paths.images_path / \"10_ee_ndvi_by_doy.gif\")\n\ngeemap.download_ee_video(ndvi_rgb, gif_ndvi_params, gif_ndvi_path)\nprint(f\"NDVI GIF saved to {gif_ndvi_path}\")\n\n\n\n\n\ndoy_list = list(range(1, 366, 16))  # 1, 17, 33, ...\nndvi_labels = [\n    (date(2024, 1, 1) + timedelta(days=d - 1)).strftime(\"%b %d\")\n    for d in doy_list\n]\n\ngeemap.add_text_to_gif(\n    gif_ndvi_path,\n    gif_ndvi_path,\n    xy=(\"5%\", \"90%\"),\n    text_sequence=ndvi_labels,\n    font_size=20,\n    font_color=\"white\",\n    add_progress_bar=True,\n    progress_bar_color=\"green\",\n    progress_bar_height=5,\n)\nprint(f\"Annotated NDVI GIF saved to {gif_ndvi_path}\")\n\n\n\n","type":"content","url":"/notebooks/earth-seasons#vegetation-the-seasonal-green-wave","position":13},{"hierarchy":{"lvl1":"Earth’s Seasons — From Sunlight to Vegetation","lvl3":"Subsolar latitude overlay","lvl2":"Vegetation — the seasonal green wave"},"type":"lvl3","url":"/notebooks/earth-seasons#subsolar-latitude-overlay","position":14},{"hierarchy":{"lvl1":"Earth’s Seasons — From Sunlight to Vegetation","lvl3":"Subsolar latitude overlay","lvl2":"Vegetation — the seasonal green wave"},"content":"To highlight the connection between the Sun’s position and vegetation, we\ndraw the subsolar declination latitude as a yellow dashed line on each frame.\n\nglobal_lat_min, global_lat_max = -90, 90\n\n\ndef solar_declination(doy: int) -> float:\n    \"\"\"Solar declination in degrees for a given day-of-year.\"\"\"\n    return 23.44 * math.sin(math.radians(360 / 365 * (doy - 81)))\n\n\ndef add_subsolar_line(gif_in_path, lat_min, lat_max):\n    \"\"\"Add a dashed yellow subsolar-latitude line to each frame of a GIF.\"\"\"\n    gif = Image.open(gif_in_path)\n    frames = []\n    durations = []\n    frame_idx = 0\n\n    try:\n        while True:\n            frame = gif.copy().convert(\"RGBA\")\n            draw = ImageDraw.Draw(frame)\n            w, h = frame.size\n\n            doy = doy_list[frame_idx % len(doy_list)]\n            decl = solar_declination(doy)\n            y = int((lat_max - decl) / (lat_max - lat_min) * h)\n\n            dash_len, gap_len = 12, 6\n            x = 0\n            while x < w:\n                draw.line([(x, y), (min(x + dash_len, w), y)], fill=\"yellow\", width=2)\n                x += dash_len + gap_len\n\n            frames.append(frame)\n            durations.append(gif.info.get(\"duration\", 250))\n            frame_idx += 1\n            gif.seek(gif.tell() + 1)\n    except EOFError:\n        pass\n\n    frames[0].save(\n        gif_in_path,\n        save_all=True,\n        append_images=frames[1:],\n        duration=durations,\n        loop=0,\n    )\n\n\nadd_subsolar_line(gif_ndvi_path, global_lat_min, global_lat_max)\nprint(f\"Subsolar line added to {gif_ndvi_path}\")\n\n\n\n\n\nFigure 8:Global NDVI seasonal cycle (multi-year median of MODIS Terra 16-day\ncomposites). The yellow dashed line marks the subsolar latitude. Vegetation\ngreens up in each hemisphere’s spring/summer, closely tracking the Sun’s\nposition. The boreal forest “green wave” sweeping northward in May–June is\none of the most visible seasonal changes on Earth.\n\n","type":"content","url":"/notebooks/earth-seasons#subsolar-latitude-overlay","position":15},{"hierarchy":{"lvl1":"Earth’s Seasons — From Sunlight to Vegetation","lvl2":"Vegetation — Africa close-up"},"type":"lvl2","url":"/notebooks/earth-seasons#vegetation-africa-close-up","position":16},{"hierarchy":{"lvl1":"Earth’s Seasons — From Sunlight to Vegetation","lvl2":"Vegetation — Africa close-up"},"content":"Africa straddles both tropics, making it an ideal region to observe the\nseasonal vegetation pulse. The most dramatic change occurs in the Sahel\n— the semi-arid transition zone between the Sahara and the tropical savannas.\nDuring the West African monsoon (approximately June–September), moisture\nfrom the Gulf of Guinea pushes northward, triggering a rapid greening of the\nSahel. This vegetation pulse closely follows the northward migration of the\nsubsolar latitude and retreats as the Sun moves south again.\n\nafrica = ee.Geometry.Rectangle([-20, -35, 55, 38])\n\nndvi_rgb_africa = ndvi_composites.map(\n    lambda img: img.visualize(**ndvi_vis).clip(africa)\n)\n\ngif_ndvi_africa_params = {\n    \"dimensions\": 800,\n    \"framesPerSecond\": 4,\n    \"region\": africa,\n}\n\ngif_ndvi_africa_path = str(paths.images_path / \"10_ee_ndvi_africa_by_doy.gif\")\n\ngeemap.download_ee_video(ndvi_rgb_africa, gif_ndvi_africa_params, gif_ndvi_africa_path)\nprint(f\"NDVI Africa GIF saved to {gif_ndvi_africa_path}\")\n\n\n\n\n\ngeemap.add_text_to_gif(\n    gif_ndvi_africa_path,\n    gif_ndvi_africa_path,\n    xy=(\"5%\", \"90%\"),\n    text_sequence=ndvi_labels,\n    font_size=20,\n    font_color=\"white\",\n    add_progress_bar=True,\n    progress_bar_color=\"green\",\n    progress_bar_height=5,\n)\nprint(f\"Annotated NDVI Africa GIF saved to {gif_ndvi_africa_path}\")\n\n\n\n\n\nadd_subsolar_line(gif_ndvi_africa_path, lat_min=-35, lat_max=38)\nprint(f\"Subsolar line added to {gif_ndvi_africa_path}\")\n\n\n\n\n\nFigure 9:NDVI seasonal cycle over Africa. The Sahel’s rapid greening during the\nmonsoon season (June–September) is clearly visible as a band of green\npushing northward, closely following the subsolar latitude (yellow dashed\nline). Southern Africa shows the opposite pattern, greening during the\naustral summer (November–March).","type":"content","url":"/notebooks/earth-seasons#vegetation-africa-close-up","position":17},{"hierarchy":{"lvl1":"Map Projections — ERA5 2 m Temperature"},"type":"lvl1","url":"/notebooks/projections","position":0},{"hierarchy":{"lvl1":"Map Projections — ERA5 2 m Temperature"},"content":"Loads the ERA5 2 m temperature snapshot for 2025-06-03 12:00 UTC from the\nlocally cached surface file (downloaded by 11_download_era5_single_timestamp.py)\nand visualises it in a variety of map projections.\n\nOverview panel — four common global projections side by side:\nPlate Carrée, Equal Earth, Robinson, Mercator.\n\nIndividual plots — four projections that emphasise different subsets of\nthe globe or introduce a 3-D perspective:\n\nOrthographic (centred on Europe)\n\nRobinson — global (same as the overview but full-size)\n\nPlate Carrée — North Atlantic / European domain\n\nOrthographic centred on the North Atlantic (NAO-style)\n\nimport numpy as np\nimport xarray as xr\nimport matplotlib.pyplot as plt\nimport cartopy.crs as ccrs\nimport cartopy.feature as cfeature\n\nfrom woe.paths import ProjPaths\n\npaths = ProjPaths()\n\n\n\n","type":"content","url":"/notebooks/projections","position":1},{"hierarchy":{"lvl1":"Map Projections — ERA5 2 m Temperature","lvl2":"Load data"},"type":"lvl2","url":"/notebooks/projections#load-data","position":2},{"hierarchy":{"lvl1":"Map Projections — ERA5 2 m Temperature","lvl2":"Load data"},"content":"\n\nds = xr.open_dataset(paths.era5_snapshot_20250603_1200_surface_file)\nt2m = ds[\"2m_temperature\"].squeeze() - 273.15  # K → °C\n\nprint(f\"Dimensions:        {dict(t2m.sizes)}\")\nprint(f\"Temperature range: {float(t2m.min()):.1f} °C to {float(t2m.max()):.1f} °C\")\n\n\n\n","type":"content","url":"/notebooks/projections#load-data","position":3},{"hierarchy":{"lvl1":"Map Projections — ERA5 2 m Temperature","lvl2":"Overview — four global projections"},"type":"lvl2","url":"/notebooks/projections#overview-four-global-projections","position":4},{"hierarchy":{"lvl1":"Map Projections — ERA5 2 m Temperature","lvl2":"Overview — four global projections"},"content":"Projection\n\nPreserves\n\nBest use case\n\nPlate Carrée\n\nGrid indices\n\nQuick plots / data checks\n\nEqual Earth\n\nArea\n\nGlobal distribution comparisons\n\nRobinson\n\nCompromise\n\nBalanced, appealing global overview\n\nMercator\n\nDirection/Angles\n\nNavigation (distorts polar regions)\n\nprojections = [\n    (\"Plate Carrée\", ccrs.PlateCarree()),\n    (\"Equal Earth\",  ccrs.EqualEarth()),\n    (\"Robinson\",     ccrs.Robinson()),\n    (\"Mercator\",     ccrs.Mercator()),\n]\n\nfig = plt.figure(figsize=(18, 13))\nfig.subplots_adjust(top=0.93, bottom=0.09, left=0.02, right=0.98,\n                    hspace=0.08, wspace=0.04)\n\nfor i, (name, proj) in enumerate(projections):\n    ax = fig.add_subplot(2, 2, i + 1, projection=proj)\n\n    im = ax.pcolormesh(\n        t2m.longitude,\n        t2m.latitude,\n        t2m.values,\n        transform=ccrs.PlateCarree(),\n        cmap=\"RdYlBu_r\",\n        vmin=-40,\n        vmax=45,\n        shading=\"auto\",\n    )\n    ax.add_feature(cfeature.COASTLINE, linewidth=0.5)\n    ax.add_feature(cfeature.BORDERS, linewidth=0.3, linestyle=\"--\")\n    ax.set_global()\n    ax.set_title(name, fontsize=13)\n\nfig.suptitle(\"ERA5 2 m Temperature — 2025-06-03 12:00 UTC\", fontsize=15)\n\n# Explicit colorbar axes pinned to the reserved bottom strip\ncax = fig.add_axes([0.25, 0.03, 0.50, 0.022])\ncbar = fig.colorbar(im, cax=cax, orientation=\"horizontal\")\ncbar.set_label(\"Temperature (°C)\")\n\nfig.savefig(\n    paths.images_path / \"12_t2m_projections_overview.png\",\n    dpi=150, bbox_inches=\"tight\",\n)\nplt.show()\n\n\n\n\n\nFigure 1:ERA5 2 m temperature on 2025-06-03 at 12:00 UTC in four common global map\nprojections.  Plate Carrée preserves grid indices; Equal Earth preserves\narea; Robinson is a balanced compromise; Mercator preserves direction but\nstrongly distorts polar regions.\n\n","type":"content","url":"/notebooks/projections#overview-four-global-projections","position":5},{"hierarchy":{"lvl1":"Map Projections — ERA5 2 m Temperature","lvl2":"Orthographic — Europe-centred perspective"},"type":"lvl2","url":"/notebooks/projections#orthographic-europe-centred-perspective","position":6},{"hierarchy":{"lvl1":"Map Projections — ERA5 2 m Temperature","lvl2":"Orthographic — Europe-centred perspective"},"content":"\n\nfig, ax = plt.subplots(\n    figsize=(10, 10),\n    subplot_kw={\"projection\": ccrs.Orthographic(central_longitude=10, central_latitude=50)},\n)\n\nim = ax.pcolormesh(\n    t2m.longitude,\n    t2m.latitude,\n    t2m.values,\n    transform=ccrs.PlateCarree(),\n    cmap=\"RdYlBu_r\",\n    vmin=-40,\n    vmax=45,\n    shading=\"auto\",\n)\nax.add_feature(cfeature.COASTLINE, linewidth=0.6)\nax.add_feature(cfeature.BORDERS, linewidth=0.3, linestyle=\"--\")\nax.gridlines(linewidth=0.3, color=\"gray\", alpha=0.5)\nax.set_global()\nax.set_title(\"ERA5 2 m Temperature — Orthographic (Europe) — 2025-06-03 12:00 UTC\", fontsize=12)\n\ncbar = fig.colorbar(im, ax=ax, orientation=\"horizontal\", pad=0.04, fraction=0.04, shrink=0.8)\ncbar.set_label(\"Temperature (°C)\")\n\nfig.tight_layout()\nfig.savefig(\n    paths.images_path / \"12_t2m_orthographic.png\",\n    dpi=150, bbox_inches=\"tight\",\n)\nplt.show()\n\n\n\n\n\nFigure 2:ERA5 2 m temperature on 2025-06-03 at 12:00 UTC on an Orthographic projection\ncentred over Europe.  This perspective gives a sense of how the temperature\nfield looks from space, with the curvature of the Earth visible at the edges.\n\n","type":"content","url":"/notebooks/projections#orthographic-europe-centred-perspective","position":7},{"hierarchy":{"lvl1":"Map Projections — ERA5 2 m Temperature","lvl2":"Robinson — global full-size"},"type":"lvl2","url":"/notebooks/projections#robinson-global-full-size","position":8},{"hierarchy":{"lvl1":"Map Projections — ERA5 2 m Temperature","lvl2":"Robinson — global full-size"},"content":"The Robinson projection is a compromise that minimises distortion of both\nshape and area, making it the standard choice for presenting global climate\nfields.\n\nfig, ax = plt.subplots(figsize=(14, 7), subplot_kw={\"projection\": ccrs.Robinson()})\n\nim = ax.pcolormesh(\n    t2m.longitude,\n    t2m.latitude,\n    t2m.values,\n    transform=ccrs.PlateCarree(),\n    cmap=\"RdYlBu_r\",\n    vmin=-40,\n    vmax=45,\n)\nax.add_feature(cfeature.COASTLINE, linewidth=0.6)\nax.add_feature(cfeature.BORDERS, linewidth=0.3, linestyle=\":\")\nax.gridlines(linewidth=0.3, color=\"gray\", alpha=0.5)\nax.set_global()\n\ncbar = fig.colorbar(im, ax=ax, orientation=\"horizontal\", pad=0.04, fraction=0.04)\ncbar.set_label(\"2 m temperature (°C)\")\n\nax.set_title(\"ERA5 2 m Temperature — Robinson — 2025-06-03 12:00 UTC\", fontsize=13)\n\nfig.tight_layout()\nfig.savefig(\n    paths.images_path / \"12_t2m_robinson.png\",\n    dpi=150, bbox_inches=\"tight\",\n)\nplt.show()\n\n\n\n\n\nFigure 3:ERA5 2 m temperature on 2025-06-03 at 12:00 UTC on a Robinson projection.\nThe warm summer temperatures across mid-latitude land masses (>30 °C) contrast\nwith cold air over Antarctica and the high Arctic.\n\n","type":"content","url":"/notebooks/projections#robinson-global-full-size","position":9},{"hierarchy":{"lvl1":"Map Projections — ERA5 2 m Temperature","lvl2":"Plate Carrée — North Atlantic / European domain"},"type":"lvl2","url":"/notebooks/projections#plate-carr-e-north-atlantic-european-domain","position":10},{"hierarchy":{"lvl1":"Map Projections — ERA5 2 m Temperature","lvl2":"Plate Carrée — North Atlantic / European domain"},"content":"A rectangular view centred on the North Atlantic and Europe — the same\ndomain used throughout the NAO analysis (90°W–40°E, 20°N–80°N).\n\nfig, ax = plt.subplots(\n    figsize=(14, 7),\n    subplot_kw={\"projection\": ccrs.PlateCarree()},\n)\n\nax.set_extent([-90, 40, 20, 80], crs=ccrs.PlateCarree())\n\nim = ax.pcolormesh(\n    t2m.longitude,\n    t2m.latitude,\n    t2m.values,\n    transform=ccrs.PlateCarree(),\n    cmap=\"RdYlBu_r\",\n    vmin=-40,\n    vmax=45,\n)\nax.add_feature(cfeature.COASTLINE, linewidth=0.6)\nax.add_feature(cfeature.BORDERS, linewidth=0.3, linestyle=\":\")\ngl = ax.gridlines(draw_labels=True, linewidth=0.3, color=\"gray\", alpha=0.5)\ngl.top_labels = False\ngl.right_labels = False\n\ncbar = fig.colorbar(im, ax=ax, orientation=\"horizontal\", pad=0.05, fraction=0.04)\ncbar.set_label(\"2 m temperature (°C)\")\n\nax.set_title(\"ERA5 2 m Temperature — North Atlantic domain — 2025-06-03 12:00 UTC\", fontsize=13)\n\nfig.tight_layout()\nfig.savefig(\n    paths.images_path / \"12_t2m_domain.png\",\n    dpi=150, bbox_inches=\"tight\",\n)\nplt.show()\n\n\n\n\n\nFigure 4:ERA5 2 m temperature on 2025-06-03 at 12:00 UTC on a Plate Carrée projection\nshowing the North Atlantic / European domain (90°W–40°E, 20°N–80°N).  The\nrectangular grid makes it easy to read off latitudes and longitudes directly.\n\n","type":"content","url":"/notebooks/projections#plate-carr-e-north-atlantic-european-domain","position":11},{"hierarchy":{"lvl1":"Map Projections — ERA5 2 m Temperature","lvl2":"Orthographic — North Atlantic (NAO-style)"},"type":"lvl2","url":"/notebooks/projections#orthographic-north-atlantic-nao-style","position":12},{"hierarchy":{"lvl1":"Map Projections — ERA5 2 m Temperature","lvl2":"Orthographic — North Atlantic (NAO-style)"},"content":"An Orthographic projection centred over the North Atlantic (10°W, 55°N) —\nthe same viewpoint used for NAO correlation maps.  This perspective places\nIceland and the Azores, the two NAO reference stations, near the centre of\nthe frame.\n\nfig, ax = plt.subplots(\n    figsize=(10, 8),\n    subplot_kw={\"projection\": ccrs.Orthographic(central_longitude=-10, central_latitude=55)},\n)\n\nax.set_extent([-90, 40, 20, 80], crs=ccrs.PlateCarree())\n\nim = ax.pcolormesh(\n    t2m.longitude,\n    t2m.latitude,\n    t2m.values,\n    transform=ccrs.PlateCarree(),\n    cmap=\"RdYlBu_r\",\n    vmin=-40,\n    vmax=45,\n)\nax.add_feature(cfeature.COASTLINE, linewidth=0.7)\nax.add_feature(cfeature.BORDERS, linewidth=0.4, linestyle=\":\")\nax.gridlines(linewidth=0.3, color=\"gray\", alpha=0.5)\n\ncbar = fig.colorbar(\n    im, ax=ax, orientation=\"horizontal\", pad=0.04, fraction=0.04, shrink=0.85\n)\ncbar.set_label(\"2 m temperature (°C)\")\n\nax.set_title(\n    \"ERA5 2 m Temperature — Orthographic (North Atlantic) — 2025-06-03 12:00 UTC\",\n    fontsize=12,\n)\n\nfig.tight_layout()\nfig.savefig(\n    paths.images_path / \"12_t2m_orthographic_nao.png\",\n    dpi=150, bbox_inches=\"tight\",\n)\nplt.show()\n\n\n\n\n\nFigure 5:ERA5 2 m temperature on 2025-06-03 at 12:00 UTC on an Orthographic projection\ncentred over the North Atlantic (10°W, 55°N).  This is the same viewpoint\nused for NAO correlation maps; the spherical perspective highlights the\ncurvature of the temperature gradient across the Atlantic storm track.","type":"content","url":"/notebooks/projections#orthographic-north-atlantic-nao-style","position":13},{"hierarchy":{"lvl1":"Pressure Levels and the Jet Stream"},"type":"lvl1","url":"/notebooks/pressure-and-weather","position":0},{"hierarchy":{"lvl1":"Pressure Levels and the Jet Stream"},"content":"The atmosphere is not just a flat layer of air — it has rich three-dimensional\nstructure.  Weather systems, temperature gradients, and especially the\njet stream only make sense once you understand how the atmosphere is\nstacked vertically.\n\nThis notebook explores that structure using ERA5 reanalysis data for a\nsingle snapshot (2025-06-03 12:00 UTC), combining surface observations with\npressure-level data to build an intuition for the jet stream as a\nthree-dimensional tube of fast-moving air circling the globe at\nroughly 10 km altitude.\n\nWe start at the surface, then work our way up through the atmosphere,\nbefore looking at vertical cross-sections that reveal the full 3D shape.\n\nimport io\n\nimport numpy as np\nimport xarray as xr\nimport matplotlib.pyplot as plt\nimport matplotlib.ticker as mticker\nimport matplotlib.patches as mpatches\nimport cartopy.crs as ccrs\nimport cartopy.feature as cfeature\nfrom cartopy.util import add_cyclic_point\nfrom matplotlib.colors import LinearSegmentedColormap\nfrom PIL import Image\n\nfrom woe.paths import ProjPaths\n\npaths = ProjPaths()\n\n\n\nDATE = \"2025-06-03\"\nTIME = \"2025-06-03T12:00:00\"\nG = 9.80665  # standard gravity m/s²\n\nds_sfc = xr.open_dataset(paths.era5_snapshot_20250603_1200_surface_file)\nds_pl  = xr.open_dataset(paths.era5_snapshot_20250603_1200_pressure_file)\n\nprint(f\"Surface dimensions:        {dict(ds_sfc.dims)}\")\nprint(f\"Surface variables:         {list(ds_sfc.data_vars)}\")\nprint(f\"Pressure-level dimensions: {dict(ds_pl.dims)}\")\nprint(f\"Pressure-level variables:  {list(ds_pl.data_vars)}\")\nprint(f\"Pressure levels (hPa):     {sorted(ds_pl.level.values.tolist(), reverse=True)}\")\n\n\n\n# --- Surface fields ---\nt2m      = ds_sfc[\"2m_temperature\"].squeeze()\nt2m_c    = t2m - 273.15\nu10      = ds_sfc[\"10m_u_component_of_wind\"].squeeze()\nv10      = ds_sfc[\"10m_v_component_of_wind\"].squeeze()\nwspd10   = np.sqrt(u10**2 + v10**2)\ntcc      = ds_sfc[\"total_cloud_cover\"].squeeze()\n\nlats_sfc = ds_sfc.latitude.values\nlons_sfc = ds_sfc.longitude.values\n\n# --- Pressure-level fields ---\nlats_pl = ds_pl.latitude.values\nlons_pl = ds_pl.longitude.values\n\n# Levels sorted from high pressure (low altitude) → low pressure (high altitude)\nlevels_sorted = sorted(ds_pl.level.values.tolist(), reverse=True)\n\nu250   = ds_pl[\"u_component_of_wind\"].sel(level=250).squeeze()\nv250   = ds_pl[\"v_component_of_wind\"].sel(level=250).squeeze()\nwspd250 = np.sqrt(u250**2 + v250**2)\n\ngph500  = ds_pl[\"geopotential\"].sel(level=500).squeeze() / G  # metres\n\nprint(f\"2m temperature:    {float(t2m_c.min()):.1f}°C to {float(t2m_c.max()):.1f}°C\")\nprint(f\"10m wind speed:    {float(wspd10.min()):.1f}–{float(wspd10.max()):.1f} m/s\")\nprint(f\"250 hPa max wind:  {float(wspd250.max()):.1f} m/s\")\nprint(f\"500 hPa GPH range: {float(gph500.min()):.0f}–{float(gph500.max()):.0f} m\")\n\n\n\n","type":"content","url":"/notebooks/pressure-and-weather","position":1},{"hierarchy":{"lvl1":"Pressure Levels and the Jet Stream","lvl2":"Surface weather"},"type":"lvl2","url":"/notebooks/pressure-and-weather#surface-weather","position":2},{"hierarchy":{"lvl1":"Pressure Levels and the Jet Stream","lvl2":"Surface weather"},"content":"Before climbing into the atmosphere, we look at what is happening at the\nEarth’s surface on this snapshot.\n\n","type":"content","url":"/notebooks/pressure-and-weather#surface-weather","position":3},{"hierarchy":{"lvl1":"Pressure Levels and the Jet Stream","lvl3":"2m Temperature","lvl2":"Surface weather"},"type":"lvl3","url":"/notebooks/pressure-and-weather#id-2m-temperature","position":4},{"hierarchy":{"lvl1":"Pressure Levels and the Jet Stream","lvl3":"2m Temperature","lvl2":"Surface weather"},"content":"\n\nfig, ax = plt.subplots(figsize=(16, 9), subplot_kw={\"projection\": ccrs.Robinson()})\n\nim = ax.pcolormesh(\n    lons_sfc, lats_sfc, t2m_c.values,\n    transform=ccrs.PlateCarree(),\n    cmap=\"RdYlBu_r\", vmin=-40, vmax=45, shading=\"auto\",\n)\nax.add_feature(cfeature.COASTLINE, linewidth=0.5)\nax.add_feature(cfeature.BORDERS, linewidth=0.3, linestyle=\"--\")\nax.set_global()\nax.set_title(f\"ERA5 2m Temperature — {DATE} 12:00 UTC\", fontsize=14)\n\ncbar = fig.colorbar(im, ax=ax, orientation=\"horizontal\", pad=0.05, shrink=0.6)\ncbar.set_label(\"Temperature (°C)\")\n\nfig.tight_layout()\nfig.savefig(paths.images_path / \"13_surface_temperature.png\", dpi=150, bbox_inches=\"tight\")\nplt.show()\n\n\n\n\n\nFigure 1:ERA5 2m temperature on 2025-06-03 at 12:00 UTC.  The classic summer contrast\nbetween the warm continents (especially the Middle East and Central Asia) and the\ncooler oceans and polar regions is clearly visible.\n\n","type":"content","url":"/notebooks/pressure-and-weather#id-2m-temperature","position":5},{"hierarchy":{"lvl1":"Pressure Levels and the Jet Stream","lvl3":"10m Wind Speed","lvl2":"Surface weather"},"type":"lvl3","url":"/notebooks/pressure-and-weather#id-10m-wind-speed","position":6},{"hierarchy":{"lvl1":"Pressure Levels and the Jet Stream","lvl3":"10m Wind Speed","lvl2":"Surface weather"},"content":"\n\nwspd10_c, lons10_c = add_cyclic_point(wspd10.values, coord=lons_sfc)\nu10_c, _           = add_cyclic_point(u10.values,    coord=lons_sfc)\nv10_c, _           = add_cyclic_point(v10.values,    coord=lons_sfc)\n\nstride     = 20  # 0.25° × 20 = 5° subsampling for arrows\nlons10_sub = lons10_c[::stride]\nlats10_sub = lats_sfc[::stride]\nu10_sub    = u10_c[::stride, ::stride]\nv10_sub    = v10_c[::stride, ::stride]\nwspd10_sub = np.sqrt(u10_sub**2 + v10_sub**2)\nwspd10_sub = np.where(wspd10_sub == 0, 1, wspd10_sub)\nu10_norm   = u10_sub / wspd10_sub\nv10_norm   = v10_sub / wspd10_sub\n\nfig = plt.figure(figsize=(16, 8))\nax = fig.add_subplot(1, 1, 1, projection=ccrs.Robinson())\nax.set_global()\n\ncf = ax.contourf(\n    lons10_c, lats_sfc, wspd10_c,\n    levels=np.arange(0, 25, 2),\n    cmap=\"YlOrRd\", transform=ccrs.PlateCarree(), extend=\"max\",\n)\nax.quiver(\n    lons10_sub, lats10_sub, u10_norm, v10_norm,\n    transform=ccrs.PlateCarree(),\n    color=\"steelblue\", alpha=0.7, scale=80, width=0.002,\n    headwidth=3, headlength=3, headaxislength=3.75, regrid_shape=None,\n)\nax.add_feature(cfeature.COASTLINE, linewidth=0.6, color=\"black\")\nax.add_feature(cfeature.BORDERS,   linewidth=0.3, color=\"black\", alpha=0.7)\nax.add_feature(cfeature.OCEAN,     facecolor=\"aliceblue\", zorder=0)\nax.add_feature(cfeature.LAND,      facecolor=\"whitesmoke\", zorder=0)\n\ngl = ax.gridlines(crs=ccrs.PlateCarree(), draw_labels=False,\n                  linewidth=0.4, color=\"gray\", alpha=0.5, linestyle=\"--\")\ngl.xlocator = mticker.FixedLocator(range(-180, 181, 30))\ngl.ylocator = mticker.FixedLocator(range(-90, 91,  30))\n\ncbar = fig.colorbar(cf, ax=ax, orientation=\"horizontal\", pad=0.03, fraction=0.04, aspect=40)\ncbar.set_label(\"10 m wind speed (m/s)\", fontsize=11)\nax.set_title(\n    f\"Surface wind — 10 m speed and direction\\n{DATE} 12:00 UTC  |  ERA5 reanalysis\",\n    fontsize=13, pad=10,\n)\n\nfig.tight_layout()\nfig.savefig(paths.images_path / \"13_surface_wind.png\", dpi=150, bbox_inches=\"tight\")\nplt.show()\n\n\n\n\n\nFigure 2:ERA5 10 m wind speed (filled contours) and direction (blue arrows) on\n2025-06-03 at 12:00 UTC.  The strongest surface winds are found over the\nstorm-track regions of the Southern Ocean and North Atlantic.  Blue arrows\nshow normalised wind direction; colour shows magnitude.\n\n","type":"content","url":"/notebooks/pressure-and-weather#id-10m-wind-speed","position":7},{"hierarchy":{"lvl1":"Pressure Levels and the Jet Stream","lvl3":"Cloud cover over satellite imagery","lvl2":"Surface weather"},"type":"lvl3","url":"/notebooks/pressure-and-weather#cloud-cover-over-satellite-imagery","position":8},{"hierarchy":{"lvl1":"Pressure Levels and the Jet Stream","lvl3":"Cloud cover over satellite imagery","lvl2":"Surface weather"},"content":"\n\ncloud_cmap = LinearSegmentedColormap.from_list(\"clouds\", [\n    (1, 1, 1, 0),   # transparent where cloud-free\n    (1, 1, 1, 1),   # opaque white where fully overcast\n])\n\nfig, ax = plt.subplots(figsize=(16, 9), subplot_kw={\"projection\": ccrs.Robinson()})\nax.stock_img()\n\nax.pcolormesh(\n    lons_sfc, lats_sfc, tcc.values,\n    transform=ccrs.PlateCarree(),\n    cmap=cloud_cmap, vmin=0, vmax=1, shading=\"auto\",\n)\nax.add_feature(cfeature.COASTLINE, linewidth=0.4, color=\"0.3\")\nax.add_feature(cfeature.BORDERS,   linewidth=0.2, linestyle=\"--\", color=\"0.4\")\nax.set_global()\nax.set_title(f\"ERA5 Cloud Cover over Blue Marble — {DATE} 12:00 UTC\", fontsize=14)\n\nfig.tight_layout()\nfig.savefig(paths.images_path / \"13_cloud_satellite.png\", dpi=150, bbox_inches=\"tight\")\nplt.show()\n\n\n\n\n\nFigure 3:ERA5 total cloud cover overlaid on Blue Marble satellite imagery.  Cloud-free\nareas reveal the land/ocean surface; white patches mark frontal systems and\nconvective clouds over the tropics.\n\n","type":"content","url":"/notebooks/pressure-and-weather#cloud-cover-over-satellite-imagery","position":9},{"hierarchy":{"lvl1":"Pressure Levels and the Jet Stream","lvl2":"What are pressure levels?"},"type":"lvl2","url":"/notebooks/pressure-and-weather#what-are-pressure-levels","position":10},{"hierarchy":{"lvl1":"Pressure Levels and the Jet Stream","lvl2":"What are pressure levels?"},"content":"The atmosphere is divided into pressure levels — horizontal surfaces where\nair pressure has the same value everywhere.  Standard levels include\n1000 hPa (near sea level), 850 hPa (~1.5 km), 500 hPa (~5.5 km), and\n250 hPa (~10 km).\n\nA crucial insight is that these surfaces are not flat.  Where the air\ncolumn is warm — and therefore expanded — a given pressure level sits\nhigher; where the air is cold and compressed, it sits lower.  These\nundulations (measured as geopotential height, in metres) encode the\nlarge-scale temperature and pressure patterns that drive weather systems.\n\nThe figure below shows the ERA5 data cross-sectioned along 55°N — a\nlatitude that cuts through Iceland, the United Kingdom, central Europe,\nand central Russia.  Each coloured band is the atmospheric layer between\ntwo successive pressure levels.  Thicker bands indicate warmer (more\nexpanded) air; thinner bands indicate colder air.\n\nLAT_TRANSECT = 55.0\n\n# Geopotential height in km at 55°N, all levels, all longitudes\ngph_transect = ds_pl[\"geopotential\"].sel(latitude=LAT_TRANSECT, method=\"nearest\").squeeze()\ngph_km       = gph_transect / G / 1000  # km\n\n# ERA5 uses 0–360° longitudes; convert to −180–180° and sort west→east\nlons_180 = np.where(lons_pl > 180, lons_pl - 360, lons_pl)\nsort_idx  = np.argsort(lons_180)\nlons_sort = lons_180[sort_idx]\ngph_sort  = gph_km.isel(longitude=sort_idx)\n\n# Colour palette: cool (low levels, high pressure) → warm (high levels, low pressure)\nband_cmap   = plt.cm.coolwarm\nn_bands     = len(levels_sorted) - 1\nband_colors = [band_cmap(i / max(n_bands - 1, 1)) for i in range(n_bands)]\n\nfig = plt.figure(figsize=(22, 7))\ngs  = fig.add_gridspec(1, 5, wspace=0.45)\n\n# --- Left: world map showing the transect latitude ---\nax_map = fig.add_subplot(gs[0, :2], projection=ccrs.Robinson())\nax_map.set_global()\nax_map.add_feature(cfeature.OCEAN,     facecolor=\"aliceblue\")\nax_map.add_feature(cfeature.LAND,      facecolor=\"whitesmoke\")\nax_map.add_feature(cfeature.COASTLINE, linewidth=0.5)\nax_map.add_feature(cfeature.BORDERS,   linewidth=0.3, alpha=0.7)\nax_map.plot(\n    [-180, 180], [LAT_TRANSECT, LAT_TRANSECT],\n    color=\"crimson\", linewidth=2.5, transform=ccrs.PlateCarree(), zorder=5,\n)\nax_map.gridlines(crs=ccrs.PlateCarree(), draw_labels=False,\n                 linewidth=0.3, color=\"gray\", alpha=0.4, linestyle=\"--\")\nax_map.set_title(\n    f\"Cross-section location\\n(red line = {LAT_TRANSECT:.0f}°N)\",\n    fontsize=12, color=\"crimson\",\n)\n\n# --- Right: pressure level bands ---\nax_b = fig.add_subplot(gs[0, 2:])\n\nfor i in range(n_bands):\n    lower_lev = levels_sorted[i]       # higher pressure = lower altitude\n    upper_lev = levels_sorted[i + 1]   # lower pressure  = higher altitude\n    lower_h   = gph_sort.sel(level=lower_lev).values\n    upper_h   = gph_sort.sel(level=upper_lev).values\n    ax_b.fill_between(lons_sort, lower_h, upper_h,\n                      color=band_colors[i], alpha=0.65)\n\n# Pressure-surface lines and labels\nfor lev in levels_sorted:\n    h = gph_sort.sel(level=lev).values\n    ax_b.plot(lons_sort, h, color=\"black\", linewidth=0.8, alpha=0.7)\n    ax_b.text(lons_sort[-1] + 2, h[-1], f\" {lev} hPa\",\n              va=\"center\", fontsize=8, fontweight=\"bold\")\n\n# Shade the jet-stream zone (250–200 hPa) with a thin annotation\njet_low  = gph_sort.sel(level=250).values.mean()\njet_high = gph_sort.sel(level=200).values.mean()\nax_b.axhspan(jet_low, jet_high, color=\"gold\", alpha=0.25, zorder=0)\nax_b.text(lons_sort[0] + 2, (jet_low + jet_high) / 2,\n          \"← jet stream zone\", va=\"center\", fontsize=9,\n          color=\"goldenrod\", fontweight=\"bold\")\n\nax_b.set_xlabel(\"Longitude (°E)\", fontsize=12)\nax_b.set_ylabel(\"Geopotential height (km)\", fontsize=12)\nax_b.set_xlim(lons_sort.min(), lons_sort.max() + 14)\nax_b.grid(True, alpha=0.2)\nax_b.set_title(\n    f\"Atmospheric layers along {LAT_TRANSECT:.0f}°N — {DATE} 12:00 UTC\",\n    fontsize=13,\n)\n\nfig.tight_layout()\nfig.savefig(paths.images_path / \"13_pressure_bands.png\", dpi=150, bbox_inches=\"tight\")\nplt.show()\n\n\n\n\n\nFigure 4:Left: world map showing the cross-section location (red line = 55°N).\nRight: atmospheric layers along 55°N.  Each coloured band represents the\nlayer between two pressure levels; black lines are the actual geopotential\nheight of each surface.  Thicker bands indicate warmer (expanded) air.  The\ngold shading marks the jet-stream zone (~200–250 hPa, ~10–12 km altitude).\nNote how the pressure surfaces undulate by hundreds of metres — these waves\nare the Rossby waves that steer surface weather systems.\n\n","type":"content","url":"/notebooks/pressure-and-weather#what-are-pressure-levels","position":11},{"hierarchy":{"lvl1":"Pressure Levels and the Jet Stream","lvl2":"The jet stream in 2D"},"type":"lvl2","url":"/notebooks/pressure-and-weather#the-jet-stream-in-2d","position":12},{"hierarchy":{"lvl1":"Pressure Levels and the Jet Stream","lvl2":"The jet stream in 2D"},"content":"The jet stream is a narrow corridor of fast-moving air located near the\ntropopause, typically at 250 hPa (~10 km altitude).  Two jets exist in each\nhemisphere:\n\nPolar front jet (~50–65°): marks the boundary between cold polar air\nand warmer mid-latitude air.  Its meanders steer surface weather systems.\n\nSubtropical jet (~25–35°): driven by the Hadley cell; typically\nstronger in winter, weaker in summer.\n\nOn a summer snapshot like ours (June), the polar jet is weaker and displaced\npoleward.  We visualise it in two ways:\n\nGlobal Robinson map — 250 hPa wind speed in colour, with 500 hPa\ngeopotential height as contour lines to show the pressure wave pattern.\n\nPolar (top-down) view — shows the jet stream as a ring around the\nNorth Pole.\n\n","type":"content","url":"/notebooks/pressure-and-weather#the-jet-stream-in-2d","position":13},{"hierarchy":{"lvl1":"Pressure Levels and the Jet Stream","lvl3":"Global view: 250 hPa wind + 500 hPa geopotential","lvl2":"The jet stream in 2D"},"type":"lvl3","url":"/notebooks/pressure-and-weather#global-view-250-hpa-wind-500-hpa-geopotential","position":14},{"hierarchy":{"lvl1":"Pressure Levels and the Jet Stream","lvl3":"Global view: 250 hPa wind + 500 hPa geopotential","lvl2":"The jet stream in 2D"},"content":"\n\nwspd250_c, lons250_c = add_cyclic_point(wspd250.values, coord=lons_pl)\ngph500_c,  _         = add_cyclic_point(gph500.values,  coord=lons_pl)\n\n# Geopotential-height contour levels in 80 m steps\nz500_levels = np.arange(\n    np.floor(float(gph500.min()) / 100) * 100,\n    np.ceil(float(gph500.max())  / 100) * 100 + 1,\n    80,\n)\n\nfig = plt.figure(figsize=(16, 8))\nax  = fig.add_subplot(1, 1, 1, projection=ccrs.Robinson())\nax.set_global()\n\ncf = ax.contourf(\n    lons250_c, lats_pl, wspd250_c,\n    levels=np.arange(0, 85, 5),\n    cmap=\"hot_r\", transform=ccrs.PlateCarree(), extend=\"max\",\n)\ncs = ax.contour(\n    lons250_c, lats_pl, gph500_c,\n    levels=z500_levels,\n    colors=\"steelblue\", linewidths=0.8, alpha=0.7,\n    transform=ccrs.PlateCarree(),\n)\nax.clabel(cs, fmt=\"%d m\", fontsize=7, inline=True)\n\nax.add_feature(cfeature.COASTLINE, linewidth=0.5)\nax.add_feature(cfeature.BORDERS,   linewidth=0.3, linestyle=\"--\")\n\ngl = ax.gridlines(crs=ccrs.PlateCarree(), draw_labels=False,\n                  linewidth=0.4, color=\"gray\", alpha=0.5, linestyle=\"--\")\ngl.xlocator = mticker.FixedLocator(range(-180, 181, 30))\ngl.ylocator = mticker.FixedLocator(range(-90,  91,  30))\n\ncbar = fig.colorbar(cf, ax=ax, orientation=\"horizontal\", pad=0.04, shrink=0.6)\ncbar.set_label(\"250 hPa wind speed (m/s)\")\nax.set_title(\n    f\"250 hPa wind speed + 500 hPa geopotential height — {DATE} 12:00 UTC\",\n    fontsize=13,\n)\n\nfig.tight_layout()\nfig.savefig(paths.images_path / \"13_z500_wind250.png\", dpi=150, bbox_inches=\"tight\")\nplt.show()\n\n\n\n\n\nFigure 5:250 hPa wind speed (filled, hot colourmap) with 500 hPa geopotential height\ncontours (blue lines, labelled in metres).  The jet stream appears as the orange/red\nband encircling the mid-latitudes.  The 500 hPa contours reveal the trough/ridge\nwave pattern that the jet stream follows: the jet accelerates through troughs\n(low geopotential) and decelerates through ridges (high geopotential).\n\n","type":"content","url":"/notebooks/pressure-and-weather#global-view-250-hpa-wind-500-hpa-geopotential","position":15},{"hierarchy":{"lvl1":"Pressure Levels and the Jet Stream","lvl3":"500 hPa geopotential + 250 hPa jet stream footprint","lvl2":"The jet stream in 2D"},"type":"lvl3","url":"/notebooks/pressure-and-weather#id-500-hpa-geopotential-250-hpa-jet-stream-footprint","position":16},{"hierarchy":{"lvl1":"Pressure Levels and the Jet Stream","lvl3":"500 hPa geopotential + 250 hPa jet stream footprint","lvl2":"The jet stream in 2D"},"content":"The same Z500 wave pattern as above, but now the 250 hPa wind speed is\ncollapsed to a binary mask: grid points where the jet core exceeds 30 m/s\nare filled in purple, while slower regions are transparent.  This style —\nborrowed from operational meteorological charts — immediately shows the\njet-stream corridor without the distraction of a continuous colour scale.\n\nJET_THRESHOLD = 30  # m/s — standard meteorological jet-stream criterion\n\n# Reuse cyclic arrays already computed above\nz500_levels   = np.arange(\n    np.floor(float(gph500.min()) / 60) * 60,\n    np.ceil(float(gph500.max())  / 60) * 60 + 1,\n    80,\n)\njet_masked_c = np.where(wspd250_c >= JET_THRESHOLD, wspd250_c, np.nan)\n\nfig = plt.figure(figsize=(16, 8))\nax  = fig.add_subplot(1, 1, 1, projection=ccrs.Robinson())\nax.set_global()\n\nax.add_feature(cfeature.OCEAN, facecolor=\"#d0e8f5\", zorder=0)\nax.add_feature(cfeature.LAND,  facecolor=\"#f0ede8\", zorder=0)\n\ncs = ax.contour(\n    lons250_c, lats_pl, gph500_c,\n    levels=z500_levels, colors=\"black\", linewidths=0.6,\n    transform=ccrs.PlateCarree(), zorder=3,\n)\nax.clabel(cs, fmt=\"%d m\", fontsize=7, inline=True, inline_spacing=3)\n\nax.contourf(\n    lons250_c, lats_pl, jet_masked_c,\n    levels=[JET_THRESHOLD, 300], colors=[\"mediumpurple\"], alpha=0.75,\n    transform=ccrs.PlateCarree(), zorder=4,\n)\nax.contour(\n    lons250_c, lats_pl, wspd250_c,\n    levels=[JET_THRESHOLD], colors=[\"rebeccapurple\"], linewidths=1.0,\n    transform=ccrs.PlateCarree(), zorder=5,\n)\n\nax.add_feature(cfeature.COASTLINE, linewidth=0.6, color=\"black\", zorder=6)\nax.add_feature(cfeature.BORDERS,   linewidth=0.3, color=\"black\", alpha=0.7, zorder=6)\n\ngl = ax.gridlines(crs=ccrs.PlateCarree(), draw_labels=False,\n                  linewidth=0.4, color=\"gray\", alpha=0.5, linestyle=\"--\")\ngl.xlocator = mticker.FixedLocator(range(-180, 181, 30))\ngl.ylocator = mticker.FixedLocator(range(-90,  91,  30))\n\nax.legend(\n    handles=[mpatches.Patch(facecolor=\"mediumpurple\", edgecolor=\"rebeccapurple\",\n                            alpha=0.75, label=f\"Jet stream ≥ {JET_THRESHOLD} m/s  (250 hPa)\")],\n    loc=\"lower left\", fontsize=10, framealpha=0.85,\n)\nax.set_title(\n    f\"500 hPa geopotential height (contours) + jet stream footprint — {DATE} 12:00 UTC\",\n    fontsize=13,\n)\n\nfig.tight_layout()\nfig.savefig(paths.images_path / \"13_z500_jet_purple.png\", dpi=150, bbox_inches=\"tight\")\nplt.show()\n\n\n\n\n\nFigure 6:500 hPa geopotential height (black contours, labelled in metres) with the\n250 hPa jet stream footprint (purple, ≥ 30 m/s).  The jet hugs the steepest\ngeopotential gradient, flowing fastest where contours are most tightly packed.\nTroughs (contours bending equatorward) and ridges (bending poleward) mark\nthe Rossby-wave pattern that steers the jet.\n\n","type":"content","url":"/notebooks/pressure-and-weather#id-500-hpa-geopotential-250-hpa-jet-stream-footprint","position":17},{"hierarchy":{"lvl1":"Pressure Levels and the Jet Stream","lvl3":"2m temperature + 500 hPa geopotential contours","lvl2":"The jet stream in 2D"},"type":"lvl3","url":"/notebooks/pressure-and-weather#id-2m-temperature-500-hpa-geopotential-contours","position":18},{"hierarchy":{"lvl1":"Pressure Levels and the Jet Stream","lvl3":"2m temperature + 500 hPa geopotential contours","lvl2":"The jet stream in 2D"},"content":"The Z500 wave pattern also reflects the surface temperature distribution —\nwarm air expands the lower troposphere and pushes pressure surfaces higher,\nwhile cold air compresses them.  Overlaying Z500 contours on 2m temperature\nmakes this connection explicit: ridges (high Z500) sit over warm air masses,\ntroughs (low Z500) over cold ones.\n\nt2m_c_cyc, lons_t2m_c = add_cyclic_point(t2m_c.values, coord=lons_sfc)\n\nfig = plt.figure(figsize=(16, 8))\nax  = fig.add_subplot(1, 1, 1, projection=ccrs.Robinson())\nax.set_global()\n\nim = ax.pcolormesh(\n    lons_t2m_c, lats_sfc, t2m_c_cyc,\n    cmap=\"RdBu_r\", vmin=-40, vmax=45,\n    transform=ccrs.PlateCarree(), shading=\"auto\",\n)\ncs = ax.contour(\n    lons250_c, lats_pl, gph500_c,\n    levels=z500_levels, colors=\"black\", linewidths=0.6,\n    transform=ccrs.PlateCarree(), zorder=3,\n)\nax.clabel(cs, fmt=\"%d m\", fontsize=7, inline=True, inline_spacing=3)\n\nax.add_feature(cfeature.COASTLINE, linewidth=0.6, color=\"0.15\", zorder=4)\nax.add_feature(cfeature.BORDERS,   linewidth=0.3, linestyle=\"--\", color=\"0.35\", zorder=4)\n\ngl = ax.gridlines(crs=ccrs.PlateCarree(), draw_labels=False,\n                  linewidth=0.4, color=\"gray\", alpha=0.5, linestyle=\"--\")\ngl.xlocator = mticker.FixedLocator(range(-180, 181, 30))\ngl.ylocator = mticker.FixedLocator(range(-90,  91,  30))\n\ncbar = fig.colorbar(im, ax=ax, orientation=\"horizontal\", pad=0.05, shrink=0.6)\ncbar.set_label(\"2m temperature (°C)\")\nax.set_title(\n    f\"500 hPa geopotential height (contours) + 2m temperature — {DATE} 12:00 UTC\",\n    fontsize=13,\n)\n\nfig.tight_layout()\nfig.savefig(paths.images_path / \"13_t2m_z500.png\", dpi=150, bbox_inches=\"tight\")\nplt.show()\n\n\n\n\n\nFigure 7:2m temperature (filled, red–blue scale) with 500 hPa geopotential height\ncontours (black).  Ridges (contours arching poleward) align with warm air\nmasses; troughs (contours dipping equatorward) sit over cold air.  The\ntight coupling between the upper-level wave pattern and the surface\ntemperature field is a key driver of both weather and energy demand.\n\n","type":"content","url":"/notebooks/pressure-and-weather#id-2m-temperature-500-hpa-geopotential-contours","position":19},{"hierarchy":{"lvl1":"Pressure Levels and the Jet Stream","lvl3":"2m temperature with 250 hPa jet stream core overlay","lvl2":"The jet stream in 2D"},"type":"lvl3","url":"/notebooks/pressure-and-weather#id-2m-temperature-with-250-hpa-jet-stream-core-overlay","position":20},{"hierarchy":{"lvl1":"Pressure Levels and the Jet Stream","lvl3":"2m temperature with 250 hPa jet stream core overlay","lvl2":"The jet stream in 2D"},"content":"The jet stream is the boundary between cold polar air and warm subtropical\nair.  Overlaying the jet core (> 30 m/s, shown here as a white band that\nbrightens with wind speed) directly on the 2m temperature field makes this\nair-mass boundary visible: north of the jet lies colder, denser polar air;\nsouth of it lies warmer subtropical air.\n\njet_core_c  = np.where(wspd250_c > JET_THRESHOLD, wspd250_c, np.nan)\njet_core_cmap = LinearSegmentedColormap.from_list(\"jet_core\", [\n    (0.2, 0.2, 0.2, 0.6),  # dark grey, semi-transparent at threshold\n    (1.0, 1.0, 1.0, 1.0),  # bright white at 80 m/s\n])\n\nfig = plt.figure(figsize=(16, 9))\nax  = fig.add_subplot(1, 1, 1, projection=ccrs.Robinson())\nax.set_global()\n\nim_temp = ax.pcolormesh(\n    lons_t2m_c, lats_sfc, t2m_c_cyc,\n    cmap=\"RdYlBu_r\", vmin=-40, vmax=45,\n    transform=ccrs.PlateCarree(), shading=\"auto\",\n)\nax.pcolormesh(\n    lons250_c, lats_pl, jet_core_c,\n    cmap=jet_core_cmap, vmin=JET_THRESHOLD, vmax=80,\n    transform=ccrs.PlateCarree(), shading=\"auto\",\n)\n\nax.add_feature(cfeature.COASTLINE, linewidth=0.5)\nax.add_feature(cfeature.BORDERS,   linewidth=0.3, linestyle=\"--\")\n\ncbar = fig.colorbar(im_temp, ax=ax, orientation=\"horizontal\", pad=0.05, shrink=0.6)\ncbar.set_label(\"Temperature (°C)\")\nax.set_title(\n    f\"2m temperature with jet stream core (> {JET_THRESHOLD} m/s at 250 hPa) — {DATE} 12:00 UTC\",\n    fontsize=13,\n)\n\nfig.tight_layout()\nfig.savefig(paths.images_path / \"13_t2m_jet_core.png\", dpi=150, bbox_inches=\"tight\")\nplt.show()\n\n\n\n\n\nFigure 8:2m temperature (filled, RdYlBu_r) with the 250 hPa jet stream core overlaid\nas a white band (brightening with wind speed above 30 m/s).  The jet marks\nthe sharp boundary between cold polar air to the north and warm subtropical\nair to the south — a boundary that in winter can be associated with\ntemperature differences of 20–30 °C over just a few degrees of latitude.\n\n","type":"content","url":"/notebooks/pressure-and-weather#id-2m-temperature-with-250-hpa-jet-stream-core-overlay","position":21},{"hierarchy":{"lvl1":"Pressure Levels and the Jet Stream","lvl3":"Polar view: the jet stream as a ring around the North Pole","lvl2":"The jet stream in 2D"},"type":"lvl3","url":"/notebooks/pressure-and-weather#polar-view-the-jet-stream-as-a-ring-around-the-north-pole","position":22},{"hierarchy":{"lvl1":"Pressure Levels and the Jet Stream","lvl3":"Polar view: the jet stream as a ring around the North Pole","lvl2":"The jet stream in 2D"},"content":"\n\n# Subsample for streamlines (dense grids overwhelm cartopy's streamplot)\nstep  = 8\nlons_sub = u250.longitude.values[::step]\nlats_sub = lats_pl[::step]\nu_sub    = u250.values[::step, ::step]\nv_sub    = v250.values[::step, ::step]\n\nfig, ax = plt.subplots(\n    figsize=(10, 10),\n    subplot_kw={\"projection\": ccrs.NorthPolarStereo()},\n)\n\nim = ax.pcolormesh(\n    lons_pl, lats_pl, wspd250.values,\n    transform=ccrs.PlateCarree(),\n    cmap=\"hot_r\", vmin=0, vmax=80, shading=\"auto\",\n)\nax.streamplot(\n    lons_sub, lats_sub, u_sub, v_sub,\n    transform=ccrs.PlateCarree(),\n    color=\"white\", linewidth=0.5, density=1.5, arrowsize=0.8,\n)\nax.add_feature(cfeature.COASTLINE, linewidth=0.5)\nax.add_feature(cfeature.BORDERS,   linewidth=0.3, linestyle=\"--\")\nax.set_extent([-180, 180, 20, 90], crs=ccrs.PlateCarree())\n\ncbar = fig.colorbar(im, ax=ax, orientation=\"horizontal\", pad=0.05, shrink=0.7)\ncbar.set_label(\"250 hPa wind speed (m/s)\")\nax.set_title(\n    f\"Jet stream viewed from above — 250 hPa\\n{DATE} 12:00 UTC  |  ERA5\",\n    fontsize=13,\n)\n\nfig.tight_layout()\nfig.savefig(paths.images_path / \"13_jet_stream_polar.png\", dpi=150, bbox_inches=\"tight\")\nplt.show()\n\n\n\n\n\nFigure 9:The Northern Hemisphere jet stream viewed from directly above the North Pole\n(North Polar Stereographic projection).  Wind speed at 250 hPa is shown in\ncolour; white streamlines indicate wind direction.  The jet stream traces an\nirregular ring around the pole, with Rossby-wave meanders visible as north–south\nexcursions.  This “ring” perspective makes it clear why the jet stream is\nsometimes described as a three-dimensional tube encircling the planet.\n\n","type":"content","url":"/notebooks/pressure-and-weather#polar-view-the-jet-stream-as-a-ring-around-the-north-pole","position":23},{"hierarchy":{"lvl1":"Pressure Levels and the Jet Stream","lvl2":"Jet stream across altitude levels"},"type":"lvl2","url":"/notebooks/pressure-and-weather#jet-stream-across-altitude-levels","position":24},{"hierarchy":{"lvl1":"Pressure Levels and the Jet Stream","lvl2":"Jet stream across altitude levels"},"content":"The figures above show the jet stream at a single pressure level (250 hPa).\nBut the jet has vertical extent — it intensifies from the mid-troposphere\nupward through the tropopause, then weakens in the stratosphere above.\n\nThe animation below steps through all available pressure levels from\n850 hPa (~1.5 km, near-surface) to 100 hPa (~16 km, lower stratosphere).\nWatch how the fast-moving core (red/orange) emerges at mid-tropospheric\nlevels, peaks near 200–250 hPa, then fades in the stratosphere above.\n\nLevel (hPa)\n\nApprox. altitude\n\nLayer\n\n850\n\n~1.5 km\n\nlower troposphere\n\n500\n\n~5.5 km\n\nmid-troposphere\n\n400\n\n~7 km\n\nmid-troposphere\n\n350\n\n~8 km\n\nupper troposphere\n\n300\n\n~9 km\n\nupper troposphere\n\n250\n\n~10 km\n\njet-stream core\n\n225\n\n~11 km\n\njet-stream core\n\n200\n\n~12 km\n\njet / tropopause\n\n175\n\n~13 km\n\ntropopause\n\n150\n\n~14 km\n\nlower stratosphere\n\n125\n\n~15 km\n\nlower stratosphere\n\n100\n\n~16 km\n\nlower stratosphere\n\n_ALT_LABELS = {\n    850: \"~1.5 km (lower troposphere)\",\n    500: \"~5.5 km (mid-troposphere)\",\n    400: \"~7 km\",\n    350: \"~8 km\",\n    300: \"~9 km (upper troposphere)\",\n    250: \"~10 km ★ jet-stream core\",\n    225: \"~11 km ★ jet-stream core\",\n    200: \"~12 km (jet / tropopause)\",\n    175: \"~13 km (tropopause)\",\n    150: \"~14 km (lower stratosphere)\",\n    125: \"~15 km\",\n    100: \"~16 km (lower stratosphere)\",\n}\n\ngif_frames_pl = []\n\nfor level in levels_sorted:\n    u_lev   = ds_pl[\"u_component_of_wind\"].sel(level=level).squeeze()\n    v_lev   = ds_pl[\"v_component_of_wind\"].sel(level=level).squeeze()\n    wspd_lv = np.sqrt(u_lev.values**2 + v_lev.values**2)\n\n    wspd_c, lons_c = add_cyclic_point(wspd_lv,       coord=lons_pl)\n    u_c,    _      = add_cyclic_point(u_lev.values,   coord=lons_pl)\n    v_c,    _      = add_cyclic_point(v_lev.values,   coord=lons_pl)\n\n    stride   = 20\n    lons_sub = lons_c[::stride]\n    lats_sub = lats_pl[::stride]\n    u_sub    = u_c[::stride, ::stride]\n    v_sub    = v_c[::stride, ::stride]\n    wspd_sub = np.sqrt(u_sub**2 + v_sub**2)\n    wspd_sub = np.where(wspd_sub == 0, 1, wspd_sub)\n    u_norm   = u_sub / wspd_sub\n    v_norm   = v_sub / wspd_sub\n\n    fig = plt.figure(figsize=(16, 8))\n    ax  = fig.add_subplot(1, 1, 1, projection=ccrs.Robinson())\n    ax.set_global()\n\n    cf = ax.contourf(\n        lons_c, lats_pl, wspd_c,\n        levels=np.arange(0, 85, 5),\n        cmap=\"YlOrRd\", transform=ccrs.PlateCarree(), extend=\"max\",\n    )\n    ax.quiver(\n        lons_sub, lats_sub, u_norm, v_norm,\n        transform=ccrs.PlateCarree(),\n        color=\"steelblue\", alpha=0.7, scale=80, width=0.002,\n        headwidth=3, headlength=3, headaxislength=3.75, regrid_shape=None,\n    )\n    ax.add_feature(cfeature.COASTLINE, linewidth=0.6, color=\"black\")\n    ax.add_feature(cfeature.BORDERS,   linewidth=0.3, color=\"black\", alpha=0.7)\n    ax.add_feature(cfeature.OCEAN,     facecolor=\"aliceblue\",  zorder=0)\n    ax.add_feature(cfeature.LAND,      facecolor=\"whitesmoke\", zorder=0)\n\n    gl = ax.gridlines(crs=ccrs.PlateCarree(), draw_labels=False,\n                      linewidth=0.4, color=\"gray\", alpha=0.5, linestyle=\"--\")\n    gl.xlocator = mticker.FixedLocator(range(-180, 181, 30))\n    gl.ylocator = mticker.FixedLocator(range(-90,  91,  30))\n\n    cbar = fig.colorbar(cf, ax=ax, orientation=\"horizontal\",\n                        pad=0.03, fraction=0.04, aspect=40)\n    cbar.set_label(f\"Wind speed at {level} hPa (m/s)\", fontsize=11)\n    cbar.ax.tick_params(labelsize=9)\n\n    ax.set_title(\n        f\"Upper-level wind — {level} hPa  ({_ALT_LABELS.get(level, '')})\\n\"\n        f\"{DATE} 12:00 UTC  |  ERA5 reanalysis\",\n        fontsize=13, pad=10,\n    )\n\n    fig.tight_layout()\n\n    buf = io.BytesIO()\n    fig.savefig(buf, format=\"png\", dpi=100, bbox_inches=\"tight\")\n    plt.close(fig)\n    buf.seek(0)\n    gif_frames_pl.append(Image.open(buf).copy())\n    print(f\"  pressure level frame: {level} hPa\")\n\nout_gif_pl = paths.images_path / \"13_pressure_levels_animation.gif\"\ngif_frames_pl[0].save(\n    out_gif_pl,\n    save_all=True,\n    append_images=gif_frames_pl[1:],\n    duration=700,   # ms per frame — slow enough to read the title\n    loop=0,\n)\nprint(f\"saved → {out_gif_pl.name}  ({len(gif_frames_pl)} frames)\")\n\n\n\n\n\nFigure 10:Animation stepping from 850 hPa (near-surface) up to 100 hPa (lower stratosphere).\nThe jet stream emerges as the fast-moving core (orange/red) intensifies through the\nmid-troposphere, peaks at 200–250 hPa, then weakens in the stratosphere above.\nBlue arrows show wind direction.  This animation reveals the jet stream as a\nvertically coherent structure rather than just a surface phenomenon.\n\n","type":"content","url":"/notebooks/pressure-and-weather#jet-stream-across-altitude-levels","position":25},{"hierarchy":{"lvl1":"Pressure Levels and the Jet Stream","lvl2":"Vertical cross-sections"},"type":"lvl2","url":"/notebooks/pressure-and-weather#vertical-cross-sections","position":26},{"hierarchy":{"lvl1":"Pressure Levels and the Jet Stream","lvl2":"Vertical cross-sections"},"content":"A vertical cross-section cuts through the atmosphere at a fixed longitude\nand shows how wind speed and temperature vary simultaneously with latitude\n(x-axis) and altitude (y-axis).  This is the most direct way to see the jet\nstream’s three-dimensional shape.\n\nThe y-axis uses geopotential height (km) so altitude increases naturally\nupward.  Each cross-section is paired with a world map highlighting the\nmeridian it was cut along.\n\n","type":"content","url":"/notebooks/pressure-and-weather#vertical-cross-sections","position":27},{"hierarchy":{"lvl1":"Pressure Levels and the Jet Stream","lvl3":"Cross-section helper","lvl2":"Vertical cross-sections"},"type":"lvl3","url":"/notebooks/pressure-and-weather#cross-section-helper","position":28},{"hierarchy":{"lvl1":"Pressure Levels and the Jet Stream","lvl3":"Cross-section helper","lvl2":"Vertical cross-sections"},"content":"\n\ndef _fmt_cross_axes(ax):\n    ax.set_xlabel(\"Latitude (°)\", fontsize=10)\n    ax.set_ylabel(\"Geopotential height (km)\", fontsize=10)\n    ax.xaxis.set_major_formatter(mticker.FormatStrFormatter(\"%d°\"))\n    ax.xaxis.set_major_locator(mticker.MultipleLocator(15))\n    ax.grid(axis=\"x\", linewidth=0.4, color=\"gray\", alpha=0.5, linestyle=\"--\")\n    ax.grid(axis=\"y\", linewidth=0.4, color=\"gray\", alpha=0.3, linestyle=\":\")\n\n\ndef _cross_section_data(ds_pl, lon_cut):\n    \"\"\"Extract and sort cross-section arrays for a given longitude.\"\"\"\n    ds_cut    = ds_pl.sel(longitude=lon_cut, method=\"nearest\")\n    lon_act   = float(ds_cut.longitude)\n    lon_plot  = lon_act if lon_act <= 180 else lon_act - 360\n\n    u_cut  = ds_cut[\"u_component_of_wind\"].squeeze().values  # (level, lat)\n    v_cut  = ds_cut[\"v_component_of_wind\"].squeeze().values\n    z_cut  = ds_cut[\"geopotential\"].squeeze().values\n    t_cut  = ds_cut[\"temperature\"].squeeze().values\n    lats_c = ds_cut.latitude.values  # descending 90→−90\n\n    z_km       = z_cut / G / 1000\n    level_ord  = np.argsort(z_km.mean(axis=1))  # bottom → top\n\n    z_km_s  = z_km[level_ord][:, ::-1]                                # south→north\n    wspd_s  = np.sqrt(u_cut**2 + v_cut**2)[level_ord][:, ::-1]\n    t_s     = t_cut[level_ord][:, ::-1] - 273.15\n    lat_2d  = np.broadcast_to(lats_c[::-1], z_km_s.shape).copy()\n\n    return lon_act, lon_plot, lat_2d, z_km_s, wspd_s, t_s\n\n\n\n","type":"content","url":"/notebooks/pressure-and-weather#cross-section-helper","position":29},{"hierarchy":{"lvl1":"Pressure Levels and the Jet Stream","lvl3":"Static cross-section at 0 °E (prime meridian) with location map","lvl2":"Vertical cross-sections"},"type":"lvl3","url":"/notebooks/pressure-and-weather#static-cross-section-at-0-e-prime-meridian-with-location-map","position":30},{"hierarchy":{"lvl1":"Pressure Levels and the Jet Stream","lvl3":"Static cross-section at 0 °E (prime meridian) with location map","lvl2":"Vertical cross-sections"},"content":"\n\nLON_STATIC = 0\nlon_act, lon_plot, lat_2d, z_km_s, wspd_s, t_s = _cross_section_data(ds_pl, LON_STATIC)\n\nfig = plt.figure(figsize=(22, 6))\ngs  = fig.add_gridspec(1, 10, wspace=0.5)\n\n# --- Location map ---\nax_map = fig.add_subplot(gs[0, :2], projection=ccrs.PlateCarree())\nax_map.set_global()\nax_map.add_feature(cfeature.OCEAN,     facecolor=\"aliceblue\")\nax_map.add_feature(cfeature.LAND,      facecolor=\"whitesmoke\")\nax_map.add_feature(cfeature.COASTLINE, linewidth=0.6)\nax_map.add_feature(cfeature.BORDERS,   linewidth=0.3, alpha=0.7)\nax_map.plot([lon_plot, lon_plot], [-90, 90],\n            color=\"crimson\", linewidth=2.5, transform=ccrs.PlateCarree(), zorder=5)\ngl_m = ax_map.gridlines(crs=ccrs.PlateCarree(), draw_labels=True,\n                         linewidth=0.3, color=\"gray\", alpha=0.5, linestyle=\"--\")\ngl_m.top_labels   = False\ngl_m.right_labels = False\ngl_m.xlocator     = mticker.FixedLocator(range(-180, 181, 60))\ngl_m.ylocator     = mticker.FixedLocator(range(-90,  91,  30))\ngl_m.xlabel_style = {\"size\": 8}\ngl_m.ylabel_style = {\"size\": 8}\nax_map.set_title(\n    f\"Cross-section at\\n{lon_act:.0f}°E ({lon_plot:+.0f}°)\",\n    fontsize=10, color=\"crimson\",\n)\n\n# --- Wind speed ---\nax_w = fig.add_subplot(gs[0, 2:6])\ncf_w = ax_w.contourf(lat_2d, z_km_s, wspd_s,\n                     levels=np.arange(0, 85, 5), cmap=\"YlOrRd\", extend=\"max\")\ncs_w = ax_w.contour(lat_2d, z_km_s, wspd_s, levels=[30, 50, 70],\n                    colors=\"black\", linewidths=0.8, alpha=0.6)\nax_w.clabel(cs_w, fmt=\"%d m/s\", fontsize=8)\nfig.colorbar(cf_w, ax=ax_w, orientation=\"vertical\", pad=0.02,\n             fraction=0.03, aspect=30).set_label(\"Wind speed (m/s)\", fontsize=10)\n_fmt_cross_axes(ax_w)\nax_w.set_title(f\"Wind speed — {lon_act:.0f}°E ({lon_plot:+.0f}°)\", fontsize=11)\n\n# --- Temperature ---\nax_t = fig.add_subplot(gs[0, 6:10], sharey=ax_w)\ncf_t = ax_t.contourf(lat_2d, z_km_s, t_s,\n                     levels=np.arange(-80, 25, 5), cmap=\"RdBu_r\", extend=\"both\")\ncs_t = ax_t.contour(lat_2d, z_km_s, t_s, levels=np.arange(-80, 25, 10),\n                    colors=\"black\", linewidths=0.6, alpha=0.5)\nax_t.clabel(cs_t, fmt=\"%d°C\", fontsize=8)\nfig.colorbar(cf_t, ax=ax_t, orientation=\"vertical\", pad=0.02,\n             fraction=0.03, aspect=30).set_label(\"Temperature (°C)\", fontsize=10)\nax_t.set_xlabel(\"Latitude (°)\", fontsize=10)\nax_t.xaxis.set_major_formatter(mticker.FormatStrFormatter(\"%d°\"))\nax_t.xaxis.set_major_locator(mticker.MultipleLocator(15))\nax_t.grid(axis=\"x\", linewidth=0.4, color=\"gray\", alpha=0.5, linestyle=\"--\")\nax_t.grid(axis=\"y\", linewidth=0.4, color=\"gray\", alpha=0.3, linestyle=\":\")\nax_t.tick_params(labelleft=False)\nax_t.set_title(f\"Temperature — {lon_act:.0f}°E ({lon_plot:+.0f}°)\", fontsize=11)\n\nfig.suptitle(\n    f\"Vertical cross-section at {lon_act:.0f}°E ({lon_plot:+.0f}°) — \"\n    f\"{DATE} 12:00 UTC  |  ERA5 reanalysis\",\n    fontsize=13, y=1.02,\n)\n\nfig.tight_layout()\nfig.savefig(paths.images_path / \"13_cross_section_0E.png\", dpi=150, bbox_inches=\"tight\")\nplt.show()\n\n\n\n\n\nFigure 11:Vertical cross-section through the atmosphere at 0°E (prime meridian).\nLeft: location map with the section meridian (red).\nCentre: wind speed — the jet stream appears as the orange/red core at\n40–60°N between 8 and 14 km altitude.\nRight: temperature — the stratospheric warm layer above ~12 km and the\nsharp temperature gradient across the jet are clearly visible.\n\n","type":"content","url":"/notebooks/pressure-and-weather#static-cross-section-at-0-e-prime-meridian-with-location-map","position":31},{"hierarchy":{"lvl1":"Pressure Levels and the Jet Stream","lvl3":"Animation: cross-sections at every 5° longitude","lvl2":"Vertical cross-sections"},"type":"lvl3","url":"/notebooks/pressure-and-weather#animation-cross-sections-at-every-5-longitude","position":32},{"hierarchy":{"lvl1":"Pressure Levels and the Jet Stream","lvl3":"Animation: cross-sections at every 5° longitude","lvl2":"Vertical cross-sections"},"content":"The GIF below steps through all meridians in 5° increments, each frame\nshowing the wind-speed and temperature cross-section alongside a world map\nthat highlights the current longitude.\n\nWatch the jet stream core (orange/red, 8–14 km) shift northward and\nsouthward as the section rotates around the globe, tracing the Rossby-wave\nmeanders of the jet.\n\ngif_frames_cs = []\n\nfor lon_cut in range(0, 360, 5):\n    lon_act, lon_plot, lat_2d, z_km_s, wspd_s, t_s = _cross_section_data(ds_pl, lon_cut)\n\n    fig = plt.figure(figsize=(18, 5))\n    gs  = fig.add_gridspec(1, 10, wspace=0.5)\n\n    # Location map\n    ax_map = fig.add_subplot(gs[0, :2], projection=ccrs.Robinson())\n    ax_map.set_global()\n    ax_map.add_feature(cfeature.OCEAN,     facecolor=\"aliceblue\")\n    ax_map.add_feature(cfeature.LAND,      facecolor=\"whitesmoke\")\n    ax_map.add_feature(cfeature.COASTLINE, linewidth=0.5)\n    ax_map.plot([lon_plot, lon_plot], [-90, 90],\n                color=\"crimson\", linewidth=2.5,\n                transform=ccrs.PlateCarree(), zorder=5)\n    ax_map.set_title(\n        f\"{lon_act:.0f}°E ({lon_plot:+.0f}°)\",\n        fontsize=9, color=\"crimson\",\n    )\n\n    # Wind speed\n    ax_w = fig.add_subplot(gs[0, 2:6])\n    cf_w = ax_w.contourf(lat_2d, z_km_s, wspd_s,\n                         levels=np.arange(0, 85, 5), cmap=\"YlOrRd\", extend=\"max\")\n    ax_w.contour(lat_2d, z_km_s, wspd_s, levels=[30, 50, 70],\n                 colors=\"black\", linewidths=0.8, alpha=0.6)\n    fig.colorbar(cf_w, ax=ax_w, fraction=0.04, pad=0.02,\n                 aspect=25).set_label(\"Wind speed (m/s)\", fontsize=9)\n    _fmt_cross_axes(ax_w)\n    ax_w.set_title(\"Wind speed\", fontsize=10)\n\n    # Temperature\n    ax_t = fig.add_subplot(gs[0, 6:10], sharey=ax_w)\n    cf_t = ax_t.contourf(lat_2d, z_km_s, t_s,\n                         levels=np.arange(-80, 25, 5), cmap=\"RdBu_r\", extend=\"both\")\n    ax_t.contour(lat_2d, z_km_s, t_s, levels=np.arange(-80, 25, 10),\n                 colors=\"black\", linewidths=0.6, alpha=0.5)\n    fig.colorbar(cf_t, ax=ax_t, fraction=0.04, pad=0.02,\n                 aspect=25).set_label(\"Temperature (°C)\", fontsize=9)\n    ax_t.set_xlabel(\"Latitude (°)\", fontsize=9)\n    ax_t.xaxis.set_major_formatter(mticker.FormatStrFormatter(\"%d°\"))\n    ax_t.xaxis.set_major_locator(mticker.MultipleLocator(15))\n    ax_t.grid(axis=\"x\", linewidth=0.4, color=\"gray\", alpha=0.5, linestyle=\"--\")\n    ax_t.grid(axis=\"y\", linewidth=0.4, color=\"gray\", alpha=0.3, linestyle=\":\")\n    ax_t.tick_params(labelleft=False)\n    ax_t.set_title(\"Temperature\", fontsize=10)\n\n    fig.suptitle(\n        f\"Vertical cross-section at {lon_act:.0f}°E ({lon_plot:+.0f}°)  —  \"\n        f\"{DATE} 12:00 UTC  |  ERA5 reanalysis\",\n        fontsize=11,\n    )\n    fig.tight_layout()\n\n    buf = io.BytesIO()\n    fig.savefig(buf, format=\"png\", dpi=90, bbox_inches=\"tight\")\n    plt.close(fig)\n    buf.seek(0)\n    gif_frames_cs.append(Image.open(buf).copy())\n    print(f\"  cross-section frame: {lon_act:.0f}°E\", end=\"\\r\")\n\nout_gif_cs = paths.images_path / \"13_cross_section_animation.gif\"\ngif_frames_cs[0].save(\n    out_gif_cs,\n    save_all=True,\n    append_images=gif_frames_cs[1:],\n    duration=200,   # ms per frame\n    loop=0,\n)\nprint(f\"\\nsaved → {out_gif_cs.name}  ({len(gif_frames_cs)} frames)\")\n\n\n\n\n\nFigure 12:Vertical cross-sections rotating around the globe in 5° steps.  Each frame\nshows wind speed (centre) and temperature (right) vs. latitude and geopotential\nheight, paired with a world map highlighting the current meridian (red line).\nThe jet-stream core (orange/red at 8–14 km, 40–65°N) shifts north and south\nwith the Rossby-wave pattern as the section rotates — demonstrating the\njet’s three-dimensional tube-like shape encircling the Northern Hemisphere.\n\n","type":"content","url":"/notebooks/pressure-and-weather#animation-cross-sections-at-every-5-longitude","position":33},{"hierarchy":{"lvl1":"Pressure Levels and the Jet Stream","lvl2":"Column-maximum wind speed"},"type":"lvl2","url":"/notebooks/pressure-and-weather#column-maximum-wind-speed","position":34},{"hierarchy":{"lvl1":"Pressure Levels and the Jet Stream","lvl2":"Column-maximum wind speed"},"content":"By taking the maximum wind speed across all pressure levels at each\nhorizontal grid point, we collapse the full vertical structure into a single\nmap that highlights every location where the jet core passes — regardless\nof its exact altitude.\n\nGrid points where the jet tilts vertically or splits into multiple cores\nare still captured, making this a robust indicator of the jet’s\nhorizontal footprint.\n\nu_all    = ds_pl[\"u_component_of_wind\"].squeeze()  # (level, lat, lon)\nv_all    = ds_pl[\"v_component_of_wind\"].squeeze()\nwspd_all = np.sqrt(u_all**2 + v_all**2)\nwspd_max = wspd_all.max(dim=\"level\")\n\nprint(f\"Column-max wind range: {float(wspd_max.min()):.1f}–{float(wspd_max.max()):.1f} m/s\")\n\n\n\n\n\nwspd_max_c, lons_max_c = add_cyclic_point(wspd_max.values, coord=lons_pl)\n\nfig = plt.figure(figsize=(16, 8))\nax  = fig.add_subplot(1, 1, 1, projection=ccrs.Robinson())\nax.set_global()\n\ncf = ax.contourf(\n    lons_max_c, lats_pl, wspd_max_c,\n    levels=np.arange(0, 85, 5),\n    cmap=\"YlOrRd\", transform=ccrs.PlateCarree(), extend=\"max\",\n)\n\n# Jet-stream footprint: contour line at 30 m/s threshold\nax.contour(\n    lons_max_c, lats_pl, wspd_max_c,\n    levels=[30],\n    colors=[\"mediumpurple\"], linewidths=1.5,\n    transform=ccrs.PlateCarree(),\n)\nlegend_el = [mpatches.Patch(facecolor=\"mediumpurple\", edgecolor=\"mediumpurple\",\n                             label=\"Jet-stream threshold (≥ 30 m/s)\")]\nax.legend(handles=legend_el, loc=\"lower left\", fontsize=10, framealpha=0.85)\n\nax.add_feature(cfeature.COASTLINE, linewidth=0.6, color=\"black\")\nax.add_feature(cfeature.BORDERS,   linewidth=0.3, color=\"black\", alpha=0.7)\nax.add_feature(cfeature.OCEAN,     facecolor=\"aliceblue\",  zorder=0)\nax.add_feature(cfeature.LAND,      facecolor=\"whitesmoke\", zorder=0)\n\ngl = ax.gridlines(crs=ccrs.PlateCarree(), draw_labels=False,\n                  linewidth=0.4, color=\"gray\", alpha=0.5, linestyle=\"--\")\ngl.xlocator = mticker.FixedLocator(range(-180, 181, 30))\ngl.ylocator = mticker.FixedLocator(range(-90,  91,  30))\n\ncbar = fig.colorbar(cf, ax=ax, orientation=\"horizontal\",\n                    pad=0.03, fraction=0.04, aspect=40)\ncbar.set_label(\"Column-maximum wind speed (m/s)\", fontsize=11)\ncbar.ax.tick_params(labelsize=9)\n\nax.set_title(\n    f\"Column-maximum wind speed (850–100 hPa)\\n{DATE} 12:00 UTC  |  ERA5 reanalysis\",\n    fontsize=13, pad=10,\n)\n\nfig.tight_layout()\nfig.savefig(paths.images_path / \"13_jet_colmax.png\", dpi=150, bbox_inches=\"tight\")\nplt.show()\n\n\n\n\n\nFigure 13:Column-maximum wind speed from 850 to 100 hPa.  By collapsing all altitude\nlevels into a single value per grid point, this map shows the horizontal\nfootprint of the jet stream regardless of where it sits vertically.  The\npurple contour marks the 30 m/s threshold commonly used to define the\njet-stream boundary.  In this summer snapshot, the jet is weaker than in\nwinter and displaced poleward, leaving a narrower and more fragmented footprint.\n\n","type":"content","url":"/notebooks/pressure-and-weather#column-maximum-wind-speed","position":35},{"hierarchy":{"lvl1":"Pressure Levels and the Jet Stream","lvl2":"Summary"},"type":"lvl2","url":"/notebooks/pressure-and-weather#summary","position":36},{"hierarchy":{"lvl1":"Pressure Levels and the Jet Stream","lvl2":"Summary"},"content":"Combining the visualisations above builds a coherent picture of the jet\nstream as a three-dimensional structure:\n\nAt the surface (10 m wind, cloud cover, 2m temperature), the jet’s\ninfluence is indirect — it steers cyclones and anticyclones that modulate\nsurface conditions.\n\nIn the mid-troposphere (500 hPa geopotential), the Rossby-wave pattern\nshows the large-scale trough/ridge structure that the jet follows.\n\nAt jet-stream altitude (200–250 hPa), the fast core is concentrated\nin a band 20–30° latitude wide, reaching 60–80 m/s in winter (weaker in\nthis June snapshot).\n\nVertical cross-sections reveal the core sitting between ~8 and 14 km,\nwith the strongest winds near the tropopause (~200 hPa).\n\nThe polar view and column-maximum map show the jet’s horizontal\nfootprint as a ring around the Northern Hemisphere, punctuated by the\nRossby-wave meanders that connect upper-level dynamics to surface weather.\n\nFor energy systems, the key takeaway is that wind and solar availability\nacross Europe depend critically on the current state of this three-dimensional\njet — its latitude, its strength, and whether it is blocked or meandering.\n\n\n\n","type":"content","url":"/notebooks/pressure-and-weather#summary","position":37},{"hierarchy":{"lvl1":"Weather Variability in Germany — Beyond the Seasonal Cycle"},"type":"lvl1","url":"/notebooks/germany-variations","position":0},{"hierarchy":{"lvl1":"Weather Variability in Germany — Beyond the Seasonal Cycle"},"content":"Monthly ERA5 climatology tells us what is typical for each calendar month,\nbut the actual value in any given year can differ substantially from that\nmean.  This notebook shows the full spread of monthly values (1940–2024)\nfor temperature, wind speed, and solar radiation, and then analyses\nDunkelflaute — months when both wind power and solar power potential\nare simultaneously very low.\n\nData source: ERA5 monthly Germany spatial means\n(16_compute_germany_time_series.py)\n\nVariable\n\nERA5 field\n\nUnit\n\n2 m temperature\n\nt2m\n\n°C\n\n100 m wind speed\n\nwind_speed_100m\n\nm/s\n\nSolar radiation\n\nssrd\n\nkWh/m²/day\n\nimport numpy as np\nimport pandas as pd\nimport matplotlib.pyplot as plt\nimport matplotlib.colors as mcolors\nimport xarray as xr\nimport cartopy.crs as ccrs\nimport cartopy.feature as cfeature\n\nfrom woe.paths import ProjPaths\n\npaths = ProjPaths()\n\n\n\n# Load Germany monthly time series produced by 16_compute_germany_time_series.py\ndf = pd.read_parquet(paths.era5_germany_monthly_ts_file)\n\n# Derived columns\ndf[\"t2m_c\"]    = df[\"t2m\"] - 273.15      # K → °C\ndf[\"ssrd_kwh\"] = df[\"ssrd\"] / 3.6e6     # J/m² (daily mean) → kWh/m²/day\ndf[\"month\"]    = df.index.month\ndf[\"year\"]     = df.index.year\n\nMONTH_LABELS = [\"Jan\", \"Feb\", \"Mar\", \"Apr\", \"May\", \"Jun\",\n                \"Jul\", \"Aug\", \"Sep\", \"Oct\", \"Nov\", \"Dec\"]\n\nprint(f\"Loaded {len(df)} monthly records, \"\n      f\"{df['year'].min()}–{df['year'].max()}\")\nprint(f\"Columns: {list(df.columns)}\")\n\n\n\ndef jitter_plot(ax, df, var, ylabel, title,\n                cmap=\"RdBu_r\", vmin=None, vmax=None,\n                hline=None, hline_label=None):\n    \"\"\"Jitter plot: one dot per year for each calendar month.\n\n    Dots are coloured by the variable value.  The black horizontal bar\n    marks the calendar-month median.\n    \"\"\"\n    rng = np.random.default_rng(42)\n    vals = df[var].values\n    if vmin is None:\n        vmin = np.percentile(vals, 2)\n    if vmax is None:\n        vmax = np.percentile(vals, 98)\n\n    norm = mcolors.Normalize(vmin=vmin, vmax=vmax)\n    cmap_obj = plt.get_cmap(cmap)\n\n    for m in range(1, 13):\n        data = df.loc[df[\"month\"] == m, var].values\n        x = m + rng.uniform(-0.28, 0.28, len(data))\n        ax.scatter(x, data, c=cmap_obj(norm(data)),\n                   s=16, alpha=0.80, zorder=3, linewidths=0)\n        med = np.median(data)\n        ax.plot([m - 0.32, m + 0.32], [med, med],\n                color=\"black\", linewidth=1.8, zorder=4)\n\n    if hline is not None:\n        ax.axhline(hline, color=\"#3a8abf\", linewidth=1.0,\n                   linestyle=\"--\", alpha=0.7, label=hline_label)\n        if hline_label:\n            ax.legend(fontsize=8, loc=\"upper right\")\n\n    ax.set_xticks(range(1, 13))\n    ax.set_xticklabels(MONTH_LABELS)\n    ax.set_ylabel(ylabel)\n    ax.set_title(title, fontsize=11, fontweight=\"bold\")\n    ax.grid(axis=\"y\", linewidth=0.4, alpha=0.4)\n    ax.set_xlim(0.5, 12.5)\n\n\n\n","type":"content","url":"/notebooks/germany-variations","position":1},{"hierarchy":{"lvl1":"Weather Variability in Germany — Beyond the Seasonal Cycle","lvl2":"2 m temperature by calendar month"},"type":"lvl2","url":"/notebooks/germany-variations#id-2-m-temperature-by-calendar-month","position":2},{"hierarchy":{"lvl1":"Weather Variability in Germany — Beyond the Seasonal Cycle","lvl2":"2 m temperature by calendar month"},"content":"\n\nfig, ax = plt.subplots(figsize=(13, 5))\njitter_plot(\n    ax, df, \"t2m_c\",\n    ylabel=\"2 m temperature (°C)\",\n    title=\"ERA5 monthly 2 m temperature by month — Germany (one dot per year)\",\n    cmap=\"RdYlBu_r\",\n    hline=0, hline_label=\"0 °C\",\n)\nfig.tight_layout()\nfig.savefig(paths.images_path / \"17_germany_t2m_jitter.png\", dpi=150, bbox_inches=\"tight\")\nplt.show()\n\n\n\n\n\nFigure 1:ERA5 monthly mean 2 m temperature for Germany (spatial mean), 1940–2024.\nEach dot is one year; the black bar marks the calendar-month median.\nThe spread within each month shows the substantial year-to-year variability\ndriven by atmospheric circulation patterns such as the NAO and blocking events.\n\n","type":"content","url":"/notebooks/germany-variations#id-2-m-temperature-by-calendar-month","position":3},{"hierarchy":{"lvl1":"Weather Variability in Germany — Beyond the Seasonal Cycle","lvl2":"100 m wind speed by calendar month"},"type":"lvl2","url":"/notebooks/germany-variations#id-100-m-wind-speed-by-calendar-month","position":4},{"hierarchy":{"lvl1":"Weather Variability in Germany — Beyond the Seasonal Cycle","lvl2":"100 m wind speed by calendar month"},"content":"100 m wind speed is the most direct ERA5 proxy for wind-turbine output.\nWind is strongest in winter but shows large year-to-year scatter in every\nseason, driven by variability in the jet stream and Atlantic storm tracks.\n\nfig, ax = plt.subplots(figsize=(13, 5))\njitter_plot(\n    ax, df, \"wind_speed_100m\",\n    ylabel=\"100 m wind speed (m/s)\",\n    title=\"ERA5 monthly 100 m wind speed by month — Germany (one dot per year)\",\n    cmap=\"viridis\",\n)\nfig.tight_layout()\nfig.savefig(paths.images_path / \"17_germany_wind_jitter.png\", dpi=150, bbox_inches=\"tight\")\nplt.show()\n\n\n\n\n\nFigure 2:ERA5 monthly mean 100 m wind speed for Germany (spatial mean), 1940–2024.\nWinter months (Nov–Feb) are on average windiest but also show the largest\nabsolute spread.  Low-wind winter months are potential Dunkelflaute candidates.\n\n","type":"content","url":"/notebooks/germany-variations#id-100-m-wind-speed-by-calendar-month","position":5},{"hierarchy":{"lvl1":"Weather Variability in Germany — Beyond the Seasonal Cycle","lvl2":"Surface solar radiation by calendar month"},"type":"lvl2","url":"/notebooks/germany-variations#surface-solar-radiation-by-calendar-month","position":6},{"hierarchy":{"lvl1":"Weather Variability in Germany — Beyond the Seasonal Cycle","lvl2":"Surface solar radiation by calendar month"},"content":"Monthly mean surface solar radiation (ssrd), converted to kWh/m²/day,\nis a proxy for photovoltaic output potential.  The near-zero winter values\nreflect Germany’s high latitude (~47–55°N) and the short winter day length.\nSummer months show remarkably little year-to-year spread compared with wind.\n\nfig, ax = plt.subplots(figsize=(13, 5))\njitter_plot(\n    ax, df, \"ssrd_kwh\",\n    ylabel=\"Surface solar radiation (kWh/m²/day)\",\n    title=\"ERA5 monthly surface solar radiation by month — Germany (one dot per year)\",\n    cmap=\"plasma\",\n)\nfig.tight_layout()\nfig.savefig(paths.images_path / \"17_germany_ssrd_jitter.png\", dpi=150, bbox_inches=\"tight\")\nplt.show()\n\n\n\n\n\nFigure 3:ERA5 monthly mean surface solar radiation downwards for Germany, 1940–2024.\nThe seasonal cycle dominates: values approach zero in December and peak in\nJune–July.  Year-to-year variability is moderate in summer (cloud-cover\ndifferences) but negligible in winter where solar geometry constrains output.\n\n","type":"content","url":"/notebooks/germany-variations#surface-solar-radiation-by-calendar-month","position":7},{"hierarchy":{"lvl1":"Weather Variability in Germany — Beyond the Seasonal Cycle","lvl2":"Dunkelflaute analysis"},"type":"lvl2","url":"/notebooks/germany-variations#dunkelflaute-analysis","position":8},{"hierarchy":{"lvl1":"Weather Variability in Germany — Beyond the Seasonal Cycle","lvl2":"Dunkelflaute analysis"},"content":"Dunkelflaute (lit. “dark doldrums”) describes periods when both wind and\nsolar renewable generation are simultaneously very low — a critical stress\nscenario for a power system with high renewable penetration.\n\nDefinition used here: a month is classified as Dunkelflaute when\nGermany-mean 100 m wind speed and surface solar radiation are both\nbelow their respective 25th percentiles computed over all 1020 months\n(1940–2024).  This captures the joint bottom-quartile tail of both\nresource distributions.\n\n# --- Dunkelflaute thresholds ---\np25_wind  = df[\"wind_speed_100m\"].quantile(0.25)\np25_solar = df[\"ssrd_kwh\"].quantile(0.25)\n\ndf[\"dunkelflaute\"] = (\n    (df[\"wind_speed_100m\"] < p25_wind) &\n    (df[\"ssrd_kwh\"]        < p25_solar)\n)\n\nn_df  = df[\"dunkelflaute\"].sum()\nfrac  = n_df / len(df)\nprint(f\"Thresholds — wind: {p25_wind:.2f} m/s,  solar: {p25_solar:.3f} kWh/m²/day\")\nprint(f\"Dunkelflaute months: {n_df} / {len(df)}  ({100*frac:.1f} %)\")\nprint(\"\\nCount per calendar month:\")\nprint(df.groupby(\"month\")[\"dunkelflaute\"].sum().to_string())\n\n\n\n\n\n# 12 perceptually distinct colours for the months (cyclic HSV)\nMONTH_COLORS = plt.get_cmap(\"hsv\")(np.linspace(0, 1, 13))[:12]\n\nfig, axes = plt.subplots(1, 2, figsize=(14, 6))\n\n# --- Left: wind vs solar scatter, coloured by calendar month ---\nax = axes[0]\nfor m in range(1, 13):\n    sel = df[df[\"month\"] == m]\n    ax.scatter(\n        sel[\"wind_speed_100m\"], sel[\"ssrd_kwh\"],\n        color=MONTH_COLORS[m - 1], s=14, alpha=0.75,\n        label=MONTH_LABELS[m - 1], zorder=3, linewidths=0,\n    )\n\n# Dunkelflaute quadrant shading\nax.axvline(p25_wind,  color=\"gray\", linewidth=0.9, linestyle=\"--\", alpha=0.6)\nax.axhline(p25_solar, color=\"gray\", linewidth=0.9, linestyle=\"--\", alpha=0.6)\nxmax = df[\"wind_speed_100m\"].max() * 1.05\nymax = df[\"ssrd_kwh\"].max() * 1.05\nax.fill_betweenx(\n    [0, p25_solar], 0, p25_wind,\n    color=\"steelblue\", alpha=0.15, zorder=1,\n)\nax.text(\n    p25_wind * 0.48, p25_solar * 0.50,\n    \"Dunkelflaute\\nzone\",\n    ha=\"center\", va=\"center\",\n    fontsize=9, color=\"steelblue\", fontweight=\"bold\",\n)\nax.set_xlabel(\"100 m wind speed (m/s)\")\nax.set_ylabel(\"Surface solar radiation (kWh/m²/day)\")\nax.set_title(\n    \"Wind vs solar — Germany monthly means\\n(coloured by calendar month)\",\n    fontsize=10, fontweight=\"bold\",\n)\nax.legend(title=\"Month\", ncol=2, fontsize=7, title_fontsize=8,\n          loc=\"upper right\", framealpha=0.9)\nax.set_xlim(0, xmax)\nax.set_ylim(0, ymax)\nax.grid(linewidth=0.4, alpha=0.4)\n\n# --- Right: Dunkelflaute frequency by calendar month ---\nax2 = axes[1]\nfreq = df.groupby(\"month\")[\"dunkelflaute\"].mean() * 100\nbar_colors = [MONTH_COLORS[m - 1] for m in freq.index]\nax2.bar(freq.index, freq.values, color=bar_colors, width=0.7, alpha=0.85, zorder=3)\nax2.axhline(frac * 100, color=\"black\", linewidth=1.0, linestyle=\"--\", alpha=0.6,\n            label=f\"Overall rate ({frac*100:.1f}%)\")\nax2.set_xticks(range(1, 13))\nax2.set_xticklabels(MONTH_LABELS)\nax2.set_ylabel(\"Frequency of Dunkelflaute years (%)\")\nax2.set_title(\n    \"Dunkelflaute frequency by calendar month\\n\"\n    \"(wind < p25 AND solar < p25, ERA5 1940–2024)\",\n    fontsize=10, fontweight=\"bold\",\n)\nax2.grid(axis=\"y\", linewidth=0.4, alpha=0.4)\nax2.legend(fontsize=8)\n\nfig.suptitle(\"Dunkelflaute analysis — Germany ERA5 1940–2024\",\n             fontsize=12, fontweight=\"bold\")\nfig.tight_layout()\nfig.savefig(paths.images_path / \"17_germany_dunkelflaute.png\", dpi=150, bbox_inches=\"tight\")\nplt.show()\n\n\n\n\n\nFigure 4:Left: scatter of Germany monthly 100 m wind speed vs surface solar\nradiation, 1940–2024, coloured by calendar month.  The shaded blue quadrant\nmarks the Dunkelflaute zone (both resources below their 25th percentile).\nRight: fraction of years in each calendar month that fell into the\nDunkelflaute zone.  Dunkelflaute events are overwhelmingly concentrated in\nNovember–January, when solar output is structurally near zero and wind can\nalso be suppressed by blocking anticyclones.\n\n","type":"content","url":"/notebooks/germany-variations#dunkelflaute-analysis","position":9},{"hierarchy":{"lvl1":"Weather Variability in Germany — Beyond the Seasonal Cycle","lvl2":"Case studies: cold vs warm January"},"type":"lvl2","url":"/notebooks/germany-variations#case-studies-cold-vs-warm-january","position":10},{"hierarchy":{"lvl1":"Weather Variability in Germany — Beyond the Seasonal Cycle","lvl2":"Case studies: cold vs warm January"},"content":"To show how the large-scale circulation drives extreme temperature anomalies\nwe compare January 1963 (coldest: Germany mean −7.3 °C, the Big Freeze,\ncaused by a blocking anticyclone funnelling Arctic/Siberian air into central\nEurope) against January 2007 (warmest: Germany mean +4.9 °C, associated with\na strongly positive NAO and persistent westerly flow from the Atlantic).\n\nBoth months are shown with identical colour scales so differences are\nimmediately comparable.\n\nCOLD_YEAR = 1963\nWARM_YEAR = 2007\nG = 9.80665  # standard gravity (m/s2)\n\nt2m_cold_de = float(df.loc[f\"{COLD_YEAR}-01-01\", \"t2m_c\"])\nt2m_warm_de = float(df.loc[f\"{WARM_YEAR}-01-01\", \"t2m_c\"])\nprint(f\"Cold case: January {COLD_YEAR}  Germany mean = {t2m_cold_de:.1f} °C\")\nprint(f\"Warm case: January {WARM_YEAR}  Germany mean = {t2m_warm_de:.1f} °C\")\n\n\n\n\n\n# Load spatial ERA5 fields for both case months\nds = xr.open_zarr(paths.era5_monthly_zarr_path)\n\ndef _load_fields(year):\n    date = f\"{year}-01\"\n    t2m  = (ds[\"t2m\"].sel(time=date).squeeze() - 273.15).compute()\n    z500 = (ds[\"z\"].sel(time=date, pressure_level=500).squeeze() / G).compute()\n    u250 = ds[\"u\"].sel(time=date, pressure_level=250).squeeze().compute()\n    v250 = ds[\"v\"].sel(time=date, pressure_level=250).squeeze().compute()\n    wspd = np.sqrt(u250**2 + v250**2)\n    return t2m, z500, u250, v250, wspd\n\nt2m_cold, z500_cold, u250_cold, v250_cold, wspd250_cold = _load_fields(COLD_YEAR)\nt2m_warm, z500_warm, u250_warm, v250_warm, wspd250_warm = _load_fields(WARM_YEAR)\n\n# Shared colour and contour limits (computed across both months)\nT2M_VMIN, T2M_VMAX = -40, 20\nWIND_VMAX = max(float(wspd250_cold.max()), float(wspd250_warm.max()))\n\n_z_all_min = min(float(z500_cold.min()), float(z500_warm.min()))\n_z_all_max = max(float(z500_cold.max()), float(z500_warm.max()))\nZ500_LEVELS = np.arange(\n    np.floor(_z_all_min / 80) * 80,\n    np.ceil(_z_all_max  / 80) * 80 + 1,\n    80,\n)\n\nprint(f\"Shared wind vmax: {WIND_VMAX:.1f} m/s\")\nprint(f\"Z500 levels: {Z500_LEVELS[0]:.0f} … {Z500_LEVELS[-1]:.0f} m \"\n      f\"({len(Z500_LEVELS)} contours)\")\n\n\n\n\n\n# Shared map settings\nPROJ   = ccrs.Orthographic(central_longitude=-10, central_latitude=55)\nEXTENT = [-90, 40, 20, 80]   # W, E, S, N  (PlateCarree)\nN = 5  # quiver thinning factor\n\nlons_q = u250_cold.longitude.values[::N]\nlats_q = u250_cold.latitude.values[::N]\n\n\n\n","type":"content","url":"/notebooks/germany-variations#case-studies-cold-vs-warm-january","position":11},{"hierarchy":{"lvl1":"Weather Variability in Germany — Beyond the Seasonal Cycle","lvl3":"2 m temperature — cold vs warm January","lvl2":"Case studies: cold vs warm January"},"type":"lvl3","url":"/notebooks/germany-variations#id-2-m-temperature-cold-vs-warm-january","position":12},{"hierarchy":{"lvl1":"Weather Variability in Germany — Beyond the Seasonal Cycle","lvl3":"2 m temperature — cold vs warm January","lvl2":"Case studies: cold vs warm January"},"content":"\n\nfig, axes = plt.subplots(\n    1, 2, figsize=(18, 8),\n    subplot_kw={\"projection\": PROJ},\n)\n\ncases_t2m = [\n    (axes[0], t2m_cold, z500_cold, COLD_YEAR, t2m_cold_de),\n    (axes[1], t2m_warm, z500_warm, WARM_YEAR, t2m_warm_de),\n]\n\nfor ax, t2m, z500, year, t2m_de in cases_t2m:\n    ax.set_extent(EXTENT, crs=ccrs.PlateCarree())\n    im = ax.pcolormesh(\n        t2m.longitude, t2m.latitude, t2m.values,\n        transform=ccrs.PlateCarree(),\n        cmap=\"RdYlBu_r\", vmin=T2M_VMIN, vmax=T2M_VMAX,\n    )\n    cs = ax.contour(\n        z500.longitude, z500.latitude, z500.values,\n        levels=Z500_LEVELS,\n        colors=\"black\", linewidths=0.6, alpha=0.55,\n        transform=ccrs.PlateCarree(),\n    )\n    ax.clabel(cs, fmt=\"%d\", fontsize=7, inline=True)\n    ax.add_feature(cfeature.COASTLINE, linewidth=0.7)\n    ax.add_feature(cfeature.BORDERS, linewidth=0.4, linestyle=\":\")\n    ax.gridlines(linewidth=0.3, color=\"gray\", alpha=0.5)\n    ax.plot(10.5, 51.2, transform=ccrs.PlateCarree(),\n            marker=\"*\", markersize=11, color=\"gold\",\n            markeredgecolor=\"black\", markeredgewidth=0.6, zorder=5)\n    ax.text(12.5, 51.2, \"Germany\", transform=ccrs.PlateCarree(),\n            fontsize=9, fontweight=\"bold\", color=\"black\", va=\"center\", zorder=5)\n    ax.set_title(\n        f\"January {year}  (Germany mean: {t2m_de:+.1f} °C)\\nZ500 contours every 80 m\",\n        fontsize=11, fontweight=\"bold\",\n    )\n\nfig.colorbar(\n    im, ax=axes, orientation=\"horizontal\", pad=0.04, fraction=0.03,\n    label=\"2 m temperature (°C)\",\n)\nfig.suptitle(\n    \"ERA5 2 m temperature — cold vs warm January\",\n    fontsize=13, fontweight=\"bold\",\n)\nfig.tight_layout()\nfig.savefig(paths.images_path / \"17_january_t2m_comparison.png\", dpi=150, bbox_inches=\"tight\")\nplt.show()\n\n\n\n\n\nFigure 5:ERA5 2 m temperature for January 1963 (left, cold) and January 2007 (right,\nwarm) on an orthographic projection.  Both panels share the same colour scale\nand Z500 contour levels (every 80 m, black lines) to make comparison direct.\nIn 1963 a blocking ridge over Scandinavia/Russia channels Arctic air into\ncentral Europe (deep blue over Germany); in 2007 a strongly positive NAO\ndrives mild Atlantic westerlies across the continent (orange-yellow over\nwestern Europe).\n\n","type":"content","url":"/notebooks/germany-variations#id-2-m-temperature-cold-vs-warm-january","position":13},{"hierarchy":{"lvl1":"Weather Variability in Germany — Beyond the Seasonal Cycle","lvl3":"250 hPa wind speed and Z500 — cold vs warm January","lvl2":"Case studies: cold vs warm January"},"type":"lvl3","url":"/notebooks/germany-variations#id-250-hpa-wind-speed-and-z500-cold-vs-warm-january","position":14},{"hierarchy":{"lvl1":"Weather Variability in Germany — Beyond the Seasonal Cycle","lvl3":"250 hPa wind speed and Z500 — cold vs warm January","lvl2":"Case studies: cold vs warm January"},"content":"\n\nfig, axes = plt.subplots(\n    1, 2, figsize=(18, 8),\n    subplot_kw={\"projection\": PROJ},\n)\n\ncases_wind = [\n    (axes[0], wspd250_cold, z500_cold, u250_cold, v250_cold, COLD_YEAR),\n    (axes[1], wspd250_warm, z500_warm, u250_warm, v250_warm, WARM_YEAR),\n]\n\nfor ax, wspd, z500, u250, v250, year in cases_wind:\n    ax.set_extent(EXTENT, crs=ccrs.PlateCarree())\n    im = ax.pcolormesh(\n        wspd.longitude, wspd.latitude, wspd.values,\n        transform=ccrs.PlateCarree(),\n        cmap=\"plasma\", vmin=0, vmax=WIND_VMAX,\n    )\n    cs = ax.contour(\n        z500.longitude, z500.latitude, z500.values,\n        levels=Z500_LEVELS,\n        colors=\"white\", linewidths=0.8, alpha=0.65,\n        transform=ccrs.PlateCarree(),\n    )\n    ax.clabel(cs, fmt=\"%d\", fontsize=7, inline=True, colors=\"white\")\n    ax.quiver(\n        lons_q, lats_q,\n        u250.values[::N, ::N], v250.values[::N, ::N],\n        transform=ccrs.PlateCarree(),\n        scale=2500, width=0.0012, color=\"white\", alpha=0.65,\n    )\n    ax.add_feature(cfeature.COASTLINE, linewidth=0.7)\n    ax.add_feature(cfeature.BORDERS, linewidth=0.4, linestyle=\":\")\n    ax.gridlines(linewidth=0.3, color=\"gray\", alpha=0.5)\n    ax.set_title(\n        f\"January {year}\\nZ500 contours every 80 m  |  arrows = wind direction\",\n        fontsize=11, fontweight=\"bold\",\n    )\n\nfig.colorbar(\n    im, ax=axes, orientation=\"horizontal\", pad=0.04, fraction=0.03,\n    label=\"250 hPa wind speed (m/s)\",\n)\nfig.suptitle(\n    \"250 hPa wind speed and Z500 — cold vs warm January\",\n    fontsize=13, fontweight=\"bold\",\n)\nfig.tight_layout()\nfig.savefig(paths.images_path / \"17_january_250hpa_comparison.png\", dpi=150, bbox_inches=\"tight\")\nplt.show()\n\n\n\n\n\nFigure 6:250 hPa wind speed (colour; shared plasma scale) and Z500 contours (white,\nevery 80 m) for January 1963 (left) and January 2007 (right).  White arrows\nshow wind direction.  In 1963 the jet is displaced southward and weakened\nover central Europe due to the blocking ridge; in 2007 the jet is strong and\ndirected straight at Europe, advecting mild air from the Atlantic.","type":"content","url":"/notebooks/germany-variations#id-250-hpa-wind-speed-and-z500-cold-vs-warm-january","position":15},{"hierarchy":{"lvl1":"Monthly ERA5 Reanalysis"},"type":"lvl1","url":"/notebooks/nao-index","position":0},{"hierarchy":{"lvl1":"Monthly ERA5 Reanalysis"},"content":"This notebook loads the monthly ERA5 reanalysis data downloaded from the\nCopernicus Climate Data Store and stored as a Zarr archive.  It visualises\n2 m temperature on a Robinson projection.\n\nimport numpy as np\nimport pandas as pd\nimport xarray as xr\nimport matplotlib.pyplot as plt\nimport cartopy.crs as ccrs\nimport cartopy.feature as cfeature\n\nfrom woe.paths import ProjPaths\n\npaths = ProjPaths()\n\n\n\n","type":"content","url":"/notebooks/nao-index","position":1},{"hierarchy":{"lvl1":"Monthly ERA5 Reanalysis","lvl2":"Load Zarr store"},"type":"lvl2","url":"/notebooks/nao-index#load-zarr-store","position":2},{"hierarchy":{"lvl1":"Monthly ERA5 Reanalysis","lvl2":"Load Zarr store"},"content":"\n\nds = xr.open_zarr(paths.era5_monthly_zarr_path)\nprint(f\"Variables:   {list(ds.data_vars)}\")\nprint(f\"Dimensions:  {dict(ds.dims)}\")\nprint(f\"Time range:  {ds.time.values[0]} → {ds.time.values[-1]}\")\n\n\n\n","type":"content","url":"/notebooks/nao-index#load-zarr-store","position":3},{"hierarchy":{"lvl1":"Monthly ERA5 Reanalysis","lvl2":"2 m temperature — January 2025"},"type":"lvl2","url":"/notebooks/nao-index#id-2-m-temperature-january-2025","position":4},{"hierarchy":{"lvl1":"Monthly ERA5 Reanalysis","lvl2":"2 m temperature — January 2025"},"content":"\n\nDATE = \"2024-01\"\nt2m = ds[\"t2m\"].sel(time=DATE).squeeze() - 273.15  # K → °C\n\nfig, ax = plt.subplots(\n    figsize=(14, 7),\n    subplot_kw={\"projection\": ccrs.Robinson()},\n)\n\nim = ax.pcolormesh(\n    t2m.longitude,\n    t2m.latitude,\n    t2m.values,\n    transform=ccrs.PlateCarree(),\n    cmap=\"RdBu_r\",\n    vmin=-40,\n    vmax=40,\n)\n\nax.add_feature(cfeature.COASTLINE, linewidth=0.6)\nax.add_feature(cfeature.BORDERS, linewidth=0.3, linestyle=\":\")\nax.gridlines(linewidth=0.3, color=\"gray\", alpha=0.5)\n\ncbar = fig.colorbar(im, ax=ax, orientation=\"horizontal\", pad=0.04, fraction=0.04)\ncbar.set_label(\"2 m temperature (°C)\")\n\nax.set_title(f\"ERA5 monthly mean 2 m temperature — {DATE}\", fontsize=13)\n\nfig.tight_layout()\nfig.savefig(paths.images_path / \"15_era5_t2m_2025_01.png\", dpi=150, bbox_inches=\"tight\")\nplt.show()\n\n\n\n\n\nFigure 1:ERA5 monthly mean 2 m temperature for January 2025 on a Robinson projection.\n\n","type":"content","url":"/notebooks/nao-index#id-2-m-temperature-january-2025","position":5},{"hierarchy":{"lvl1":"Monthly ERA5 Reanalysis","lvl2":"2 m temperature — January 2025 (Europe, Lambert Conformal)"},"type":"lvl2","url":"/notebooks/nao-index#id-2-m-temperature-january-2025-europe-lambert-conformal","position":6},{"hierarchy":{"lvl1":"Monthly ERA5 Reanalysis","lvl2":"2 m temperature — January 2025 (Europe, Lambert Conformal)"},"content":"\n\nproj = ccrs.LambertConformal(central_longitude=10, central_latitude=50)\n\nfig, ax = plt.subplots(figsize=(10, 9), subplot_kw={\"projection\": proj})\n\nax.set_extent([-25, 45, 30, 72], crs=ccrs.PlateCarree())\n\nim = ax.pcolormesh(\n    t2m.longitude,\n    t2m.latitude,\n    t2m.values,\n    transform=ccrs.PlateCarree(),\n    cmap=\"RdBu_r\",\n    vmin=-25,\n    vmax=25,\n)\n\nax.add_feature(cfeature.COASTLINE, linewidth=0.7)\nax.add_feature(cfeature.BORDERS, linewidth=0.4, linestyle=\":\")\nax.add_feature(cfeature.LAND, facecolor=\"none\", edgecolor=\"none\")\ngl = ax.gridlines(draw_labels=True, linewidth=0.3, color=\"gray\", alpha=0.5)\ngl.top_labels = False\ngl.right_labels = False\n\ncbar = fig.colorbar(im, ax=ax, orientation=\"vertical\", pad=0.04, fraction=0.03)\ncbar.set_label(\"2 m temperature (°C)\")\n\nax.set_title(f\"ERA5 monthly mean 2 m temperature — {DATE}\", fontsize=13)\n\nfig.tight_layout()\nfig.savefig(paths.images_path / \"15_era5_t2m_europe_2025_01.png\", dpi=150, bbox_inches=\"tight\")\nplt.show()\n\n\n\n\n\nFigure 2:ERA5 monthly mean 2 m temperature for January 2025 over Europe on a Lambert\nConformal projection.\n\n","type":"content","url":"/notebooks/nao-index#id-2-m-temperature-january-2025-europe-lambert-conformal","position":7},{"hierarchy":{"lvl1":"Monthly ERA5 Reanalysis","lvl2":"2 m temperature — January 2025 (full domain, Plate Carrée)"},"type":"lvl2","url":"/notebooks/nao-index#id-2-m-temperature-january-2025-full-domain-plate-carr-e","position":8},{"hierarchy":{"lvl1":"Monthly ERA5 Reanalysis","lvl2":"2 m temperature — January 2025 (full domain, Plate Carrée)"},"content":"\n\n# BOUNDING_BOX = [North=80, West=-90, South=20, East=40]\nfig, ax = plt.subplots(\n    figsize=(14, 7),\n    subplot_kw={\"projection\": ccrs.PlateCarree()},\n)\n\nax.set_extent([-90, 40, 20, 80], crs=ccrs.PlateCarree())\n\nim = ax.pcolormesh(\n    t2m.longitude,\n    t2m.latitude,\n    t2m.values,\n    transform=ccrs.PlateCarree(),\n    cmap=\"RdBu_r\",\n    vmin=-40,\n    vmax=40,\n)\n\nax.add_feature(cfeature.COASTLINE, linewidth=0.6)\nax.add_feature(cfeature.BORDERS, linewidth=0.3, linestyle=\":\")\ngl = ax.gridlines(draw_labels=True, linewidth=0.3, color=\"gray\", alpha=0.5)\ngl.top_labels = False\ngl.right_labels = False\n\ncbar = fig.colorbar(im, ax=ax, orientation=\"horizontal\", pad=0.05, fraction=0.04)\ncbar.set_label(\"2 m temperature (°C)\")\n\nax.set_title(f\"ERA5 monthly mean 2 m temperature — {DATE}\", fontsize=13)\n\nfig.tight_layout()\nfig.savefig(paths.images_path / \"15_era5_t2m_domain_2025_01.png\", dpi=150, bbox_inches=\"tight\")\nplt.show()\n\n\n\n\n\nFigure 3:ERA5 monthly mean 2 m temperature for January 2025 on a Plate Carrée projection\nshowing the full downloaded domain.\n\n","type":"content","url":"/notebooks/nao-index#id-2-m-temperature-january-2025-full-domain-plate-carr-e","position":9},{"hierarchy":{"lvl1":"Monthly ERA5 Reanalysis","lvl2":"Winter NAO Index (1940–2024)"},"type":"lvl2","url":"/notebooks/nao-index#winter-nao-index-1940-2024","position":10},{"hierarchy":{"lvl1":"Monthly ERA5 Reanalysis","lvl2":"Winter NAO Index (1940–2024)"},"content":"The station-based North Atlantic Oscillation (NAO) index is the standardised\nmean-sea-level pressure (MSLP) difference between the Azores (Ponta Delgada)\nand Iceland (Reykjavik), following the Hurrell (1995) definition.\n\nPositive NAO winters bring stronger-than-normal westerlies across the North\nAtlantic, resulting in warmer and wetter conditions over northern Europe.\nNegative NAO winters are associated with blocking and cold-air outbreaks.\n\nMethod:\n\nFilter monthly ERA5 MSLP to DJF months only.\n\nResample with YS-DEC so that Dec(N), Jan(N+1), Feb(N+1) form one\nseason labelled by year N — identical to the Hurrell convention.\n\nDrop boundary seasons with fewer than 3 months (first and last groups\nare partial because the dataset starts in January 1940).\n\nSnap to the nearest ERA5 grid point for each station.\n\nNormalise each series independently (subtract mean, divide by std).\n\nNAO index = Azores normalised − Iceland normalised.\n\n# ERA5 short name for mean sea level pressure is 'msl'\nmsl = ds[\"msl\"]\n\n# --- Step 1: keep only DJF months ---\nis_djf = msl[\"time.month\"].isin([12, 1, 2])\nwinter_mslp = msl.sel(time=is_djf)\n\n# --- Step 2: resample into DJF seasons anchored at December ---\nwinter_means = winter_mslp.resample(time=\"YS-DEC\").mean()\nwinter_counts = winter_mslp.resample(time=\"YS-DEC\").count(dim=\"time\")\n\n# --- Step 3: drop incomplete boundary seasons (< 3 months) ---\n# Use a single reference point to get a 1-D count series for the time mask.\n_count_ref = winter_counts.isel(latitude=0, longitude=0, drop=True)\ncomplete = _count_ref == 3\nwinter_means = winter_means.sel(time=complete)\n\n# --- Step 4: extract station points (nearest ERA5 grid point) ---\n# Ponta Delgada, São Miguel, Azores: 37.74°N, 25.67°W\n# Reykjavik, Iceland:               64.13°N, 21.90°W\nazores  = winter_means.sel(latitude=37.74, longitude=-25.67, method=\"nearest\")\niceland = winter_means.sel(latitude=64.13, longitude=-21.90, method=\"nearest\")\n\n# --- Step 5: standardise each series over its full period ---\nazores_norm  = (azores  - azores.mean(\"time\"))  / azores.std(\"time\")\niceland_norm = (iceland - iceland.mean(\"time\")) / iceland.std(\"time\")\n\n# --- Step 6: NAO index ---\nnao = (azores_norm - iceland_norm).compute()\n\nyears  = nao.time.dt.year.values\nvalues = nao.values\n\nprint(f\"NAO index: {len(years)} winters ({years[0]}/{years[0]+1} – {years[-1]}/{years[-1]+1})\")\nprint(f\"Mean: {values.mean():.3f}  Std: {values.std():.3f}\")\n\n\n\n","type":"content","url":"/notebooks/nao-index#winter-nao-index-1940-2024","position":11},{"hierarchy":{"lvl1":"Monthly ERA5 Reanalysis","lvl3":"NAO bar chart","lvl2":"Winter NAO Index (1940–2024)"},"type":"lvl3","url":"/notebooks/nao-index#nao-bar-chart","position":12},{"hierarchy":{"lvl1":"Monthly ERA5 Reanalysis","lvl3":"NAO bar chart","lvl2":"Winter NAO Index (1940–2024)"},"content":"\n\n# 9-year centred running mean to show decadal variability\nnao_smooth = nao.rolling(time=9, center=True, min_periods=5).mean().values\n\nbar_colors = np.where(values >= 0, \"crimson\", \"steelblue\")\n\nfig, ax = plt.subplots(figsize=(14, 5))\n\nax.bar(years, values, color=bar_colors, width=0.85, alpha=0.80,\n       label=\"Annual DJF NAO\")\nax.plot(years, nao_smooth, color=\"black\", linewidth=2.0, zorder=3,\n        label=\"9-yr running mean\")\nax.axhline(0, color=\"black\", linewidth=0.8, zorder=4)\n\nax.set_title(\n    \"Winter (DJF) North Atlantic Oscillation Index — ERA5 1940–2024\",\n    fontsize=13, fontweight=\"bold\",\n)\nax.set_ylabel(\"Standardised NAO Index\")\nax.set_xlabel(\"Winter Start Year\")\nax.legend(loc=\"upper right\", framealpha=0.9)\nax.grid(axis=\"y\", alpha=0.3)\n\n# Annotate the reference stations\nstation_text = (\n    \"Azores: Ponta Delgada (37.74°N, 25.67°W)\\n\"\n    \"Iceland: Reykjavik (64.13°N, 21.90°W)\"\n)\nax.text(0.01, 0.03, station_text, transform=ax.transAxes,\n        fontsize=8, color=\"gray\", va=\"bottom\")\n\nfig.tight_layout()\nfig.savefig(paths.images_path / \"15_nao_index.png\", dpi=150, bbox_inches=\"tight\")\nplt.show()\n\n\n\n\n\nFigure 4:Winter (DJF) NAO index derived from ERA5 MSLP, 1940–2024. Red bars indicate\npositive-phase winters (stronger westerlies, milder northern Europe); blue bars\nindicate negative-phase winters (weaker westerlies, cold-air outbreaks). The\nblack line is a 9-year centred running mean highlighting decadal variability.\n\n","type":"content","url":"/notebooks/nao-index#nao-bar-chart","position":13},{"hierarchy":{"lvl1":"Monthly ERA5 Reanalysis","lvl2":"Spatial correlation: NAO vs winter 2 m temperature"},"type":"lvl2","url":"/notebooks/nao-index#spatial-correlation-nao-vs-winter-2-m-temperature","position":14},{"hierarchy":{"lvl1":"Monthly ERA5 Reanalysis","lvl2":"Spatial correlation: NAO vs winter 2 m temperature"},"content":"Each grid point shows the Pearson r between the DJF NAO index and the\nlocal DJF-mean 2 m temperature over 1940–2024.  Red (positive correlation)\nmeans the location warms during NAO+ winters; blue means it cools.\n\nThe canonical NAO fingerprint is visible: warming over northern Europe and\nthe North Atlantic, and cooling over the Mediterranean and parts of\nnorth-eastern North America.\n\nReuses the complete season mask from the NAO section to guarantee\nidentical time axes before calling xr.corr.\n\n# Build DJF mean temperature with the same resampling and completeness filter\nwinter_t2m_means = (\n    ds[\"t2m\"]\n    .sel(time=ds.time.dt.month.isin([12, 1, 2]))\n    .resample(time=\"YS-DEC\")\n    .mean()\n    .sel(time=complete)  # same incomplete-season mask as the NAO index\n)\n\n# Pearson r at every grid point along the shared time dimension\nprint(\"Computing spatial correlation …\")\ncorr_map = xr.corr(nao, winter_t2m_means, dim=\"time\").compute()\nprint(\"Done.\")\n\n\n\n\n\nproj = ccrs.Orthographic(central_longitude=-10, central_latitude=55)\nfig, ax = plt.subplots(figsize=(10, 8), subplot_kw={\"projection\": proj})\n\nax.set_extent([-90, 40, 20, 80], crs=ccrs.PlateCarree())\n\nim = ax.pcolormesh(\n    corr_map.longitude,\n    corr_map.latitude,\n    corr_map.values,\n    transform=ccrs.PlateCarree(),\n    cmap=\"RdBu_r\",\n    vmin=-0.8,\n    vmax=0.8,\n)\n\nax.add_feature(cfeature.COASTLINE, linewidth=0.7)\nax.add_feature(cfeature.BORDERS, linewidth=0.4, linestyle=\":\")\nax.gridlines(linewidth=0.3, color=\"gray\", alpha=0.5)\n\ncbar = fig.colorbar(\n    im, ax=ax, orientation=\"horizontal\", pad=0.04, fraction=0.04, shrink=0.85\n)\ncbar.set_label(\"Pearson r — NAO index vs DJF 2 m temperature\")\n\nax.set_title(\n    \"NAO impact on winter (DJF) 2 m temperature — ERA5 1940–2024\",\n    fontsize=13,\n    fontweight=\"bold\",\n)\n\nfig.tight_layout()\nfig.savefig(\n    paths.images_path / \"15_nao_t2m_correlation.png\", dpi=150, bbox_inches=\"tight\"\n)\nplt.show()\n\n\n\n\n\nFigure 5:Pearson correlation between the DJF NAO index and ERA5 DJF 2 m temperature,\n1940–2024.  Red shading indicates regions that are warmer than average during\nNAO+ winters; blue shading indicates cooler regions.\n\n","type":"content","url":"/notebooks/nao-index#spatial-correlation-nao-vs-winter-2-m-temperature","position":15},{"hierarchy":{"lvl1":"Monthly ERA5 Reanalysis","lvl2":"Germany DJF temperature vs NAO index"},"type":"lvl2","url":"/notebooks/nao-index#germany-djf-temperature-vs-nao-index","position":16},{"hierarchy":{"lvl1":"Monthly ERA5 Reanalysis","lvl2":"Germany DJF temperature vs NAO index"},"content":"Load the Germany spatial-mean 2 m temperature produced by\n16_dev_germany_weather.py, apply the identical YS-DEC resampling used for\nthe NAO index, and scatter the two series against each other.\n\n# Load Germany monthly spatial-mean temperature (mean aggregation, K → °C)\ndf_de = pd.read_parquet(paths.era5_germany_monthly_ts_file)\nt2m_de_monthly = df_de[\"t2m\"] - 273.15  # K → °C\n\n# Filter to DJF and resample with YS-DEC (same convention as NAO index)\nis_djf_de = t2m_de_monthly.index.month.isin([12, 1, 2])\nt2m_de_djf_monthly = t2m_de_monthly[is_djf_de]\nt2m_de_djf = t2m_de_djf_monthly.resample(\"YS-DEC\").mean()\ncounts_de   = t2m_de_djf_monthly.resample(\"YS-DEC\").count()\nt2m_de_djf  = t2m_de_djf[counts_de == 3]\n\n# NAO as a pandas Series indexed by the season's December date (YS-DEC labels)\nnao_series = pd.Series(values, index=pd.DatetimeIndex(nao.time.values))\n\n# Align on the shared index (inner join → only seasons present in both)\ncombined = pd.DataFrame({\"nao\": nao_series, \"t2m_de\": t2m_de_djf}).dropna()\nprint(f\"Aligned seasons: {len(combined)}  \"\n      f\"({combined.index.year[0]}/{combined.index.year[0]+1} – \"\n      f\"{combined.index.year[-1]}/{combined.index.year[-1]+1})\")\n\n# Pearson correlation and OLS trend line\npearson_r = combined[\"nao\"].corr(combined[\"t2m_de\"])\nm_slope, m_intercept = np.polyfit(combined[\"nao\"], combined[\"t2m_de\"], 1)\nprint(f\"Pearson r (NAO vs Germany DJF T2m): {pearson_r:.3f}\")\nprint(f\"OLS slope:                           {m_slope:+.2f} °C per σ of NAO\")\n\nx_fit = np.linspace(combined[\"nao\"].min(), combined[\"nao\"].max(), 100)\n\nfig, ax = plt.subplots(figsize=(7, 6))\n\nsc = ax.scatter(\n    combined[\"nao\"], combined[\"t2m_de\"],\n    c=combined.index.year, cmap=\"plasma\",\n    s=45, alpha=0.85, zorder=3,\n)\nax.plot(x_fit, m_slope * x_fit + m_intercept,\n        color=\"crimson\", linewidth=1.8, zorder=4,\n        label=f\"OLS: {m_slope:+.2f} °C / σ  (r = {pearson_r:.2f})\")\nax.axhline(combined[\"t2m_de\"].mean(), color=\"gray\", linewidth=0.8,\n           linestyle=\"--\", alpha=0.6)\nax.axvline(0, color=\"gray\", linewidth=0.8, linestyle=\"--\", alpha=0.6)\n\ncbar = fig.colorbar(sc, ax=ax, label=\"Winter start year\")\nax.set_xlabel(\"DJF NAO Index (standardised)\")\nax.set_ylabel(\"Germany DJF mean 2 m temperature (°C)\")\nax.set_title(\n    \"Germany winter temperature vs NAO index\\n\"\n    \"ERA5 DJF seasons, 1940–2024\",\n    fontsize=12,\n)\nax.legend(loc=\"upper left\")\nax.grid(linewidth=0.4, alpha=0.5)\nfig.tight_layout()\n\nfig.savefig(paths.images_path / \"15_nao_germany_t2m.png\", dpi=150, bbox_inches=\"tight\")\nplt.show()\n\n\n\n\n\nFigure 6:Scatter plot of Germany DJF mean 2 m temperature against the ERA5-derived\nNAO index, 1940–2024.  Each point is one winter season, coloured by year.\nThe crimson line is an OLS regression; the slope (°C per σ of NAO) quantifies\nhow much Germany warms for each standard-deviation increase in the NAO index.\n\n","type":"content","url":"/notebooks/nao-index#germany-djf-temperature-vs-nao-index","position":17},{"hierarchy":{"lvl1":"Monthly ERA5 Reanalysis","lvl2":"DJF temperature maps — extreme NAO winters"},"type":"lvl2","url":"/notebooks/nao-index#djf-temperature-maps-extreme-nao-winters","position":18},{"hierarchy":{"lvl1":"Monthly ERA5 Reanalysis","lvl2":"DJF temperature maps — extreme NAO winters"},"content":"Full spatial field of ERA5 DJF mean 2 m temperature for the winters with the\nhighest and lowest NAO index in the record (1940–2024).  Uses the same\nwinter_t2m_means DataArray (already filtered to complete DJF seasons) that\nwas used for the NAO computation.\n\nidx_max = int(np.argmax(values))\nidx_min = int(np.argmin(values))\nyear_max, nao_max = years[idx_max], values[idx_max]\nyear_min, nao_min = years[idx_min], values[idx_min]\n\nprint(f\"Max NAO winter: {year_max}/{year_max+1}  NAO = {nao_max:+.2f} σ\")\nprint(f\"Min NAO winter: {year_min}/{year_min+1}  NAO = {nao_min:+.2f} σ\")\n\nt2m_max_field = (winter_t2m_means.sel(time=nao.time[idx_max]) - 273.15).compute()\nt2m_min_field = (winter_t2m_means.sel(time=nao.time[idx_min]) - 273.15).compute()\n\nfig, axes = plt.subplots(\n    1, 2, figsize=(18, 6),\n    subplot_kw={\"projection\": ccrs.Robinson()},\n)\n\nfor ax, t2m, year, nao_val, label in [\n    (axes[0], t2m_max_field, year_max, nao_max, \"Maximum NAO\"),\n    (axes[1], t2m_min_field, year_min, nao_min, \"Minimum NAO\"),\n]:\n    im = ax.pcolormesh(\n        t2m.longitude, t2m.latitude, t2m.values,\n        transform=ccrs.PlateCarree(),\n        cmap=\"RdBu_r\", vmin=-40, vmax=40,\n    )\n    ax.add_feature(cfeature.COASTLINE, linewidth=0.6)\n    ax.add_feature(cfeature.BORDERS, linewidth=0.3, linestyle=\":\")\n    ax.gridlines(linewidth=0.3, color=\"gray\", alpha=0.5)\n    ax.set_title(\n        f\"{label}: {year}/{year+1}  (NAO = {nao_val:+.2f} σ)\",\n        fontsize=12, fontweight=\"bold\",\n    )\n\nfig.colorbar(\n    im, ax=axes, orientation=\"horizontal\", pad=0.04, fraction=0.03,\n    label=\"DJF mean 2 m temperature (°C)\",\n)\nfig.suptitle(\n    \"ERA5 DJF mean 2 m temperature — extreme NAO winters\",\n    fontsize=13, fontweight=\"bold\",\n)\nfig.tight_layout()\nfig.savefig(paths.images_path / \"15_nao_extreme_winters.png\", dpi=150, bbox_inches=\"tight\")\nplt.show()\n\n\n\n\n\nFigure 7:ERA5 DJF mean 2 m temperature for the winter with the highest NAO index\n(left) and lowest NAO index (right) in the 1940–2024 record.  The contrast\nbetween the two panels illustrates the NAO’s influence on winter temperatures\nacross the North Atlantic–European sector.\n\n","type":"content","url":"/notebooks/nao-index#djf-temperature-maps-extreme-nao-winters","position":19},{"hierarchy":{"lvl1":"Monthly ERA5 Reanalysis","lvl2":"Temperature difference: max-NAO minus min-NAO winter"},"type":"lvl2","url":"/notebooks/nao-index#temperature-difference-max-nao-minus-min-nao-winter","position":20},{"hierarchy":{"lvl1":"Monthly ERA5 Reanalysis","lvl2":"Temperature difference: max-NAO minus min-NAO winter"},"content":"\n\nt2m_diff = t2m_max_field - t2m_min_field  # signed: positive = warmer in NAO+ winter\n\nvabs = float(np.abs(t2m_diff.values).max())\n\nfig, ax = plt.subplots(\n    figsize=(14, 7),\n    subplot_kw={\"projection\": ccrs.Robinson()},\n)\n\nim = ax.pcolormesh(\n    t2m_diff.longitude, t2m_diff.latitude, t2m_diff.values,\n    transform=ccrs.PlateCarree(),\n    cmap=\"RdBu_r\", vmin=-vabs, vmax=vabs,\n)\nax.add_feature(cfeature.COASTLINE, linewidth=0.6)\nax.add_feature(cfeature.BORDERS, linewidth=0.3, linestyle=\":\")\nax.gridlines(linewidth=0.3, color=\"gray\", alpha=0.5)\n\ncbar = fig.colorbar(im, ax=ax, orientation=\"horizontal\", pad=0.04, fraction=0.04)\ncbar.set_label(\"Temperature difference (°C)  [max-NAO minus min-NAO]\")\n\nax.set_title(\n    f\"DJF temperature difference: {year_max}/{year_max+1} (NAO={nao_max:+.2f}σ)\"\n    f\"  minus  {year_min}/{year_min+1} (NAO={nao_min:+.2f}σ)\",\n    fontsize=12, fontweight=\"bold\",\n)\nfig.tight_layout()\nfig.savefig(paths.images_path / \"15_nao_extreme_diff.png\", dpi=150, bbox_inches=\"tight\")\nplt.show()\n\n\n\n\n\nFigure 8:Signed temperature difference between the maximum-NAO and minimum-NAO DJF\nseasons in the ERA5 record.  Red indicates regions that were warmer during\nthe NAO+ winter; blue indicates regions that were colder.\n\n","type":"content","url":"/notebooks/nao-index#temperature-difference-max-nao-minus-min-nao-winter","position":21},{"hierarchy":{"lvl1":"Monthly ERA5 Reanalysis","lvl2":"250 hPa wind speed — extreme NAO winters"},"type":"lvl2","url":"/notebooks/nao-index#id-250-hpa-wind-speed-extreme-nao-winters","position":22},{"hierarchy":{"lvl1":"Monthly ERA5 Reanalysis","lvl2":"250 hPa wind speed — extreme NAO winters"},"content":"DJF mean 250 hPa wind speed (jet stream level) for the max-NAO and min-NAO\nwinters.  U and V components are resampled with the same YS-DEC convention\nand completeness mask before computing speed = √(u² + v²).  Wind direction\nis overlaid as thinned quiver arrows.\n\n# Build DJF mean U and V at 250 hPa with the same season mask as the NAO index\ndef _djf_season_mean(da):\n    return (\n        da.sel(time=ds.time.dt.month.isin([12, 1, 2]))\n        .resample(time=\"YS-DEC\")\n        .mean()\n        .sel(time=complete)\n    )\n\nu250 = _djf_season_mean(ds[\"u\"].sel(pressure_level=250))\nv250 = _djf_season_mean(ds[\"v\"].sel(pressure_level=250))\n\n# Select the two extreme seasons and compute wind speed\nu_max = u250.sel(time=nao.time[idx_max]).compute()\nv_max = v250.sel(time=nao.time[idx_max]).compute()\nu_min = u250.sel(time=nao.time[idx_min]).compute()\nv_min = v250.sel(time=nao.time[idx_min]).compute()\n\nwspd_max = np.sqrt(u_max**2 + v_max**2)\nwspd_min = np.sqrt(u_min**2 + v_min**2)\n\nvmax_wspd = float(max(wspd_max.values.max(), wspd_min.values.max()))\n\n# Thin the quiver grid to avoid overplotting (every Nth point)\nN = 6\nlons_q = wspd_max.longitude.values[::N]\nlats_q = wspd_max.latitude.values[::N]\n\nfig, axes = plt.subplots(\n    1, 2, figsize=(18, 6),\n    subplot_kw={\"projection\": ccrs.Robinson()},\n)\n\nfor ax, wspd, u_q, v_q, year, nao_val, label in [\n    (axes[0], wspd_max, u_max.values[::N, ::N], v_max.values[::N, ::N],\n     year_max, nao_max, \"Maximum NAO\"),\n    (axes[1], wspd_min, u_min.values[::N, ::N], v_min.values[::N, ::N],\n     year_min, nao_min, \"Minimum NAO\"),\n]:\n    im = ax.pcolormesh(\n        wspd.longitude, wspd.latitude, wspd.values,\n        transform=ccrs.PlateCarree(),\n        cmap=\"YlOrRd\", vmin=0, vmax=vmax_wspd,\n    )\n    ax.quiver(\n        lons_q, lats_q, u_q, v_q,\n        transform=ccrs.PlateCarree(),\n        scale=2000, width=0.001, color=\"black\", alpha=0.55,\n    )\n    ax.add_feature(cfeature.COASTLINE, linewidth=0.6)\n    ax.add_feature(cfeature.BORDERS, linewidth=0.3, linestyle=\":\")\n    ax.gridlines(linewidth=0.3, color=\"gray\", alpha=0.5)\n    ax.set_title(\n        f\"{label}: {year}/{year+1}  (NAO = {nao_val:+.2f} σ)\",\n        fontsize=12, fontweight=\"bold\",\n    )\n\nfig.colorbar(\n    im, ax=axes, orientation=\"horizontal\", pad=0.04, fraction=0.03,\n    label=\"250 hPa wind speed (m/s)\",\n)\nfig.suptitle(\n    \"ERA5 DJF mean 250 hPa wind speed — extreme NAO winters\",\n    fontsize=13, fontweight=\"bold\",\n)\nfig.tight_layout()\nfig.savefig(paths.images_path / \"15_nao_extreme_250hpa_wind.png\", dpi=150, bbox_inches=\"tight\")\nplt.show()\n\n\n\n\n\nFigure 9:DJF mean 250 hPa wind speed for the maximum-NAO (left) and minimum-NAO\n(right) winters in the ERA5 record.  Colour shows wind speed; arrows show\nwind direction (thinned for clarity).  The NAO+ winter typically shows a\nstronger, more zonally oriented jet stream over the North Atlantic.\n\n","type":"content","url":"/notebooks/nao-index#id-250-hpa-wind-speed-extreme-nao-winters","position":23},{"hierarchy":{"lvl1":"Monthly ERA5 Reanalysis","lvl2":"500 hPa geopotential height — extreme NAO winters"},"type":"lvl2","url":"/notebooks/nao-index#id-500-hpa-geopotential-height-extreme-nao-winters","position":24},{"hierarchy":{"lvl1":"Monthly ERA5 Reanalysis","lvl2":"500 hPa geopotential height — extreme NAO winters"},"content":"DJF mean 500 hPa geopotential height (Z500) for the max-NAO and min-NAO\nwinters.  Geopotential (m²/s²) is converted to geopotential height (m) by\ndividing by g = 9.80665 m/s².  Filled contours show height; contour lines\nhighlight the main ridges and troughs.\n\nG = 9.80665  # standard gravity m/s²\n\nz500_max = (_djf_season_mean(ds[\"z\"].sel(pressure_level=500))\n            .sel(time=nao.time[idx_max]).compute() / G)\nz500_min = (_djf_season_mean(ds[\"z\"].sel(pressure_level=500))\n            .sel(time=nao.time[idx_min]).compute() / G)\n\n# Shared colour scale anchored to the combined range\nvmin_z = float(min(z500_max.values.min(), z500_min.values.min()))\nvmax_z = float(max(z500_max.values.max(), z500_min.values.max()))\n\nfig, axes = plt.subplots(\n    1, 2, figsize=(18, 6),\n    subplot_kw={\"projection\": ccrs.Robinson()},\n)\n\nfor ax, z500, year, nao_val, label in [\n    (axes[0], z500_max, year_max, nao_max, \"Maximum NAO\"),\n    (axes[1], z500_min, year_min, nao_min, \"Minimum NAO\"),\n]:\n    lons = z500.longitude.values\n    lats = z500.latitude.values\n\n    im = ax.pcolormesh(\n        lons, lats, z500.values,\n        transform=ccrs.PlateCarree(),\n        cmap=\"RdBu_r\", vmin=vmin_z, vmax=vmax_z,\n    )\n    # Contour lines every 80 m\n    cs = ax.contour(\n        lons, lats, z500.values,\n        levels=np.arange(np.floor(vmin_z / 80) * 80,\n                         np.ceil(vmax_z / 80) * 80 + 1, 80),\n        colors=\"black\", linewidths=0.6, alpha=0.6,\n        transform=ccrs.PlateCarree(),\n    )\n    ax.clabel(cs, fmt=\"%d\", fontsize=7, inline=True)\n    ax.add_feature(cfeature.COASTLINE, linewidth=0.6)\n    ax.add_feature(cfeature.BORDERS, linewidth=0.3, linestyle=\":\")\n    ax.gridlines(linewidth=0.3, color=\"gray\", alpha=0.5)\n\n    # NAO station markers\n    for (lon, lat, name) in [\n        (-25.67, 37.74, \"Azores\"),\n        (-21.90, 64.13, \"Iceland\"),\n    ]:\n        ax.plot(lon, lat, transform=ccrs.PlateCarree(),\n                marker=\"*\", markersize=10, color=\"gold\",\n                markeredgecolor=\"black\", markeredgewidth=0.6, zorder=5)\n        ax.text(lon + 1.5, lat, name, transform=ccrs.PlateCarree(),\n                fontsize=8, fontweight=\"bold\", color=\"black\",\n                va=\"center\", zorder=5)\n\n    ax.set_title(\n        f\"{label}: {year}/{year+1}  (NAO = {nao_val:+.2f} σ)\",\n        fontsize=12, fontweight=\"bold\",\n    )\n\nfig.colorbar(\n    im, ax=axes, orientation=\"horizontal\", pad=0.04, fraction=0.03,\n    label=\"500 hPa geopotential height (m)\",\n)\nfig.suptitle(\n    \"ERA5 DJF mean 500 hPa geopotential height — extreme NAO winters\",\n    fontsize=13, fontweight=\"bold\",\n)\nfig.tight_layout()\nfig.savefig(paths.images_path / \"15_nao_extreme_z500.png\", dpi=150, bbox_inches=\"tight\")\nplt.show()\n\n\n\n\n\nFigure 10:DJF mean 500 hPa geopotential height for the maximum-NAO (left) and\nminimum-NAO (right) winters.  Contour lines are drawn every 80 m.  The\nNAO+ pattern shows higher geopotential over the Azores and lower over\nIceland, steering mild Atlantic air into Europe; NAO− reverses this,\nfavouring blocking and cold-air advection.","type":"content","url":"/notebooks/nao-index#id-500-hpa-geopotential-height-extreme-nao-winters","position":25},{"hierarchy":{"lvl1":"NAO and Jet Stream — Daily Evolution"},"type":"lvl1","url":"/notebooks/daily-jet-stream-animations","position":0},{"hierarchy":{"lvl1":"NAO and Jet Stream — Daily Evolution"},"content":"The North Atlantic Oscillation (NAO) is the leading mode of atmospheric\nvariability over the North Atlantic.  Its sign determines whether the\nmid-latitude jet stream is amplified and tracking north-east into Europe\n(NAO+) or weakened and shifted south, with Rossby-wave ridges blocking the\nwesterly flow (NAO−).\n\nThis chapter animates two contrasting DJF (December–February) winters:\n\nPeriod\n\nNAO phase\n\nCharacter\n\n2014–2015\n\nStrong NAO+\n\nMild, stormy, vigorous westerlies over Europe\n\n2009–2010\n\nStrong NAO−\n\nCold, blocked, persistent high-pressure over Europe\n\nEach animation frame shows:\n\nZ500 geopotential height (500 hPa) as labelled contour lines — ridges\n(high Z500) and troughs (low Z500) reveal the large-scale wave pattern.\n\nJet stream (250 hPa wind speed ≥ 30 m/s) filled in purple — the\ncore of the upper-tropospheric westerly flow.\n\nData source: ERA5 reanalysis downloaded from ARCO-ERA5 (Google Cloud),\ndaily at 12:00 UTC.\n\nimport io\n\nimport numpy as np\nimport xarray as xr\nimport matplotlib.pyplot as plt\nimport matplotlib.patches as mpatches\nimport cartopy.crs as ccrs\nimport cartopy.feature as cfeature\nfrom PIL import Image\n\nfrom woe.paths import ProjPaths\n\npaths = ProjPaths()\n\n\n\n","type":"content","url":"/notebooks/daily-jet-stream-animations","position":1},{"hierarchy":{"lvl1":"NAO and Jet Stream — Daily Evolution","lvl2":"Parameters"},"type":"lvl2","url":"/notebooks/daily-jet-stream-animations#parameters","position":2},{"hierarchy":{"lvl1":"NAO and Jet Stream — Daily Evolution","lvl2":"Parameters"},"content":"\n\nG = 9.80665            # standard gravity (m/s²)\nJET_THRESHOLD = 30     # m/s — standard meteorological jet-stream criterion\nGIF_DURATION_MS = 300  # milliseconds per frame\n\n# North Atlantic / Europe domain\nEXTENT = [-90, 40, 20, 80]   # [lon_min, lon_max, lat_min, lat_max] in PlateCarree\n\n# Lambert Conformal is the standard operational projection for North Atlantic\n# synoptic charts: it preserves angles, has low distortion in the mid-latitudes,\n# and gives the familiar \"tilted\" view that meteorologists expect.\nPROJ = ccrs.LambertConformal(\n    central_longitude=-20,\n    central_latitude=55,\n    standard_parallels=(35, 65),\n)\n\nPERIODS = [\"2014-2015\", \"2009-2010\"]\n\n\n\n","type":"content","url":"/notebooks/daily-jet-stream-animations#parameters","position":3},{"hierarchy":{"lvl1":"NAO and Jet Stream — Daily Evolution","lvl2":"2m temperature and Z500 — surface air mass perspective"},"type":"lvl2","url":"/notebooks/daily-jet-stream-animations#id-2m-temperature-and-z500-surface-air-mass-perspective","position":4},{"hierarchy":{"lvl1":"NAO and Jet Stream — Daily Evolution","lvl2":"2m temperature and Z500 — surface air mass perspective"},"content":"The first set of animations shows 2m temperature as a filled colour field\nwith 500 hPa geopotential height (Z500) as labelled contour lines on top.\nThis combination is the classic synoptic-meteorology view of the lower\ntroposphere: the temperature field reveals where cold polar air has invaded\nand where warm maritime air is advected, while the Z500 contours show the\nsteering-level ridge/trough pattern that drives that advection.\n\ndef render_frame_t2m_z500(\n    lats: np.ndarray,\n    lons: np.ndarray,\n    t2m_celsius: np.ndarray,\n    gph500: np.ndarray,\n    date_str: str,\n    period_name: str,\n) -> Image.Image:\n    \"\"\"Render a 2m-temperature + Z500-contour frame and return a PIL Image.\n\n    Parameters\n    ----------\n    lats, lons    : coordinate arrays (1-D)\n    t2m_celsius   : 2m temperature in °C, shape (lat, lon)\n    gph500        : 500 hPa geopotential height in metres, shape (lat, lon)\n    date_str      : ISO date string for the title, e.g. \"2014-12-01\"\n    period_name   : e.g. \"2014-2015\"\n    \"\"\"\n    fig = plt.figure(figsize=(12, 8))\n    ax = fig.add_subplot(1, 1, 1, projection=PROJ)\n\n    # --- Background: 2m temperature ---\n    # Winter range over the Atlantic–Europe domain: roughly −30 to +20 °C\n    im = ax.pcolormesh(\n        lons, lats, t2m_celsius,\n        cmap=\"RdBu_r\",\n        vmin=-30, vmax=20,\n        transform=ccrs.PlateCarree(),\n        shading=\"auto\",\n        zorder=1,\n    )\n\n    # --- Z500 contour lines ---\n    z500_levels = np.arange(4800, 6001, 60)\n    cs = ax.contour(\n        lons, lats, gph500,\n        levels=z500_levels,\n        colors=\"black\",\n        linewidths=0.6,\n        transform=ccrs.PlateCarree(),\n        zorder=3,\n    )\n    ax.clabel(cs, fmt=\"%d m\", fontsize=6, inline=True, inline_spacing=3)\n\n    # --- Political geography ---\n    ax.add_feature(cfeature.COASTLINE, linewidth=0.7, color=\"0.15\", zorder=4)\n    ax.add_feature(cfeature.BORDERS, linewidth=0.4, linestyle=\"--\",\n                   color=\"0.35\", zorder=4)\n\n    ax.set_extent(EXTENT, crs=ccrs.PlateCarree())\n\n    # --- Gridlines ---\n    gl = ax.gridlines(\n        crs=ccrs.PlateCarree(),\n        draw_labels=True,\n        linewidth=0.3,\n        color=\"gray\",\n        alpha=0.5,\n        linestyle=\":\",\n    )\n    gl.top_labels = False\n    gl.right_labels = False\n    gl.xlabel_style = {\"size\": 8}\n    gl.ylabel_style = {\"size\": 8}\n\n    # --- Colorbar ---\n    cbar = fig.colorbar(im, ax=ax, orientation=\"vertical\", pad=0.02,\n                        fraction=0.03, aspect=30, shrink=0.85)\n    cbar.set_label(\"2m temperature (°C)\", fontsize=9)\n    cbar.ax.tick_params(labelsize=8)\n\n    ax.set_title(\n        f\"2m temperature (colour) + Z500 geopotential height (contours, m)\\n\"\n        f\"{date_str} 12:00 UTC  |  ERA5  |  Winter {period_name}\",\n        fontsize=11, pad=8,\n    )\n\n    buf = io.BytesIO()\n    fig.savefig(buf, format=\"png\", dpi=100, bbox_inches=\"tight\")\n    plt.close(fig)\n    buf.seek(0)\n    return Image.open(buf).copy()\n\n\n\n","type":"content","url":"/notebooks/daily-jet-stream-animations#id-2m-temperature-and-z500-surface-air-mass-perspective","position":5},{"hierarchy":{"lvl1":"NAO and Jet Stream — Daily Evolution","lvl3":"Generate T2m + Z500 animations","lvl2":"2m temperature and Z500 — surface air mass perspective"},"type":"lvl3","url":"/notebooks/daily-jet-stream-animations#generate-t2m-z500-animations","position":6},{"hierarchy":{"lvl1":"NAO and Jet Stream — Daily Evolution","lvl3":"Generate T2m + Z500 animations","lvl2":"2m temperature and Z500 — surface air mass perspective"},"content":"\n\nfor period_name in PERIODS:\n    data_file = paths.era5_nao_jetstream_path / f\"era5_nao_jetstream_{period_name}.nc\"\n    gif_file = paths.images_path / f\"18_t2m_z500_{period_name}.gif\"\n\n    print(f\"[{period_name}] Loading {data_file.name} ...\")\n    ds = xr.open_dataset(data_file)\n    lats = ds.latitude.values\n    lons = ds.longitude.values\n    n = len(ds.time)\n\n    frames = []\n    for i, t in enumerate(ds.time.values):\n        date_str = str(t)[:10]\n        gph500 = ds[\"geopotential\"].sel(time=t).values / G\n        t2m_celsius = ds[\"2m_temperature\"].sel(time=t).values - 273.15\n\n        frame = render_frame_t2m_z500(lats, lons, t2m_celsius, gph500,\n                                      date_str, period_name)\n        frames.append(frame)\n        print(f\"  frame {i + 1:3d}/{n}  {date_str}\", end=\"\\r\")\n\n    frames[0].save(\n        gif_file,\n        save_all=True,\n        append_images=frames[1:],\n        duration=GIF_DURATION_MS,\n        loop=0,\n    )\n    print(f\"\\n[{period_name}] Saved: {gif_file.name}  ({n} frames)\")\n    ds.close()\n\n\n\n","type":"content","url":"/notebooks/daily-jet-stream-animations#generate-t2m-z500-animations","position":7},{"hierarchy":{"lvl1":"NAO and Jet Stream — Daily Evolution","lvl4":"NAO+ winter 2014–2015 — temperature and Z500","lvl3":"Generate T2m + Z500 animations","lvl2":"2m temperature and Z500 — surface air mass perspective"},"type":"lvl4","url":"/notebooks/daily-jet-stream-animations#nao-winter-2014-2015-temperature-and-z500","position":8},{"hierarchy":{"lvl1":"NAO and Jet Stream — Daily Evolution","lvl4":"NAO+ winter 2014–2015 — temperature and Z500","lvl3":"Generate T2m + Z500 animations","lvl2":"2m temperature and Z500 — surface air mass perspective"},"content":"\n\nFigure 1:Daily 2m temperature (colour, °C) and 500 hPa geopotential height (contour\nlines, m) during the NAO+ winter of December 2014 – February 2015.  The\ntightly packed Z500 contours over the North Atlantic reflect the strong\nwesterly pressure gradient; mild maritime air (red/orange) is advected\npersistently into western and central Europe.  ERA5 reanalysis, 12:00 UTC.\n\n","type":"content","url":"/notebooks/daily-jet-stream-animations#nao-winter-2014-2015-temperature-and-z500","position":9},{"hierarchy":{"lvl1":"NAO and Jet Stream — Daily Evolution","lvl4":"NAO− winter 2009–2010 — temperature and Z500","lvl3":"Generate T2m + Z500 animations","lvl2":"2m temperature and Z500 — surface air mass perspective"},"type":"lvl4","url":"/notebooks/daily-jet-stream-animations#nao-winter-2009-2010-temperature-and-z500","position":10},{"hierarchy":{"lvl1":"NAO and Jet Stream — Daily Evolution","lvl4":"NAO− winter 2009–2010 — temperature and Z500","lvl3":"Generate T2m + Z500 animations","lvl2":"2m temperature and Z500 — surface air mass perspective"},"content":"\n\nFigure 2:Daily 2m temperature (colour, °C) and 500 hPa geopotential height (contour\nlines, m) during the NAO− winter of December 2009 – February 2010.  A\npersistent Z500 ridge over Greenland and Scandinavia (widely spaced, elevated\ncontours) channels cold Arctic air (blue) southward over the European\ncontinent.  ERA5 reanalysis, 12:00 UTC.\n\n","type":"content","url":"/notebooks/daily-jet-stream-animations#nao-winter-2009-2010-temperature-and-z500","position":11},{"hierarchy":{"lvl1":"NAO and Jet Stream — Daily Evolution","lvl2":"Jet stream — upper-tropospheric flow"},"type":"lvl2","url":"/notebooks/daily-jet-stream-animations#jet-stream-upper-tropospheric-flow","position":12},{"hierarchy":{"lvl1":"NAO and Jet Stream — Daily Evolution","lvl2":"Jet stream — upper-tropospheric flow"},"content":"The second set of animations focuses on the jet stream at 250 hPa,\nthe level where upper-tropospheric winds are strongest.  The jet stream\nposition and strength are tightly coupled to the Z500 pattern above: in NAO+\nwinters it flows vigorously north-eastward across the Atlantic; in NAO−\nwinters it weakens or splits, allowing persistent blocking.\n\n","type":"content","url":"/notebooks/daily-jet-stream-animations#jet-stream-upper-tropospheric-flow","position":13},{"hierarchy":{"lvl1":"NAO and Jet Stream — Daily Evolution","lvl2":"Helper — render one synoptic frame"},"type":"lvl2","url":"/notebooks/daily-jet-stream-animations#helper-render-one-synoptic-frame","position":14},{"hierarchy":{"lvl1":"NAO and Jet Stream — Daily Evolution","lvl2":"Helper — render one synoptic frame"},"content":"\n\ndef render_frame(\n    lats: np.ndarray,\n    lons: np.ndarray,\n    gph500: np.ndarray,\n    wspd250: np.ndarray,\n    date_str: str,\n    period_name: str,\n) -> Image.Image:\n    \"\"\"Render a single synoptic map frame and return a PIL Image.\n\n    Parameters\n    ----------\n    lats, lons : coordinate arrays (1-D)\n    gph500     : 500 hPa geopotential height in metres, shape (lat, lon)\n    wspd250    : 250 hPa wind speed in m/s, shape (lat, lon)\n    date_str   : ISO date string for the title, e.g. \"2014-12-01\"\n    period_name: e.g. \"2014-2015\"\n    \"\"\"\n    fig = plt.figure(figsize=(12, 8))\n    ax = fig.add_subplot(1, 1, 1, projection=PROJ)\n\n    # --- Background: land and ocean colours ---\n    ax.add_feature(cfeature.OCEAN, facecolor=\"#d0e8f5\", zorder=0)\n    ax.add_feature(cfeature.LAND, facecolor=\"#f0ede8\", zorder=0)\n\n    # --- Z500 contour lines ---\n    # Typical mid-latitude winter range: ~4 900 – 5 900 m; 60 m interval\n    z500_levels = np.arange(4800, 6001, 60)\n    cs = ax.contour(\n        lons, lats, gph500,\n        levels=z500_levels,\n        colors=\"black\",\n        linewidths=0.6,\n        transform=ccrs.PlateCarree(),\n        zorder=3,\n    )\n    ax.clabel(cs, fmt=\"%d m\", fontsize=6, inline=True, inline_spacing=3)\n\n    # --- Jet stream: filled purple above threshold ---\n    jet_speed_masked = np.where(wspd250 >= JET_THRESHOLD, wspd250, np.nan)\n    ax.contourf(\n        lons, lats, jet_speed_masked,\n        levels=[JET_THRESHOLD, 300],\n        colors=[\"mediumpurple\"],\n        alpha=0.75,\n        transform=ccrs.PlateCarree(),\n        zorder=4,\n    )\n    # Crisp boundary at the jet threshold\n    ax.contour(\n        lons, lats, wspd250,\n        levels=[JET_THRESHOLD],\n        colors=[\"rebeccapurple\"],\n        linewidths=1.0,\n        transform=ccrs.PlateCarree(),\n        zorder=5,\n    )\n\n    # --- Political geography ---\n    ax.add_feature(cfeature.COASTLINE, linewidth=0.7, color=\"black\", zorder=6)\n    ax.add_feature(cfeature.BORDERS, linewidth=0.4, linestyle=\"--\",\n                   color=\"0.35\", zorder=6)\n\n    ax.set_extent(EXTENT, crs=ccrs.PlateCarree())\n\n    # --- Gridlines ---\n    gl = ax.gridlines(\n        crs=ccrs.PlateCarree(),\n        draw_labels=True,\n        linewidth=0.3,\n        color=\"gray\",\n        alpha=0.5,\n        linestyle=\":\",\n    )\n    gl.top_labels = False\n    gl.right_labels = False\n    gl.xlabel_style = {\"size\": 8}\n    gl.ylabel_style = {\"size\": 8}\n\n    # --- Legend ---\n    legend_elements = [\n        mpatches.Patch(\n            facecolor=\"mediumpurple\", edgecolor=\"rebeccapurple\",\n            alpha=0.75, label=f\"Jet stream ≥ {JET_THRESHOLD} m/s  (250 hPa)\",\n        ),\n    ]\n    ax.legend(handles=legend_elements, loc=\"lower left\", fontsize=9,\n              framealpha=0.85)\n\n    ax.set_title(\n        f\"Z500 geopotential height (contours, m) + Jet stream (purple)\\n\"\n        f\"{date_str} 12:00 UTC  |  ERA5  |  Winter {period_name}\",\n        fontsize=11, pad=8,\n    )\n\n    buf = io.BytesIO()\n    fig.savefig(buf, format=\"png\", dpi=100, bbox_inches=\"tight\")\n    plt.close(fig)\n    buf.seek(0)\n    return Image.open(buf).copy()\n\n\n\n","type":"content","url":"/notebooks/daily-jet-stream-animations#helper-render-one-synoptic-frame","position":15},{"hierarchy":{"lvl1":"NAO and Jet Stream — Daily Evolution","lvl2":"Generate animations — one GIF per winter period"},"type":"lvl2","url":"/notebooks/daily-jet-stream-animations#generate-animations-one-gif-per-winter-period","position":16},{"hierarchy":{"lvl1":"NAO and Jet Stream — Daily Evolution","lvl2":"Generate animations — one GIF per winter period"},"content":"\n\nfor period_name in PERIODS:\n    data_file = paths.era5_nao_jetstream_path / f\"era5_nao_jetstream_{period_name}.nc\"\n    gif_file = paths.images_path / f\"18_nao_jet_stream_{period_name}.gif\"\n\n    print(f\"[{period_name}] Loading {data_file.name} ...\")\n    ds = xr.open_dataset(data_file)\n    lats = ds.latitude.values\n    lons = ds.longitude.values\n    n = len(ds.time)\n    print(f\"  {n} timesteps, lat {lats[0]:.1f}–{lats[-1]:.1f}, \"\n          f\"lon {lons[0]:.1f}–{lons[-1]:.1f}\")\n\n    frames = []\n    for i, t in enumerate(ds.time.values):\n        date_str = str(t)[:10]\n\n        # Z500 geopotential height (m): convert J/kg → m\n        gph500 = ds[\"geopotential\"].sel(time=t).values / G\n\n        # 250 hPa wind speed\n        u250 = ds[\"u_component_of_wind\"].sel(time=t).values\n        v250 = ds[\"v_component_of_wind\"].sel(time=t).values\n        wspd250 = np.sqrt(u250 ** 2 + v250 ** 2)\n\n        frame = render_frame(lats, lons, gph500, wspd250, date_str, period_name)\n        frames.append(frame)\n        print(f\"  frame {i + 1:3d}/{n}  {date_str}\", end=\"\\r\")\n\n    frames[0].save(\n        gif_file,\n        save_all=True,\n        append_images=frames[1:],\n        duration=GIF_DURATION_MS,\n        loop=0,\n    )\n    print(f\"\\n[{period_name}] Saved: {gif_file.name}  ({n} frames)\")\n    ds.close()\n\n\n\n","type":"content","url":"/notebooks/daily-jet-stream-animations#generate-animations-one-gif-per-winter-period","position":17},{"hierarchy":{"lvl1":"NAO and Jet Stream — Daily Evolution","lvl2":"NAO+ winter: 2014–2015"},"type":"lvl2","url":"/notebooks/daily-jet-stream-animations#nao-winter-2014-2015","position":18},{"hierarchy":{"lvl1":"NAO and Jet Stream — Daily Evolution","lvl2":"NAO+ winter: 2014–2015"},"content":"The 2014–2015 winter was dominated by a strongly positive NAO.  Persistent\nwesterly flow channelled a procession of Atlantic depressions into western\nand central Europe, bringing above-average temperatures and above-average\nstorm activity.  The animation shows a tight, zonally oriented jet stream\ntracking north-eastward across the Atlantic into the British Isles and\nScandinavia, with Z500 contours packed closely together — indicating a\nstrong meridional pressure gradient.\n\n\n\nFigure 3:Daily evolution of Z500 geopotential height (contour lines, m) and the\n250 hPa jet stream core (purple, ≥ 30 m/s) during the NAO+ winter of\nDecember 2014 – February 2015.  ERA5 reanalysis, 12:00 UTC each day.\n\n","type":"content","url":"/notebooks/daily-jet-stream-animations#nao-winter-2014-2015","position":19},{"hierarchy":{"lvl1":"NAO and Jet Stream — Daily Evolution","lvl2":"NAO− winter: 2009–2010"},"type":"lvl2","url":"/notebooks/daily-jet-stream-animations#nao-winter-2009-2010","position":20},{"hierarchy":{"lvl1":"NAO and Jet Stream — Daily Evolution","lvl2":"NAO− winter: 2009–2010"},"content":"The 2009–2010 winter was one of the strongest NAO− episodes in recent\ndecades.  A persistent blocking anticyclone over Greenland and Scandinavia\ndeflected the jet stream southward, cutting off the supply of mild maritime\nair to central Europe.  Much of the continent experienced a prolonged cold\nspell with temperatures several degrees below the seasonal norm.  The\nanimation shows a split or southward-displaced jet, with high Z500 ridges\nanchored over northern Europe — the hallmark of an atmospheric blocking\npattern.\n\n\n\nFigure 4:Daily evolution of Z500 geopotential height (contour lines, m) and the\n250 hPa jet stream core (purple, ≥ 30 m/s) during the NAO− winter of\nDecember 2009 – February 2010.  ERA5 reanalysis, 12:00 UTC each day.\n\n","type":"content","url":"/notebooks/daily-jet-stream-animations#nao-winter-2009-2010","position":21},{"hierarchy":{"lvl1":"NAO and Jet Stream — Daily Evolution","lvl2":"Combined view — jet stream and temperature side by side"},"type":"lvl2","url":"/notebooks/daily-jet-stream-animations#combined-view-jet-stream-and-temperature-side-by-side","position":22},{"hierarchy":{"lvl1":"NAO and Jet Stream — Daily Evolution","lvl2":"Combined view — jet stream and temperature side by side"},"content":"The combined animation places both perspectives in a single frame:\nthe left panel shows Z500 contours with the jet stream (purple) and\nthe right panel shows the same Z500 contours over 2m temperature.\nSeeing them together makes it easier to trace how the upper-level wave\npattern simultaneously positions the jet and controls cold/warm air advection\nat the surface.\n\ndef render_frame_combined(\n    lats: np.ndarray,\n    lons: np.ndarray,\n    gph500: np.ndarray,\n    wspd250: np.ndarray,\n    t2m_celsius: np.ndarray,\n    date_str: str,\n    period_name: str,\n) -> Image.Image:\n    \"\"\"Two-panel frame: left Z500+jet, right Z500+T2m. Returns a PIL Image.\"\"\"\n    fig = plt.figure(figsize=(22, 9))\n    ax_jet = fig.add_subplot(1, 2, 1, projection=PROJ)\n    ax_t2m = fig.add_subplot(1, 2, 2, projection=PROJ)\n\n    z500_levels = np.arange(4800, 6001, 60)\n\n    # ---- Left panel: Z500 + jet stream ----\n    ax_jet.add_feature(cfeature.OCEAN, facecolor=\"#d0e8f5\", zorder=0)\n    ax_jet.add_feature(cfeature.LAND, facecolor=\"#f0ede8\", zorder=0)\n\n    cs_jet = ax_jet.contour(\n        lons, lats, gph500,\n        levels=z500_levels, colors=\"black\", linewidths=0.6,\n        transform=ccrs.PlateCarree(), zorder=3,\n    )\n    ax_jet.clabel(cs_jet, fmt=\"%d m\", fontsize=5, inline=True, inline_spacing=2)\n\n    jet_masked = np.where(wspd250 >= JET_THRESHOLD, wspd250, np.nan)\n    ax_jet.contourf(\n        lons, lats, jet_masked,\n        levels=[JET_THRESHOLD, 300], colors=[\"mediumpurple\"], alpha=0.75,\n        transform=ccrs.PlateCarree(), zorder=4,\n    )\n    ax_jet.contour(\n        lons, lats, wspd250,\n        levels=[JET_THRESHOLD], colors=[\"rebeccapurple\"], linewidths=1.0,\n        transform=ccrs.PlateCarree(), zorder=5,\n    )\n\n    ax_jet.add_feature(cfeature.COASTLINE, linewidth=0.6, color=\"black\", zorder=6)\n    ax_jet.add_feature(cfeature.BORDERS, linewidth=0.35, linestyle=\"--\",\n                       color=\"0.35\", zorder=6)\n    ax_jet.set_extent(EXTENT, crs=ccrs.PlateCarree())\n\n    gl_jet = ax_jet.gridlines(crs=ccrs.PlateCarree(), draw_labels=True,\n                               linewidth=0.3, color=\"gray\", alpha=0.5, linestyle=\":\")\n    gl_jet.top_labels = False\n    gl_jet.right_labels = False\n    gl_jet.xlabel_style = {\"size\": 7}\n    gl_jet.ylabel_style = {\"size\": 7}\n\n    ax_jet.legend(\n        handles=[mpatches.Patch(facecolor=\"mediumpurple\", edgecolor=\"rebeccapurple\",\n                                alpha=0.75, label=f\"Jet ≥ {JET_THRESHOLD} m/s (250 hPa)\")],\n        loc=\"lower left\", fontsize=8, framealpha=0.85,\n    )\n    ax_jet.set_title(\"Z500 (contours) + Jet stream (purple)\", fontsize=10, pad=6)\n\n    # ---- Right panel: Z500 + 2m temperature ----\n    im = ax_t2m.pcolormesh(\n        lons, lats, t2m_celsius,\n        cmap=\"RdBu_r\", vmin=-30, vmax=20,\n        transform=ccrs.PlateCarree(), shading=\"auto\", zorder=1,\n    )\n\n    cs_t2m = ax_t2m.contour(\n        lons, lats, gph500,\n        levels=z500_levels, colors=\"black\", linewidths=0.6,\n        transform=ccrs.PlateCarree(), zorder=3,\n    )\n    ax_t2m.clabel(cs_t2m, fmt=\"%d m\", fontsize=5, inline=True, inline_spacing=2)\n\n    ax_t2m.add_feature(cfeature.COASTLINE, linewidth=0.6, color=\"0.15\", zorder=4)\n    ax_t2m.add_feature(cfeature.BORDERS, linewidth=0.35, linestyle=\"--\",\n                       color=\"0.35\", zorder=4)\n    ax_t2m.set_extent(EXTENT, crs=ccrs.PlateCarree())\n\n    gl_t2m = ax_t2m.gridlines(crs=ccrs.PlateCarree(), draw_labels=True,\n                               linewidth=0.3, color=\"gray\", alpha=0.5, linestyle=\":\")\n    gl_t2m.top_labels = False\n    gl_t2m.left_labels = False\n    gl_t2m.xlabel_style = {\"size\": 7}\n    gl_t2m.ylabel_style = {\"size\": 7}\n\n    cbar = fig.colorbar(im, ax=ax_t2m, orientation=\"vertical\",\n                        pad=0.04, fraction=0.025, aspect=35, shrink=0.9)\n    cbar.set_label(\"2m temperature (°C)\", fontsize=8)\n    cbar.ax.tick_params(labelsize=7)\n\n    ax_t2m.set_title(\"Z500 (contours) + 2m temperature\", fontsize=10, pad=6)\n\n    fig.suptitle(\n        f\"{date_str} 12:00 UTC  |  ERA5 reanalysis  |  Winter {period_name}\",\n        fontsize=12, y=1.01,\n    )\n    fig.tight_layout()\n\n    buf = io.BytesIO()\n    fig.savefig(buf, format=\"png\", dpi=100, bbox_inches=\"tight\")\n    plt.close(fig)\n    buf.seek(0)\n    return Image.open(buf).copy()\n\n\n\n","type":"content","url":"/notebooks/daily-jet-stream-animations#combined-view-jet-stream-and-temperature-side-by-side","position":23},{"hierarchy":{"lvl1":"NAO and Jet Stream — Daily Evolution","lvl3":"Generate combined animations","lvl2":"Combined view — jet stream and temperature side by side"},"type":"lvl3","url":"/notebooks/daily-jet-stream-animations#generate-combined-animations","position":24},{"hierarchy":{"lvl1":"NAO and Jet Stream — Daily Evolution","lvl3":"Generate combined animations","lvl2":"Combined view — jet stream and temperature side by side"},"content":"\n\nfor period_name in PERIODS:\n    data_file = paths.era5_nao_jetstream_path / f\"era5_nao_jetstream_{period_name}.nc\"\n    gif_file = paths.images_path / f\"18_combined_{period_name}.gif\"\n\n    print(f\"[{period_name}] Loading {data_file.name} ...\")\n    ds = xr.open_dataset(data_file)\n    lats = ds.latitude.values\n    lons = ds.longitude.values\n    n = len(ds.time)\n\n    frames = []\n    for i, t in enumerate(ds.time.values):\n        date_str = str(t)[:10]\n\n        gph500 = ds[\"geopotential\"].sel(time=t).values / G\n        u250 = ds[\"u_component_of_wind\"].sel(time=t).values\n        v250 = ds[\"v_component_of_wind\"].sel(time=t).values\n        wspd250 = np.sqrt(u250 ** 2 + v250 ** 2)\n        t2m_celsius = ds[\"2m_temperature\"].sel(time=t).values - 273.15\n\n        frame = render_frame_combined(lats, lons, gph500, wspd250, t2m_celsius,\n                                      date_str, period_name)\n        frames.append(frame)\n        print(f\"  frame {i + 1:3d}/{n}  {date_str}\", end=\"\\r\")\n\n    frames[0].save(\n        gif_file,\n        save_all=True,\n        append_images=frames[1:],\n        duration=GIF_DURATION_MS,\n        loop=0,\n    )\n    print(f\"\\n[{period_name}] Saved: {gif_file.name}  ({n} frames)\")\n    ds.close()\n\n\n\n","type":"content","url":"/notebooks/daily-jet-stream-animations#generate-combined-animations","position":25},{"hierarchy":{"lvl1":"NAO and Jet Stream — Daily Evolution","lvl3":"NAO+ winter 2014–2015 — combined view","lvl2":"Combined view — jet stream and temperature side by side"},"type":"lvl3","url":"/notebooks/daily-jet-stream-animations#nao-winter-2014-2015-combined-view","position":26},{"hierarchy":{"lvl1":"NAO and Jet Stream — Daily Evolution","lvl3":"NAO+ winter 2014–2015 — combined view","lvl2":"Combined view — jet stream and temperature side by side"},"content":"\n\nFigure 5:Side-by-side daily animation for the NAO+ winter of December 2014 –\nFebruary 2015.  Left: Z500 geopotential height (contour lines, m) with the\n250 hPa jet stream core (purple, ≥ 30 m/s).  Right: same Z500 contours\nover 2m temperature (°C).  ERA5 reanalysis, 12:00 UTC each day.\n\n","type":"content","url":"/notebooks/daily-jet-stream-animations#nao-winter-2014-2015-combined-view","position":27},{"hierarchy":{"lvl1":"NAO and Jet Stream — Daily Evolution","lvl3":"NAO− winter 2009–2010 — combined view","lvl2":"Combined view — jet stream and temperature side by side"},"type":"lvl3","url":"/notebooks/daily-jet-stream-animations#nao-winter-2009-2010-combined-view","position":28},{"hierarchy":{"lvl1":"NAO and Jet Stream — Daily Evolution","lvl3":"NAO− winter 2009–2010 — combined view","lvl2":"Combined view — jet stream and temperature side by side"},"content":"\n\nFigure 6:Side-by-side daily animation for the NAO− winter of December 2009 –\nFebruary 2010.  Left: Z500 geopotential height (contour lines, m) with the\n250 hPa jet stream core (purple, ≥ 30 m/s).  Right: same Z500 contours\nover 2m temperature (°C).  ERA5 reanalysis, 12:00 UTC each day.","type":"content","url":"/notebooks/daily-jet-stream-animations#nao-winter-2009-2010-combined-view","position":29}]}